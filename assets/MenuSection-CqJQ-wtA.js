const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CartItemCardSkeleton-CfSShoZX.js","assets/index-CazEC9O8.js","assets/index-QHSbNduV.css","assets/MenuItemCard-DkWCDaW-.js","assets/blur-CCIUzi2V.js","assets/blur-DOfe2hmq.css","assets/index-C0eentFS.js","assets/Menu-ConjJVLd.js","assets/sidebarStore-ofV2gSx_.js","assets/Header-C9tElt5A.js","assets/NavbarSkeleton-B3vuu2_-.js","assets/MenuSectionSkeleton-DSICu3NP.js","assets/useCategoryQueries-CxrGPQ9r.js","assets/merchantMenuNav-D01IUs1d.js","assets/faEllipsis-CxEkbWIP.js","assets/useImageUploadMutation-CIkgEjlR.js","assets/useMutation-BafpkvH0.js"])))=>i.map(i=>d[i]);
import{e as Q,a as v,A as C,b,u as w,r as y,P as m,j as p,_ as M}from"./index-CazEC9O8.js";import{u as D}from"./useMutation-BafpkvH0.js";/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _=Q("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const j=Q("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),P=async(s,r,t,d)=>{const u=v.get("authToken");try{return(await C.patch(`/v2/menu/${s}/dishes`,{categoryName:t},{params:{category:r},signal:d,headers:{Authorization:`Bearer ${u}`}})).data}catch(l){if(b.isCancel(l)){console.debug("Update category name request cancelled");return}throw console.error(`Failed to update category name from ${r} to ${t}:`,l),l}},N=s=>{const r=w(),t=y.useRef(null),{mutateAsync:d,isError:u,isPending:l}=D({mutationFn:async({oldCategoryName:n,newCategoryName:i})=>{t.current&&t.current.abort();const e=new AbortController;t.current=e;const o=await P(s,n,i,e.signal);return t.current===e&&(t.current=null),{oldCategoryName:n,newCategoryName:i,result:o}},onMutate:async({oldCategoryName:n,newCategoryName:i})=>{await Promise.all([r.cancelQueries(["menuCategoryList",s]),r.cancelQueries(["categoryDishes",n])]);const e=r.getQueryData(["menuCategoryList",s]),o=r.getQueryData(["categoryDishes",n]);return r.setQueryData(["menuCategoryList",s],e.map(a=>a.categoryName===n?{...a,categoryName:i}:a)),o&&(r.removeQueries(["categoryDishes",n]),r.setQueryData(["categoryDishes",i],o)),{previousMenuCategoryList:e,previousCategoryDishes:o,oldCategoryName:n}},onError:(n,i,e)=>{console.debug("varoables",i,e),e!=null&&e.previousMenuCategoryList&&r.setQueryData(["menuCategoryList",s],e.previousMenuCategoryList),e!=null&&e.previousCategoryDishes&&(r.setQueryData(["categoryDishes",e.oldCategoryName],e.previousCategoryDishes),r.removeQueries(["categoryDishes",i.newCategoryName])),alert("更新錯誤，請重整頁面後再試"),console.error("Update category name error:",n)},onSettled:n=>{}});return{changeCategoryName:d,isError:u,isPending:l}},E=({categoryData:s,menuId:r})=>{const[t,d]=y.useState(!1),[u,l]=y.useState((s==null?void 0:s.categoryName)||"未命名類別"),{changeCategoryName:n}=N(r);y.useEffect(()=>{l((s==null?void 0:s.categoryName)||"未命名類別")},[s]);const i=async a=>{if(a.preventDefault(),a.stopPropagation(),u.trim()!==""&&u.trim()!==(s==null?void 0:s.categoryName))try{await n({oldCategoryName:s==null?void 0:s.categoryName,newCategoryName:u.trim()})}catch(f){console.error("Failed to update category name:",f)}else u.trim()===""&&alert("不可為空");d(!1)},e=async a=>{a.key==="Enter"?await i(a):a.key==="Escape"&&(l((s==null?void 0:s.categoryName)||"未命名類別"),d(!1))},o=()=>{t?i():d(!0)};return p.jsxs("div",{className:"flex items-center gap-2 py-3 ",children:[t?p.jsx("input",{type:"text",value:u,onChange:a=>l(a.target.value),onBlur:i,onKeyDown:e,className:"border-b-2 border-gray-400 focus:border-blue-500 focus:outline-none text-2xl font-bold px-1 bg-transparent h-10 w-full",autoFocus:!0}):p.jsx("h2",{className:"text-2xl font-bold h-10 flex items-center px-1",children:(s==null?void 0:s.categoryName)||"未命名類別"}),p.jsx("button",{onClick:o,className:"p-2 hover:bg-gray-100 rounded-full transition-colors right-3 relative",title:t?"儲存":"編輯",children:t?p.jsx(j,{className:"w-5 h-5 text-blue-600"}):p.jsx(_,{className:"w-5 h-5 text-gray-600"})})]})};E.propTypes={categoryData:m.shape({categoryName:m.string,dishes:m.array}),menuId:m.string.isRequired};const k=async(s,r,t,d)=>{const u=v.get("authToken");try{return(await C.put(`/v2/menu/${s}/dishes`,t,{params:{category:r},signal:d,headers:{Authorization:`Bearer ${u}`}})).data}catch(l){if(b.isCancel(l)){console.debug("Update dishes order request cancelled");return}throw console.error(`Failed to update dishes order in category ${r}:`,l),l}},A=s=>{const r=w(),t=y.useRef(null),{mutateAsync:d,isError:u,isPending:l}=D({mutationFn:async({categoryName:n,newOrder:i})=>{t.current&&t.current.abort();const e=i.map(f=>f.id),o=new AbortController;t.current=o;const a=await k(s,n,e,o.signal);return t.current===o&&(t.current=null),a},onMutate:async({categoryName:n,newOrder:i})=>{await r.cancelQueries(["categoryDishes",n]);const e=r.getQueryData(["categoryDishes",n]),o={...e,dishes:i};return r.setQueryData(["categoryDishes",n],o),{previousDishes:e,categoryName:n}},onError:(n,i,e)=>{e!=null&&e.previousDishes&&r.setQueryData(["categoryDishes",e.categoryName],e.previousDishes),alert("變更錯誤，請重整後再試")},onSettled:(n,i,e)=>{r.invalidateQueries(["categoryDishes",e.categoryName])}});return{updateDishOrder:d,isError:u,isPending:l}},R=async(s,r,t)=>{const d=v.get("authToken");try{return(await C.delete(`/v2/menu/${s}/dish/${r}`,{signal:t,headers:{Authorization:`Bearer ${d}`}})).data}catch(u){if(b.isCancel(u)){console.debug("Delete dish request cancelled");return}throw console.error(`Failed to delete dish (ID: ${r}) from menu (ID: ${s}):`,u),u}},L=s=>{const r=w(),t=y.useRef(null),{mutateAsync:d,isError:u,isPending:l}=D({mutationFn:async({dishId:n,categoryName:i})=>{t.current&&t.current.abort();const e=new AbortController;t.current=e;const o=await R(s,n,e.signal);return t.current===e&&(t.current=null),o},onMutate:async({dishId:n,categoryName:i})=>{await r.cancelQueries(["categoryDishes",i]);const e=r.getQueryData(["categoryDishes",i]);return r.setQueryData(["categoryDishes",i],{previousDishes:e,dishes:e.dishes.filter(o=>o.id!==n)}),{previousDishes:e,categoryName:i}},onError:(n,i,e)=>{e!=null&&e.previousDishes&&r.setQueryData(["categoryDishes",e.categoryName],e.previousDishes),alert("刪除失敗，請重整頁面後再試一次"),console.error("Delete dish error:",n)},onSettled:(n,i,e)=>{r.invalidateQueries(["categoryDishes",e.categoryName]),r.invalidateQueries(["menuCategoryList",s])}});return{deleteMenuDish:d,isError:u,isPending:l}},T=y.lazy(()=>M(()=>import("./CartItemCardSkeleton-CfSShoZX.js"),__vite__mapDeps([0,1,2]))),$=y.lazy(()=>M(()=>import("./MenuItemCard-DkWCDaW-.js"),__vite__mapDeps([3,1,2,4,5,6,7,8,9,10,11,12,13,14,15,16])));function S({sectionRefs:s,categoryData:r,menuId:t}){const{updateDishOrder:d,isPending:u}=A(t),{deleteMenuDish:l,isPending:n}=L(t);N(t);const i=async(e,o,a)=>{const f=r.find(g=>g.categoryName===e),h=f.dishes.findIndex(g=>g.id===o),c=[...f.dishes];a==="up"&&h>0?[c[h],c[h-1]]=[c[h-1],c[h]]:a==="down"&&h<c.length-1?[c[h],c[h+1]]=[c[h+1],c[h]]:a==="up"&&h===0?[c[h],c[c.length-1]]=[c[c.length-1],c[h]]:a==="down"&&h===c.length-1&&([c[h],c[0]]=[c[0],c[h]]),await d({categoryName:e,newOrder:c})};return p.jsx("div",{className:"font-notoTC relative  flex flex-col justify-start container mx-auto p-4",children:r==null?void 0:r.map((e,o)=>p.jsxs("div",{ref:a=>s.current[o]=a,className:"w-full mb-8",children:[p.jsx(E,{categoryData:e,menuId:t}),p.jsx("div",{className:"grid gap-4",children:e==null?void 0:e.dishes.map((a,f)=>p.jsx(y.Suspense,{fallback:p.jsx(T,{}),children:p.jsx($,{categoryName:e.categoryName,food:a,onMove:i,onDelete:l})},f))})]},o))})}S.propTypes={sectionRefs:m.object.isRequired,categoryData:m.array.isRequired,menuId:m.string};export{S as default};
