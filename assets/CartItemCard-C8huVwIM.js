import{a as w,A as j,b as A,u as N,r as C,P as a,j as t}from"./index-Ctz5wWWd.js";import{u as q}from"./useMutation-DR8JSwrq.js";import{F as v,A as D}from"./index-Dl-t7eEf.js";import{b as Q}from"./blur-KQ8NzLoH.js";const E=async(c,s,p)=>{try{const l=w.get("authToken");return(await j.patch(`/v1/cart/dishes/${c}`,s,{headers:{Authorization:`Bearer ${l}`},signal:p})).data}catch(l){if(A.isCancel(l)){console.debug("PATCH cart request cancelled");return}else throw console.error("PATCH cart error; ",l),l}},R=()=>{const c=N(),s=C.useRef(null),{mutateAsync:p,onError:l,onMutate:u,isError:m}=q({mutationFn:async({orderedDishId:n,newQuantity:o})=>{s.current&&(console.debug("Abort previous patchCart request"),s.current.abort());const e=new AbortController;s.current=e;const r={quantity:o.toString()},i=await E(n,r,s.current.signal);return s.current===e&&(s.current=null),i},onMutate:async({orderedDishId:n,newQuantity:o})=>{await c.cancelQueries(["cart"]);const e=c.getQueryData(["cart"]),r=e?{...e}:{orderedDishes:[]};return r.orderedDishes||(r.orderedDishes=[]),o===0?r.orderedDishes=r.orderedDishes.filter(i=>i.id!==n):r.orderedDishes=r.orderedDishes.map(i=>i.id===n?{...i,quantity:o}:i),c.setQueryData(["cart"],r),{previousCart:e}},onError:(n,o,e)=>{throw e!=null&&e.previousCart&&(console.debug("rollback to previous cart",e),c.setQueryData(["cart"],e.previousCart)),alert("更新數量失敗，請稍後再試"),n},onSettled:()=>{console.debug("patchCartAsync onSettled"),c.invalidateQueries(["cart"])}});return{patchCartAsync:p,patchCartError:l,patchCartOnMutate:u,ispatchCartError:m}},k=({dishData:c,imageUrl:s})=>{const{dishId:p,id:l,dishName:u,price:m,quantity:n,chosenAttributes:o,note:e}=c,[r,i]=C.useState(n),{patchCartAsync:f}=R(),y=async h=>{const d=r+h;if(!(d<0||d>25)){d>0&&i(d);try{await f({orderedDishId:l,newQuantity:d})}catch(g){console.debug("patchCartAsync error:",g),i(n)}}};let x=0;const b=o!=null&&o.length?o.map(h=>(x+=h.extraCost||0,h.chosenOption)).join(", "):"";return r<=0?null:t.jsxs("div",{className:"relative flex rounded-lg p-4 w-full items-start min-h-[142px]",children:[s&&t.jsx(Q.LazyLoadImage,{src:s,alt:u,className:"w-20 h-26 object-cover rounded-lg flex-shrink-0",effect:"blur",wrapperClassName:"flex-shrink-0"}),t.jsxs("div",{className:"ml-4 flex min-w-0 flex-col h-full",children:[t.jsx("h2",{className:"text-lg font-semibold truncate",children:u}),b&&t.jsxs("p",{className:"text-sm text-gray-500 truncate",children:["+$",x," : ",b]}),e&&t.jsx("p",{className:"text-sm text-gray-500 line-clamp-2",children:e}),t.jsxs("p",{className:"text-xl mt-2 absolute bottom-[15px] font-semibold",children:["$ ",(m+x)*r]})]}),t.jsxs("div",{className:"absolute bottom-[15px] right-[15px] flex items-end border border-gray-300 rounded-md",children:[t.jsx("button",{onClick:()=>y(-1),className:"px-2 py-0 text-lg rounded-l-md w-7",children:n<=1?t.jsx(v,{icon:D,size:"xs",style:{color:"#d00b0b"}}):"-"}),t.jsx("span",{className:"px-4 py-0.5",children:r}),t.jsx("button",{onClick:()=>y(1),className:"px-2 py-0 text-lg rounded-r-md w-7",children:"+"})]})]})};k.propTypes={dishData:a.shape({id:a.string.isRequired,dishId:a.string.isRequired,dishName:a.string.isRequired,price:a.number.isRequired,quantity:a.number.isRequired,chosenAttributes:a.arrayOf(a.shape({name:a.string})),note:a.string}).isRequired,imageUrl:a.string};export{k as C,R as u};
