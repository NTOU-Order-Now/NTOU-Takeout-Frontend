import{a as S,A as j,b as D,u as U,r as N,P as i,c as w,j as t}from"./index-Ff2Wmbfi.js";import{a as F,u as T}from"./index-C0Z4jWJ7.js";import{u as v}from"./useSystemContext-ZPTzfkLO.js";import{u as I}from"./orderStore-DcEwVUze.js";import{u as K}from"./useMutation-CmnRw5Xs.js";const Q=async(e,l,r)=>{try{const a=S.get("authToken"),c=new URLSearchParams({status:l});return(await j.patch(`/v1/order/${e}/status?${c.toString()}`,null,{headers:{Authorization:`Bearer ${a}`},signal:r})).data}catch(a){if(D.isCancel(a)){console.debug("Update order status request cancelled");return}throw console.error("Update order status error:",a),a}},L=()=>{const e=U(),l=N.useRef(null),{mutateAsync:r,isError:a,error:c,isLoading:s}=K({mutationFn:async({orderId:u,newStatus:n})=>{l.current&&l.current.abort();const o=new AbortController;return l.current=o,await Q(u,n,o.signal),l.current===o&&(l.current=null),{orderId:u,newStatus:n}},onMutate:async({orderId:u,newStatus:n})=>{const o=n==="PROCESSING"?"PENDING":"ALL";return await e.cancelQueries(["orders",o]),{previousOrders:e.getQueryData(["orders",o])}},onError:(u,n,o)=>{const x=n.newStatus==="PROCESSING"?"PENDING":"ALL";console.debug("newOrder",n,"context",o),o!=null&&o.previousOrders&&e.setQueryData(["orders",x],o.previousOrders),alert("更新訂單狀態失敗，請稍後再試"),console.error("Update order status error:",u)},onSettled:({newStatus:u})=>{const n=u==="PROCESSING"?"PENDING":"ALL";console.debug("updateOrderStatusAsync onSettled"),e.invalidateQueries(["orders",n])}});return{updateOrderStatusAsync:r,isError:a,error:c,isLoading:s}},_=e=>{switch(e){case"PROCESSING":return{bgColor:"bg-blue-500",textColor:"text-gray-100",statusText:"製作中"};case"COMPLETED":return{bgColor:"bg-yellow-500",textColor:"text-gray-100",statusText:"未取餐"};case"PICKED_UP":return{bgColor:"bg-lime-600",textColor:"text-gray-100",statusText:"已取餐"};case"CANCELED":return{bgColor:"bg-gray-500",textColor:"text-gray-100",statusText:"取消"};default:return{bgColor:"bg-gray-200",textColor:"text-gray-100",statusText:""}}},f=e=>{switch(e){case"PROCESSING":return"COMPLETED";case"COMPLETED":return"PICKED_UP";case"PICKED_UP":return"CANCELED";case"PENDING":return"PROCESSING";default:return null}},E=({order:e,showStatus:l=!0})=>{const{bgColor:r,textColor:a,statusText:c}=_(e.status),{updateOrderStatusAsync:s,isLoading:u}=L(),n=I(d=>d.setOrderData),o=N.useCallback(async()=>{const d=f(e.status);if(d)try{await s({orderId:e.id,newStatus:d})}catch(C){console.error("Failed to update order status:",C)}},[e.id,e.status,s]),x=N.useCallback(async d=>{try{await s({orderId:d,newStatus:"PROCESSING"})}catch(C){console.error("Failed to accept order:",C)}},[s]),h=N.useCallback(async d=>{try{await s({orderId:d,newStatus:"CANCELED"}),console.debug("Reject order: ",d)}catch(C){console.error("Failed to reject order:",C)}},[s]),g=(d,C)=>{const b=new Date,[R,A,G]=d.split(":"),[q,M]=G.split("."),k=new Date(b.getFullYear(),b.getMonth(),b.getDate(),parseInt(R),parseInt(A),parseInt(q),parseInt(M)),$=new Date(k.getTime()+C*60*1e3);return new Date>$},p=w(),m=d=>{d.preventDefault(),n(e),p(`/store/pos/management/order/${e.id.slice(-5)}`)};return t.jsxs("div",{className:"relative flex justify-between rounded-lg p-4 shadow-lg mb-6 bg-gray-50",children:[t.jsxs("div",{className:"flex flex-col items-start text-start",children:[t.jsxs("p",{className:"text-xl font-bold ",children:["單號： ",e.id.slice(-5)]}),t.jsxs("p",{className:"text-sm font-semibold ",children:["預估製作時間: ",e.estimatedPrepTime," 分鐘"]}),t.jsxs("p",{className:"text-sm font-medium",children:["下單時間: ",e.orderTime]}),t.jsx("button",{className:"bg-orange-500 mt-6 text-white px-3 py-1 text-sm font-bold rounded hover:bg-orange-600",onClick:m,children:"訂單內容"})]}),t.jsxs("div",{className:"flex flex-col items-end",children:[l&&e.status!=="PENDING"&&t.jsxs("div",{className:"flex items-center mb-2",children:[g(e.orderTime,e.estimatedPrepTime)&&e.status==="PROCESSING"&&t.jsx("span",{className:"text-red-500 text-sm ml-2 font-bold pr-2",children:"超時"}),t.jsx("button",{onClick:o,disabled:!f(e.status),className:`px-3 py-1 rounded-md text-sm font-bold ${r} ${a} ${f(e.status)?"":"opacity-50 cursor-not-allowed"}`,children:c})]}),e.status==="PENDING"&&t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:()=>h(e.id),className:"bg-red-500 text-white px-3 py-1 text-sm font-bold rounded hover:bg-red-600",children:"拒絕"}),t.jsx("button",{onClick:()=>x(e.id),className:"bg-green-500 text-white px-3 py-1 text-sm font-bold rounded hover:bg-green-600",children:"接單"})]})]}),t.jsx("div",{className:"absolute bottom-4 right-4 mt-5",children:t.jsxs("p",{className:"mt-2 font-semibold",children:["總金額: ",e.cost," 元"]})})]})};E.propTypes={order:i.shape({id:i.string.isRequired,status:i.string.isRequired,cost:i.number.isRequired,orderTime:i.string.isRequired,estimatedPrepTime:i.number.isRequired}).isRequired,onAccept:i.func,onReject:i.func,onStatusChange:i.func,showStatus:i.bool};const z=e=>{switch(e){case"PENDING":return{bgColor:"bg-stone-600",textColor:"text-gray-100",statusText:"未接單"};case"PROCESSING":return{bgColor:"bg-blue-500",textColor:"text-gray-100",statusText:"製作中"};case"COMPLETED":return{bgColor:"bg-yellow-500",textColor:"text-gray-100",statusText:"未取餐"};case"PICKED_UP":return{bgColor:"bg-lime-600",textColor:"text-gray-100",statusText:"已取餐"};case"CANCELED":return{bgColor:"bg-gray-500",textColor:"text-gray-100",statusText:"取消"};default:return{bgColor:"bg-gray-200",textColor:"text-gray-100",statusText:""}}},y=e=>{switch(e){case"PROCESSING":return"COMPLETED";case"COMPLETED":return"PICKED_UP";case"PICKED_UP":return"CANCELED";case"PENDING":return"PROCESSING";default:return null}},P=({order:e,showStatus:l=!0})=>{const{bgColor:r,textColor:a,statusText:c}=z(e.status),{updateOrderStatusAsync:s,isLoading:u}=L(),n=I(g=>g.setOrderData),o=N.useCallback(async()=>{const g=y(e.status);if(g)try{await s({orderId:e.id,newStatus:g})}catch(p){console.error("Failed to update order status:",p)}},[e.id,e.status,s]),x=w(),h=g=>{g.preventDefault(),n(e),x(`/history/order/${e.id.slice(-5)}`)};return t.jsxs("div",{className:"relative flex justify-between rounded-lg p-4 shadow-lg mb-6 bg-gray-50",children:[t.jsxs("div",{className:"flex flex-col items-start text-start",children:[t.jsxs("p",{className:"text-xl font-bold ",children:["單號： ",e.id.slice(-5)]}),t.jsxs("p",{className:"text-sm font-semibold ",children:["預估製作時間: ",e.estimatedPrepTime," 分鐘"]}),t.jsxs("p",{className:"text-sm font-medium",children:["下單時間: ",e.orderTime]}),t.jsx("button",{className:"bg-orange-500 mt-6 text-white px-3 py-1 text-sm font-bold rounded hover:bg-orange-600",onClick:h,children:"訂單內容"})]}),t.jsx("div",{className:"flex flex-col items-end",children:l&&t.jsx("div",{className:"flex items-center mb-2",children:t.jsx("button",{onClick:o,disabled:!0,className:`px-3 py-1 rounded-md text-sm font-bold ${r} ${a} ${y(e.status)?"":"opacity-50 cursor-not-allowed"}`,children:c})})}),t.jsx("div",{className:"absolute bottom-4 right-4 mt-5",children:t.jsxs("p",{className:"mt-2 font-semibold",children:["總金額: ",e.cost," 元"]})})]})};P.propTypes={order:i.shape({id:i.string.isRequired,status:i.string.isRequired,cost:i.number.isRequired,orderTime:i.string.isRequired,estimatedPrepTime:i.number.isRequired}).isRequired,onAccept:i.func,onReject:i.func,onStatusChange:i.func,showStatus:i.bool};const H=async(e={},l)=>{try{const{page:r=0,size:a=3,status:c}=e,s=new URLSearchParams({page:r.toString(),size:a.toString()});c&&s.append("status",c);const u=S.get("authToken");return(await j.get(`/v1/order/search?${s.toString()}`,{headers:{Authorization:`Bearer ${u}`},signal:l})).data}catch(r){if(D.isCancel(r)){console.debug("Search order request cancelled");return}throw console.error("Search order error:",r),r}},O=e=>{const{data:r,fetchNextPage:a,hasNextPage:c,isFetchingNextPage:s,isLoading:u,isError:n,error:o}=F({queryKey:["orders",e],queryFn:async({pageParam:x=0})=>(await H({page:x,size:3,status:e==="ALL"?null:e})).data,getNextPageParam:(x,h)=>{const g=x.currentPage;return g<x.totalPages-1?g+1:void 0}});return{orders:r,fetchNextPage:a,hasNextPage:c,isFetchingNextPage:s,isLoading:u,isError:n,error:o}},X=()=>{const{ref:e,inView:l}=T({rootMargin:"100px"}),{userInfo:r}=v(),a=r==null?void 0:r.role,{orders:c,fetchNextPage:s,hasNextPage:u,isFetchingNextPage:n,isLoading:o,isError:x,error:h}=O(a==="MERCHANT"?"PENDING":"ALL");N.useEffect(()=>{l&&!n&&u&&s()},[l,n,u,s]);const g=c==null?void 0:c.pages.map(p=>p.content.filter(m=>a==="MERCHANT"?m.status==="PENDING":m.status!=="PICKED_UP"&&m.status!=="CANCELED"));return o||c===void 0?t.jsx("div",{className:"text-center pt-20",children:"Loading..."}):x?t.jsxs("div",{className:"text-center pt-20",children:["Error: ",h.message]}):t.jsxs("div",{className:"flex flex-col text-center justify-between ",children:[g==null?void 0:g.map(p=>p.map((m,d)=>a==="MERCHANT"?t.jsx(E,{order:m},d):t.jsx(P,{order:m},d))),t.jsx("div",{ref:e,children:u&&n&&t.jsx("div",{className:"text-center py-4",children:"Loading more..."})})]})};function V(){const{ref:e,inView:l}=T({rootMargin:"100px"}),{orders:r,fetchNextPage:a,hasNextPage:c,isFetchingNextPage:s,isLoading:u,isError:n,error:o}=O("ALL"),{userInfo:x}=v(),h=x==null?void 0:x.role,g=r==null?void 0:r.pages.map(p=>p.content.filter(m=>h==="MERCHANT"?m.status!=="PENDING":m.status!=="PENDING"&&m.status!=="PROCESSING"&&m.status!=="COMPLETED"));return N.useEffect(()=>{l&&!s&&c&&a()},[l,s,c,a]),u?t.jsx("div",{className:"text-center pt-20",children:"Loading..."}):n?t.jsxs("div",{className:"text-center pt-20",children:["Error: ",o]}):t.jsxs("div",{className:"flex flex-col text-center justify-between ",children:[g.map(p=>p.map((m,d)=>h==="MERCHANT"?t.jsx(E,{order:m},d):t.jsx(P,{order:m},d))),t.jsx("div",{ref:e,children:c&&s&&t.jsx("div",{className:"text-center py-4",children:"Loading more..."})})]})}V.prototype={orderData:i.object};export{V as A,X as U};
