const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CategoryHeader-CeE0DCGd.js","assets/index-DgZaxSQk.js","assets/index-s7aVEVuV.css","assets/useMutation-DUdRml54.js","assets/skeleton-CsZSLtsb.js","assets/CartItemCardSkeleton-CYn-gkjS.js","assets/MenuItemCard-d4PYtmYu.js","assets/blur-DaSWnpx3.js","assets/blur-DOfe2hmq.css","assets/index-Dg1olnty.js","assets/Menu-BUDB3jxd.js","assets/sidebarStore-CaTXcstr.js","assets/Header-CuytzHBQ.js","assets/NavbarSkeleton-CVrSMl3V.js","assets/MenuSectionSkeleton-CpNNH_Nn.js","assets/useCategoryQueries-CgMOY6Vf.js","assets/merchantMenuNav-2cLtnV2M.js","assets/faEllipsis-CxEkbWIP.js","assets/useImageUploadMutation-7-PoUtIa.js"])))=>i.map(i=>d[i]);
import{a as b,A as Q,b as M,u as v,r as D,_ as w,j as h,P as _}from"./index-DgZaxSQk.js";import{u as P}from"./useMutation-DUdRml54.js";import{S as E}from"./skeleton-CsZSLtsb.js";const L=async(o,r,s,d)=>{const c=b.get("authToken");try{return(await Q.put(`/v2/menu/${o}/dishes`,s,{params:{category:r},signal:d,headers:{Authorization:`Bearer ${c}`}})).data}catch(u){if(M.isCancel(u)){console.debug("Update dishes order request cancelled");return}throw console.error(`Failed to update dishes order in category ${r}:`,u),u}},R=o=>{const r=v(),s=D.useRef(null),{mutateAsync:d,isError:c,isPending:u}=P({mutationFn:async({categoryName:t,newOrder:a})=>{s.current&&s.current.abort();const e=a.map(g=>g.id),l=new AbortController;s.current=l;const y=await L(o,t,e,l.signal);return s.current===l&&(s.current=null),y},onMutate:async({categoryName:t,newOrder:a})=>{await r.cancelQueries(["categoryDishes",t]);const e=r.getQueryData(["categoryDishes",t]),l={...e,dishes:a};return r.setQueryData(["categoryDishes",t],l),{previousDishes:e,categoryName:t}},onError:(t,a,e)=>{e!=null&&e.previousDishes&&r.setQueryData(["categoryDishes",e.categoryName],e.previousDishes),alert("變更錯誤，請重整後再試")},onSettled:(t,a,e)=>{r.invalidateQueries(["categoryDishes",e.categoryName])}});return{updateDishOrder:d,isError:c,isPending:u}},T=async(o,r,s)=>{const d=b.get("authToken");try{return(await Q.delete(`/v2/menu/${o}/dish/${r}`,{signal:s,headers:{Authorization:`Bearer ${d}`}})).data}catch(c){if(M.isCancel(c)){console.debug("Delete dish request cancelled");return}throw console.error(`Failed to delete dish (ID: ${r}) from menu (ID: ${o}):`,c),c}},$=o=>{const r=v(),s=D.useRef(null),{mutateAsync:d,isError:c,isPending:u}=P({mutationFn:async({dishId:t,categoryName:a})=>{s.current&&s.current.abort();const e=new AbortController;s.current=e;const l=await T(o,t,e.signal);return s.current===e&&(s.current=null),l},onMutate:async({dishId:t,categoryName:a})=>{await r.cancelQueries(["categoryDishes",a]);const e=r.getQueryData(["categoryDishes",a]);return r.setQueryData(["categoryDishes",a],{previousDishes:e,dishes:e.dishes.filter(l=>l.id!==t)}),{previousDishes:e,categoryName:a}},onError:(t,a,e)=>{e!=null&&e.previousDishes&&r.setQueryData(["categoryDishes",e.categoryName],e.previousDishes),alert("刪除失敗，請重整頁面後再試一次"),console.error("Delete dish error:",t)},onSettled:(t,a,e)=>{r.invalidateQueries(["categoryDishes",e.categoryName]),r.invalidateQueries(["menuCategoryList",o])}});return{deleteMenuDish:d,isError:c,isPending:u}},O=async(o,r,s,d)=>{const c=b.get("authToken");try{return(await Q.patch(`/v2/menu/${o}/dishes`,{categoryName:s},{params:{category:r},signal:d,headers:{Authorization:`Bearer ${c}`}})).data}catch(u){if(M.isCancel(u)){console.debug("Update category name request cancelled");return}throw console.error(`Failed to update category name from ${r} to ${s}:`,u),u}},S=o=>{const r=v(),s=D.useRef(null),{mutateAsync:d,isError:c,isPending:u}=P({mutationFn:async({oldCategoryName:t,newCategoryName:a})=>{s.current&&s.current.abort();const e=new AbortController;s.current=e;const l=await O(o,t,a,e.signal);return s.current===e&&(s.current=null),{oldCategoryName:t,newCategoryName:a,result:l}},onMutate:async({oldCategoryName:t,newCategoryName:a})=>{const e=r.getQueryData(["menuCategoryList",o]),l=r.getQueryData(["categoryDishes",t]);return r.setQueryData(["menuCategoryList",o],e.map(y=>y.categoryName===t?{...y,categoryName:a}:y)),l&&r.setQueryData(["categoryDishes",a],{categoryName:a,dishes:l.dishes.map(y=>({...y,category:a}))}),{previousMenuCategoryList:e,previousCategoryDishes:l,oldCategoryName:t}},onError:(t,a,e)=>{console.debug("varoables",a,e),e!=null&&e.previousMenuCategoryList&&r.setQueryData(["menuCategoryList",o],e.previousMenuCategoryList),e!=null&&e.previousCategoryDishes&&(r.setQueryData(["categoryDishes",e.oldCategoryName],e.previousCategoryDishes),r.removeQueries(["categoryDishes",a.newCategoryName])),alert("更新錯誤，請重整頁面後再試"),console.error("Update category name error:",t)},onSettled:t=>{r.invalidateQueries(["menuCategoryList",o]),t&&(r.invalidateQueries(["categoryDishes",t.oldCategoryName]),r.invalidateQueries(["categoryDishes",t.newCategoryName]))}});return{changeCategoryName:d,isError:c,isPending:u}},k=D.lazy(()=>w(()=>import("./CategoryHeader-CeE0DCGd.js"),__vite__mapDeps([0,1,2,3,4]))),j=D.lazy(()=>w(()=>import("./CartItemCardSkeleton-CYn-gkjS.js"),__vite__mapDeps([5,1,2]))),N=D.lazy(()=>w(()=>import("./MenuItemCard-d4PYtmYu.js"),__vite__mapDeps([6,1,2,7,8,9,10,11,12,13,14,15,16,17,18,3])));function A({sectionRefs:o,categoryData:r,menuId:s}){const{updateDishOrder:d,isPending:c}=R(s),{deleteMenuDish:u,isPending:t}=$(s),{isPending:a}=S(s),e=v();if(console.debug("isChangeCategoryNamePending",a),a)return h.jsx(j,{});const l=async(g,m,p)=>{const f=r.find(C=>C.categoryName===g),i=f.dishes.findIndex(C=>C.id===m),n=[...f.dishes];p==="up"&&i>0?[n[i],n[i-1]]=[n[i-1],n[i]]:p==="down"&&i<n.length-1?[n[i],n[i+1]]=[n[i+1],n[i]]:p==="up"&&i===0?[n[i],n[n.length-1]]=[n[n.length-1],n[i]]:p==="down"&&i===n.length-1&&([n[i],n[0]]=[n[0],n[i]]),await d({categoryName:g,newOrder:n})},y=e.getQueryData(["menuCategoryList",s]);return h.jsx("div",{className:"font-notoTC relative  flex flex-col justify-start container mx-auto p-4",children:r==null?void 0:r.map((g,m)=>{var p;return h.jsxs("div",{ref:f=>o.current[m]=f,className:"w-full mb-8",children:[h.jsx(D.Suspense,{fallback:h.jsx(E,{className:"w-10 h-4"}),children:h.jsx(k,{categoryName:(p=y[m])==null?void 0:p.categoryName,menuId:s})}),h.jsx("div",{className:"grid gap-4",children:g==null?void 0:g.dishes.map((f,i)=>h.jsx(D.Suspense,{fallback:h.jsx(j,{}),children:h.jsx(N,{categoryName:g.categoryName,food:f,onMove:l,onDelete:u})},i))})]},m)})})}A.propTypes={sectionRefs:_.object.isRequired,categoryData:_.array.isRequired,menuId:_.string};const U=Object.freeze(Object.defineProperty({__proto__:null,default:A},Symbol.toStringTag,{value:"Module"}));export{U as M,S as u};
