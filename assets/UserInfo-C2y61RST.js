import{a as C,A as j,b as N,u as w,r as f,P as t,j as r}from"./index-CGLjlMRI.js";import{u as q}from"./useMutation-DlAJJIzI.js";import{F as A,A as v}from"./index-DdxdYMTC.js";import{b as R}from"./blur-Cy3ahvP8.js";const D=async(s,n,d)=>{try{const i=C.get("authToken");return(await j.patch(`/v1/cart/dishes/${s}`,n,{headers:{Authorization:`Bearer ${i}`},signal:d})).data}catch(i){if(N.isCancel(i)){console.debug("PATCH cart request cancelled");return}else throw console.error("PATCH cart error; ",i),i}},T=()=>{const s=w(),n=f.useRef(null),{mutateAsync:d,onError:i,onMutate:m,isError:u}=q({mutationFn:async({orderedDishId:o,newQuantity:l})=>{n.current&&(console.debug("Abort previous patchCart request"),n.current.abort());const e=new AbortController;n.current=e;const a={quantity:l.toString()},c=await D(o,a,n.current.signal);return n.current===e&&(n.current=null),c},onMutate:async({orderedDishId:o,newQuantity:l})=>{await s.cancelQueries(["cart"]);const e=s.getQueryData(["cart"]),a=e?{...e}:{orderedDishes:[]};return a.orderedDishes||(a.orderedDishes=[]),l===0?a.orderedDishes=a.orderedDishes.filter(c=>c.id!==o):a.orderedDishes=a.orderedDishes.map(c=>c.id===o?{...c,quantity:l}:c),s.setQueryData(["cart"],a),{previousCart:e}},onError:(o,l,e)=>{throw e!=null&&e.previousCart&&(console.debug("rollback to previous cart",e),s.setQueryData(["cart"],e.previousCart)),alert("更新數量失敗，請稍後再試"),o},onSettled:()=>{console.debug("patchCartAsync onSettled"),s.invalidateQueries(["cart"])}});return{patchCartAsync:d,patchCartError:i,patchCartOnMutate:m,ispatchCartError:u}},Q=({dishData:s,imageUrl:n})=>{const{dishId:d,dishName:i,price:m,quantity:u,chosenAttributes:o,note:l}=s,[e,a]=f.useState(u),{patchCartAsync:c}=T(),b=async h=>{const p=e+h;if(!(p<0||p>25)){p>0&&a(p);try{await c({orderedDishId:d,newQuantity:p})}catch(g){console.debug("patchCartAsync error:",g),a(u)}}};let x=0;const y=o!=null&&o.length?o.map(h=>(x+=h.extraCost||0,h.chosenOption)).join(", "):"";return e<=0?null:r.jsxs("div",{className:"relative flex rounded-lg p-4 w-full items-start min-h-[142px]",children:[n&&r.jsx(R.LazyLoadImage,{src:n,alt:i,className:"w-20 h-26 object-cover rounded-lg flex-shrink-0",effect:"blur",wrapperClassName:"flex-shrink-0"}),r.jsxs("div",{className:"ml-4 flex min-w-0 flex-col h-full",children:[r.jsx("h2",{className:"text-lg font-semibold truncate",children:i}),y&&r.jsxs("p",{className:"text-sm text-gray-500 truncate",children:["+$",x," : ",y]}),l&&r.jsx("p",{className:"text-sm text-gray-500 line-clamp-2",children:l}),r.jsxs("p",{className:"text-xl mt-2 absolute bottom-[15px] font-semibold",children:["$ ",(m+x)*e]})]}),r.jsxs("div",{className:"absolute bottom-[15px] right-[15px] flex items-end border border-gray-300 rounded-md",children:[r.jsx("button",{onClick:()=>b(-1),className:"px-2 py-0 text-lg rounded-l-md w-7",children:u<=1?r.jsx(A,{icon:v,size:"xs",style:{color:"#d00b0b"}}):"-"}),r.jsx("span",{className:"px-4 py-0.5",children:e}),r.jsx("button",{onClick:()=>b(1),className:"px-2 py-0 text-lg rounded-r-md w-7",children:"+"})]})]})};Q.propTypes={dishData:t.shape({dishId:t.string.isRequired,dishName:t.string.isRequired,price:t.number.isRequired,quantity:t.number.isRequired,chosenAttributes:t.arrayOf(t.shape({name:t.string})),note:t.string}).isRequired,imageUrl:t.string};const E=({user:s})=>r.jsxs("div",{className:"mb-6 flex flex-col items-start gap-2",children:[r.jsxs("p",{className:"font-bold text-lg bg-gray-200 p-2 rounded-md",children:["用戶ID: ",s.id]}),r.jsxs("p",{className:"text-lg   ",children:["下單時間: ",s.orderTime]}),r.jsxs("p",{className:"text-lg",children:["預估製作時間: ",s.estimatedPrepTime," 分鐘"]}),r.jsxs("p",{className:"text-2xl font-bold mt-2",children:["總金額: $",s.cost]})]});E.propTypes={user:t.shape({id:t.string.isRequired,estimatedPrepTime:t.number.isRequired,orderTime:t.string.isRequired,cost:t.number.isRequired}).isRequired};export{Q as C,E as U,T as u};
