import{a as P,A as S,b as E,u as j,r as h,P as x,c as k,j as t}from"./index-B0phGC0e.js";import{H as U}from"./Header-h9rZ6ONA.js";import{u as C}from"./sidebarStore-B8r9pRvC.js";import{u as F}from"./orderStore-ComnaOFZ.js";import{u as M}from"./useMutation-_dFNOJvl.js";import{a as $,u as v}from"./index-mu-vxHF8.js";import{T as Q}from"./ToggleNavBar-GS99PH68.js";import"./index-C1bfWLKy.js";const z=async(e,o,s)=>{try{const n=P.get("authToken"),c=new URLSearchParams({status:o});return(await S.patch(`/v1/order/${e}/status?${c.toString()}`,null,{headers:{Authorization:`Bearer ${n}`},signal:s})).data}catch(n){if(E.isCancel(n)){console.debug("Update order status request cancelled");return}throw console.error("Update order status error:",n),n}},B=()=>{const e=j(),o=h.useRef(null),{mutateAsync:s,isError:n,error:c,isLoading:a}=M({mutationFn:async({orderId:l,newStatus:i})=>{o.current&&o.current.abort();const r=new AbortController;return o.current=r,await z(l,i,r.signal),o.current===r&&(o.current=null),{orderId:l,newStatus:i}},onMutate:async({orderId:l,newStatus:i})=>{const r=i==="PROCESSING"?"PENDING":"ALL";return await e.cancelQueries(["orders",r]),{previousOrders:e.getQueryData(["orders",r])}},onError:(l,i,r)=>{const u=i.newStatus==="PROCESSING"?"PENDING":"ALL";console.debug("newOrder",i,"context",r),r!=null&&r.previousOrders&&e.setQueryData(["orders",u],r.previousOrders),alert("更新訂單狀態失敗，請稍後再試"),console.error("Update order status error:",l)},onSettled:({newStatus:l})=>{const i=l==="PROCESSING"?"PENDING":"ALL";console.debug("updateOrderStatusAsync onSettled"),e.invalidateQueries(["orders",i])}});return{updateOrderStatusAsync:s,isError:n,error:c,isLoading:a}},_=e=>{switch(e){case"PROCESSING":return{bgColor:"bg-blue-500",textColor:"text-gray-100",statusText:"製作中"};case"COMPLETED":return{bgColor:"bg-yellow-500",textColor:"text-gray-100",statusText:"未取餐"};case"PICKED_UP":return{bgColor:"bg-lime-600",textColor:"text-gray-100",statusText:"已取餐"};case"CANCELED":return{bgColor:"bg-gray-500",textColor:"text-gray-100",statusText:"取消"};default:return{bgColor:"bg-gray-200",textColor:"text-gray-100",statusText:""}}},b=e=>{switch(e){case"PROCESSING":return"COMPLETED";case"COMPLETED":return"PICKED_UP";case"PICKED_UP":return"CANCELED";case"PENDING":return"PROCESSING";default:return null}},y=({order:e,showStatus:o=!0})=>{const{bgColor:s,textColor:n,statusText:c}=_(e.status),{updateOrderStatusAsync:a,isLoading:l}=B(),i=F(d=>d.setOrderData),r=h.useCallback(async()=>{const d=b(e.status);if(d)try{await a({orderId:e.id,newStatus:d})}catch(m){console.error("Failed to update order status:",m)}},[e.id,e.status,a]),u=h.useCallback(async d=>{try{await a({orderId:d,newStatus:"PROCESSING"})}catch(m){console.error("Failed to accept order:",m)}},[a]),p=h.useCallback(async d=>{try{await a({orderId:d,newStatus:"CANCELED"}),console.debug("Reject order: ",d)}catch(m){console.error("Failed to reject order:",m)}},[a]),g=(d,m)=>{const N=new Date,[I,L,O]=d.split(":"),[A,R]=O.split("."),G=new Date(N.getFullYear(),N.getMonth(),N.getDate(),parseInt(I),parseInt(L),parseInt(A),parseInt(R)),q=new Date(G.getTime()+m*60*1e3);return new Date>q},f=k(),T=d=>{d.preventDefault(),i(e),f(`/store/pos/management/order/${e.id.slice(-5)}`)};return t.jsxs("div",{className:"relative flex justify-between rounded-lg p-4 shadow-lg mb-6 bg-gray-50",children:[t.jsxs("div",{className:"flex flex-col items-start text-start",children:[t.jsxs("p",{className:"text-xl font-bold ",children:["單號： ",e.id.slice(-5)]}),t.jsxs("p",{className:"text-sm font-semibold ",children:["預估製作時間: ",e.estimatedPrepTime," 分鐘"]}),t.jsxs("p",{className:"text-sm font-medium",children:["下單時間: ",e.orderTime]}),t.jsx("button",{className:"bg-orange-500 mt-6 text-white px-3 py-1 text-sm font-bold rounded hover:bg-orange-600",onClick:T,children:"訂單內容"})]}),t.jsxs("div",{className:"flex flex-col items-end",children:[o&&e.status!=="PENDING"&&t.jsxs("div",{className:"flex items-center mb-2",children:[g(e.orderTime,e.estimatedPrepTime)&&e.status==="PROCESSING"&&t.jsx("span",{className:"text-red-500 text-sm ml-2 font-bold pr-2",children:"超時"}),t.jsx("button",{onClick:r,disabled:!b(e.status),className:`px-3 py-1 rounded-md text-sm font-bold ${s} ${n} ${b(e.status)?"":"opacity-50 cursor-not-allowed"}`,children:c})]}),e.status==="PENDING"&&t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:()=>p(e.id),className:"bg-red-500 text-white px-3 py-1 text-sm font-bold rounded hover:bg-red-600",children:"拒絕"}),t.jsx("button",{onClick:()=>u(e.id),className:"bg-green-500 text-white px-3 py-1 text-sm font-bold rounded hover:bg-green-600",children:"接單"})]})]}),t.jsx("div",{className:"absolute bottom-4 right-4 mt-5",children:t.jsxs("p",{className:"mt-2 font-semibold",children:["總金額: ",e.cost," 元"]})})]})};y.propTypes={order:x.shape({id:x.string.isRequired,status:x.string.isRequired,cost:x.number.isRequired,orderTime:x.string.isRequired,estimatedPrepTime:x.number.isRequired}).isRequired,onAccept:x.func,onReject:x.func,onStatusChange:x.func,showStatus:x.bool};const K=async(e={},o)=>{try{const{page:s=0,size:n=3,status:c}=e,a=new URLSearchParams({page:s.toString(),size:n.toString()});c&&a.append("status",c);const l=P.get("authToken");return(await S.get(`/v1/order/search?${a.toString()}`,{headers:{Authorization:`Bearer ${l}`},signal:o})).data}catch(s){if(E.isCancel(s)){console.debug("Search order request cancelled");return}throw console.error("Search order error:",s),s}},w=e=>{const{data:s,fetchNextPage:n,hasNextPage:c,isFetchingNextPage:a,isLoading:l,isError:i,error:r}=$({queryKey:["orders",e],queryFn:async({pageParam:u=0})=>(await K({page:u,size:3,status:e==="ALL"?null:e})).data,getNextPageParam:(u,p)=>{const g=u.currentPage;return g<u.totalPages-1?g+1:void 0}});return{orders:s,fetchNextPage:n,hasNextPage:c,isFetchingNextPage:a,isLoading:l,isError:i,error:r}},V=()=>{const{ref:e,inView:o}=v({rootMargin:"100px"}),{orders:s,fetchNextPage:n,hasNextPage:c,isFetchingNextPage:a,isLoading:l,isError:i,error:r}=w("PENDING");return h.useEffect(()=>{o&&!a&&c&&n()},[o,a,c,n]),l||s===void 0?t.jsx("div",{className:"text-center pt-20",children:"Loading..."}):i?t.jsxs("div",{className:"text-center pt-20",children:["Error: ",r.message]}):(s==null?void 0:s.pages.length)===0?t.jsx("div",{className:"text-center pt-20",children:"目前沒有未接訂單"}):t.jsxs("div",{className:"flex flex-col text-center justify-between ",children:[s==null?void 0:s.pages.map(u=>u.content.map((p,g)=>t.jsx(y,{order:p},g))),t.jsx("div",{ref:e,children:c&&a&&t.jsx("div",{className:"text-center py-4",children:"Loading more..."})})]})};function D(){const{ref:e,inView:o}=v({rootMargin:"100px"}),{orders:s,fetchNextPage:n,hasNextPage:c,isFetchingNextPage:a,isLoading:l,isError:i,error:r}=w("ALL"),u=s==null?void 0:s.pages.map(p=>p.content.filter(g=>g.status!=="PENDING"));return h.useEffect(()=>{o&&!a&&c&&n()},[o,a,c,n]),l?t.jsx("div",{className:"text-center pt-20",children:"Loading..."}):i?t.jsxs("div",{className:"text-center pt-20",children:["Error: ",r.message]}):t.jsxs("div",{className:"flex flex-col text-center justify-between ",children:[u.map(p=>p.map((g,f)=>t.jsx(y,{order:g},f))),t.jsx("div",{ref:e,children:c&&a&&t.jsx("div",{className:"text-center py-4",children:"Loading more..."})})]})}D.prototype={orderData:x.object};const se=()=>{j().getQueryData(["order","PENDING"]);const[o,s]=h.useState(0),n=C(r=>r.toggleSidebar),c=C(r=>r.title),i={未接受:()=>{s(0),console.debug("handleToUnaccepted")},已接受:()=>{s(1),console.debug("handleToAccepted")}};return t.jsxs("div",{className:"flex flex-col h-screen",children:[t.jsx(U,{title:c,onLeftClick:n}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"sticky top-[50px] mt-[50px] z-20 px-10 py-1  h-[85px] bg-white content-center rounded-b-xl shadow-sm ",children:t.jsx(Q,{options:i,InitActiveTab:"未接受"})}),t.jsx("div",{className:"overflow-auto h-[dvh-64px] px-8 py-2",children:o===0?t.jsx(V,{}):t.jsx(D,{})})]})]})};export{se as default};
