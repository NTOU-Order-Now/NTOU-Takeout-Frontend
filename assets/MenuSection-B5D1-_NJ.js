const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CartItemCardSkeleton-cC5wtZbN.js","assets/index-B63W5zLe.js","assets/index-BYhJshBL.css","assets/MenuItemCard-cm_2l5N9.js","assets/blur-CZbtjyQu.js","assets/blur-DOfe2hmq.css","assets/index-D3rtBfOE.js","assets/Menu-BhQbeE9a.js","assets/sidebarStore-B7aKiMLE.js","assets/Header-DaPRMSXS.js","assets/NavbarSkeleton-B40cEDMr.js","assets/MenuSectionSkeleton-BTnFGQ0w.js","assets/useCategoryQueries-Dg7dVoOM.js","assets/useQueries-QrrutrQp.js","assets/merchantMenuNav-yk9HiYnW.js","assets/useImageUploadMutation-CUwOJdrA.js","assets/useMutation-DTmJSCIp.js","assets/useSystemContext-D2UnwePm.js"])))=>i.map(i=>d[i]);
import{a as v,A as C,b as w,u as D,r as y,P as f,j as p,_ as N}from"./index-B63W5zLe.js";import{u as b}from"./useMutation-DTmJSCIp.js";import{c as M}from"./createLucideIcon-CKJHf_cw.js";/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _=M("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P=M("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),k=async(r,s,t,d)=>{const o=v.get("authToken");try{return(await C.patch(`/v2/menu/${r}/dishes`,{categoryName:t},{params:{category:s},signal:d,headers:{Authorization:`Bearer ${o}`}})).data}catch(l){if(w.isCancel(l)){console.debug("Update category name request cancelled");return}throw console.error(`Failed to update category name from ${s} to ${t}:`,l),l}},j=r=>{const s=D(),t=y.useRef(null),{mutateAsync:d,isError:o,isPending:l}=b({mutationFn:async({oldCategoryName:n,newCategoryName:i})=>{t.current&&t.current.abort();const e=new AbortController;t.current=e;const u=await k(r,n,i,e.signal);return t.current===e&&(t.current=null),{oldCategoryName:n,newCategoryName:i,result:u}},onMutate:async({oldCategoryName:n,newCategoryName:i})=>{await Promise.all([s.cancelQueries(["menuCategoryList",r]),s.cancelQueries(["categoryDishes",n])]);const e=s.getQueryData(["menuCategoryList",r]),u=s.getQueryData(["categoryDishes",n]);return s.setQueryData(["menuCategoryList",r],e.map(a=>a.categoryName===n?{...a,categoryName:i}:a)),u&&(s.removeQueries(["categoryDishes",n]),s.setQueryData(["categoryDishes",i],u)),{previousMenuCategoryList:e,previousCategoryDishes:u,oldCategoryName:n}},onError:(n,i,e)=>{console.debug("varoables",i,e),e!=null&&e.previousMenuCategoryList&&s.setQueryData(["menuCategoryList",r],e.previousMenuCategoryList),e!=null&&e.previousCategoryDishes&&(s.setQueryData(["categoryDishes",e.oldCategoryName],e.previousCategoryDishes),s.removeQueries(["categoryDishes",i.newCategoryName])),alert("更新錯誤，請重整頁面後再試"),console.error("Update category name error:",n)},onSettled:n=>{s.invalidateQueries(["menuCategoryList",r]),n&&(s.invalidateQueries(["categoryDishes",n.oldCategoryName]),s.invalidateQueries(["categoryDishes",n.newCategoryName]))}});return{changeCategoryName:d,isError:o,isPending:l}},E=({categoryData:r,menuId:s})=>{const[t,d]=y.useState(!1),[o,l]=y.useState((r==null?void 0:r.categoryName)||"未命名類別"),{changeCategoryName:n}=j(s);y.useEffect(()=>{l((r==null?void 0:r.categoryName)||"未命名類別")},[r]);const i=async a=>{if(a.preventDefault(),a.stopPropagation(),o.trim()!==""&&o.trim()!==(r==null?void 0:r.categoryName))try{await n({oldCategoryName:r==null?void 0:r.categoryName,newCategoryName:o.trim()})}catch(m){console.error("Failed to update category name:",m)}else o.trim()===""&&alert("不可為空");d(!1)},e=async a=>{a.key==="Enter"?await i(a):a.key==="Escape"&&(l((r==null?void 0:r.categoryName)||"未命名類別"),d(!1))},u=()=>{t?i():d(!0)};return p.jsxs("div",{className:"flex items-center gap-2 py-3 ",children:[t?p.jsx("input",{type:"text",value:o,onChange:a=>l(a.target.value),onBlur:i,onKeyDown:e,className:"border-b-2 border-gray-400 focus:border-blue-500 focus:outline-none text-2xl font-bold px-1 bg-transparent h-10 w-full",autoFocus:!0}):p.jsx("h2",{className:"text-2xl font-bold h-10 flex items-center px-1",children:(r==null?void 0:r.categoryName)||"未命名類別"}),p.jsx("button",{onClick:u,className:"p-2 hover:bg-gray-100 rounded-full transition-colors right-3 relative",title:t?"儲存":"編輯",children:t?p.jsx(P,{className:"w-5 h-5 text-blue-600"}):p.jsx(_,{className:"w-5 h-5 text-gray-600"})})]})};E.propTypes={categoryData:f.shape({categoryName:f.string,dishes:f.array}),menuId:f.string.isRequired};const A=async(r,s,t,d)=>{const o=v.get("authToken");try{return(await C.put(`/v2/menu/${r}/dishes`,t,{params:{category:s},signal:d,headers:{Authorization:`Bearer ${o}`}})).data}catch(l){if(w.isCancel(l)){console.debug("Update dishes order request cancelled");return}throw console.error(`Failed to update dishes order in category ${s}:`,l),l}},L=r=>{const s=D(),t=y.useRef(null),{mutateAsync:d,isError:o,isPending:l}=b({mutationFn:async({categoryName:n,newOrder:i})=>{t.current&&t.current.abort();const e=i.map(m=>m.id),u=new AbortController;t.current=u;const a=await A(r,n,e,u.signal);return t.current===u&&(t.current=null),a},onMutate:async({categoryName:n,newOrder:i})=>{await s.cancelQueries(["categoryDishes",n]);const e=s.getQueryData(["categoryDishes",n]),u={...e,dishes:i};return s.setQueryData(["categoryDishes",n],u),{previousDishes:e,categoryName:n}},onError:(n,i,e)=>{e!=null&&e.previousDishes&&s.setQueryData(["categoryDishes",e.categoryName],e.previousDishes),alert("變更錯誤，請重整後再試")},onSettled:(n,i,e)=>{s.invalidateQueries(["categoryDishes",e.categoryName])}});return{updateDishOrder:d,isError:o,isPending:l}},R=async(r,s,t)=>{const d=v.get("authToken");try{return(await C.delete(`/v2/menu/${r}/dish/${s}`,{signal:t,headers:{Authorization:`Bearer ${d}`}})).data}catch(o){if(w.isCancel(o)){console.debug("Delete dish request cancelled");return}throw console.error(`Failed to delete dish (ID: ${s}) from menu (ID: ${r}):`,o),o}},T=r=>{const s=D(),t=y.useRef(null),{mutateAsync:d,isError:o,isPending:l}=b({mutationFn:async({dishId:n,categoryName:i})=>{t.current&&t.current.abort();const e=new AbortController;t.current=e;const u=await R(r,n,e.signal);return t.current===e&&(t.current=null),u},onMutate:async({dishId:n,categoryName:i})=>{await s.cancelQueries(["categoryDishes",i]);const e=s.getQueryData(["categoryDishes",i]);return s.setQueryData(["categoryDishes",i],{previousDishes:e,dishes:e.dishes.filter(u=>u.id!==n)}),{previousDishes:e,categoryName:i}},onError:(n,i,e)=>{e!=null&&e.previousDishes&&s.setQueryData(["categoryDishes",e.categoryName],e.previousDishes),alert("刪除失敗，請重整頁面後再試一次"),console.error("Delete dish error:",n)},onSettled:(n,i,e)=>{s.invalidateQueries(["categoryDishes",e.categoryName]),s.invalidateQueries(["menuCategoryList",r])}});return{deleteMenuDish:d,isError:o,isPending:l}},Q=y.lazy(()=>N(()=>import("./CartItemCardSkeleton-cC5wtZbN.js"),__vite__mapDeps([0,1,2]))),$=y.lazy(()=>N(()=>import("./MenuItemCard-cm_2l5N9.js"),__vite__mapDeps([3,1,2,4,5,6,7,8,9,10,11,12,13,14,15,16,17])));function S({sectionRefs:r,categoryData:s,menuId:t}){const{updateDishOrder:d,isPending:o}=L(t),{deleteMenuDish:l,isPending:n}=T(t);if(j(t),o)return p.jsx(Q,{});const i=async(e,u,a)=>{const m=s.find(g=>g.categoryName===e),h=m.dishes.findIndex(g=>g.id===u),c=[...m.dishes];a==="up"&&h>0?[c[h],c[h-1]]=[c[h-1],c[h]]:a==="down"&&h<c.length-1?[c[h],c[h+1]]=[c[h+1],c[h]]:a==="up"&&h===0?[c[h],c[c.length-1]]=[c[c.length-1],c[h]]:a==="down"&&h===c.length-1&&([c[h],c[0]]=[c[0],c[h]]),await d({categoryName:e,newOrder:c})};return p.jsx("div",{className:"font-notoTC relative  flex flex-col justify-start container mx-auto p-4",children:s==null?void 0:s.map((e,u)=>p.jsxs("div",{ref:a=>r.current[u]=a,className:"w-full mb-8",children:[p.jsx(E,{categoryData:e,menuId:t}),p.jsx("div",{className:"grid gap-4",children:e==null?void 0:e.dishes.map((a,m)=>p.jsx(y.Suspense,{fallback:p.jsx(Q,{}),children:p.jsx($,{categoryName:e.categoryName,food:a,onMove:i,onDelete:l})},m))})]},u))})}S.propTypes={sectionRefs:f.object.isRequired,categoryData:f.array.isRequired,menuId:f.string};export{S as default};
