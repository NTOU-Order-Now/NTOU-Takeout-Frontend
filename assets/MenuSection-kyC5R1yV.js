const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CategoryHeader-DFEjXr8S.js","assets/index-OyfSnvV0.js","assets/index-CEqBSek3.css","assets/useMutation-CvaJ0Pug.js","assets/skeleton-DmVPG9bm.js","assets/CartItemCardSkeleton-NkTc90GX.js","assets/MenuItemCard-BljAxsRH.js","assets/blur-DCF6jxGy.js","assets/blur-DOfe2hmq.css","assets/index-COzbDde_.js","assets/Menu-uH7BqscQ.js","assets/sidebarStore-_FV24hSk.js","assets/Header-Bx_nG7py.js","assets/NavbarSkeleton-DXIjei6W.js","assets/MenuSectionSkeleton-CzymON5L.js","assets/useCategoryQueries-YqjCH9Fr.js","assets/merchantMenuNav-phqT_DS4.js","assets/faEllipsis-CxEkbWIP.js","assets/useImageUploadMutation-f6U98pHh.js"])))=>i.map(i=>d[i]);
import{a as Q,A as b,b as M,u as v,r as D,_ as w,j as h,P as _}from"./index-OyfSnvV0.js";import{u as P}from"./useMutation-CvaJ0Pug.js";import{S as E}from"./skeleton-DmVPG9bm.js";const L=async(i,r,s,d)=>{const c=Q.get("authToken");try{return(await b.put(`/v2/menu/${i}/dishes`,s,{params:{category:r},signal:d,headers:{Authorization:`Bearer ${c}`}})).data}catch(u){if(M.isCancel(u)){console.debug("Update dishes order request cancelled");return}throw console.error(`Failed to update dishes order in category ${r}:`,u),u}},R=i=>{const r=v(),s=D.useRef(null),{mutateAsync:d,isError:c,isPending:u}=P({mutationFn:async({categoryName:t,newOrder:a})=>{s.current&&s.current.abort();const e=a.map(g=>g.id),l=new AbortController;s.current=l;const y=await L(i,t,e,l.signal);return s.current===l&&(s.current=null),y},onMutate:async({categoryName:t,newOrder:a})=>{await r.cancelQueries(["categoryDishes",t]);const e=r.getQueryData(["categoryDishes",t]),l={...e,dishes:a};return r.setQueryData(["categoryDishes",t],l),{previousDishes:e,categoryName:t}},onError:(t,a,e)=>{e!=null&&e.previousDishes&&r.setQueryData(["categoryDishes",e.categoryName],e.previousDishes),alert("變更錯誤，請重整後再試")},onSettled:(t,a,e)=>{r.invalidateQueries(["categoryDishes",e.categoryName])}});return{updateDishOrder:d,isError:c,isPending:u}},T=async(i,r,s)=>{const d=Q.get("authToken");try{return(await b.delete(`/v2/menu/${i}/dish/${r}`,{signal:s,headers:{Authorization:`Bearer ${d}`}})).data}catch(c){if(M.isCancel(c)){console.debug("Delete dish request cancelled");return}throw console.error(`Failed to delete dish (ID: ${r}) from menu (ID: ${i}):`,c),c}},$=i=>{const r=v(),s=D.useRef(null),{mutateAsync:d,isError:c,isPending:u}=P({mutationFn:async({dishId:t,categoryName:a})=>{s.current&&s.current.abort();const e=new AbortController;s.current=e;const l=await T(i,t,e.signal);return s.current===e&&(s.current=null),l},onMutate:async({dishId:t,categoryName:a})=>{await r.cancelQueries(["categoryDishes",a]);const e=r.getQueryData(["categoryDishes",a]);return r.setQueryData(["categoryDishes",a],{previousDishes:e,dishes:e.dishes.filter(l=>l.id!==t)}),{previousDishes:e,categoryName:a}},onError:(t,a,e)=>{e!=null&&e.previousDishes&&r.setQueryData(["categoryDishes",e.categoryName],e.previousDishes),alert("刪除失敗，請重整頁面後再試一次"),console.error("Delete dish error:",t)},onSettled:(t,a,e)=>{r.invalidateQueries(["categoryDishes",e.categoryName]),r.invalidateQueries(["menuCategoryList",i])}});return{deleteMenuDish:d,isError:c,isPending:u}},O=async(i,r,s,d)=>{const c=Q.get("authToken");try{return(await b.patch(`/v2/menu/${i}/dishes`,{categoryName:s},{params:{category:r},signal:d,headers:{Authorization:`Bearer ${c}`}})).data}catch(u){if(M.isCancel(u)){console.debug("Update category name request cancelled");return}throw console.error(`Failed to update category name from ${r} to ${s}:`,u),u}},S=i=>{const r=v(),s=D.useRef(null),{mutateAsync:d,isError:c,isPending:u}=P({mutationFn:async({oldCategoryName:t,newCategoryName:a})=>{s.current&&s.current.abort();const e=new AbortController;s.current=e;const l=await O(i,t,a,e.signal);return s.current===e&&(s.current=null),{oldCategoryName:t,newCategoryName:a,result:l}},onMutate:async({oldCategoryName:t,newCategoryName:a})=>{const e=r.getQueryData(["menuCategoryList",i]),l=r.getQueryData(["categoryDishes",t]);return r.setQueryData(["menuCategoryList",i],e.map(y=>y.categoryName===t?{...y,categoryName:a}:y)),l&&r.setQueryData(["categoryDishes",a],{categoryName:a,dishes:l.dishes.map(y=>({...y,category:a}))}),{previousMenuCategoryList:e,previousCategoryDishes:l,oldCategoryName:t}},onError:(t,a,e)=>{console.debug("varoables",a,e),e!=null&&e.previousMenuCategoryList&&r.setQueryData(["menuCategoryList",i],e.previousMenuCategoryList),e!=null&&e.previousCategoryDishes&&(r.setQueryData(["categoryDishes",e.oldCategoryName],e.previousCategoryDishes),r.removeQueries(["categoryDishes",a.newCategoryName])),alert("更新錯誤，請重整頁面後再試"),console.error("Update category name error:",t)},onSettled:t=>{r.invalidateQueries(["menuCategoryList",i]),t&&(r.invalidateQueries(["categoryDishes",t.oldCategoryName]),r.invalidateQueries(["categoryDishes",t.newCategoryName]))}});return{changeCategoryName:d,isError:c,isPending:u}},k=D.lazy(()=>w(()=>import("./CategoryHeader-DFEjXr8S.js"),__vite__mapDeps([0,1,2,3,4]))),j=D.lazy(()=>w(()=>import("./CartItemCardSkeleton-NkTc90GX.js"),__vite__mapDeps([5,1,2]))),q=D.lazy(()=>w(()=>import("./MenuItemCard-BljAxsRH.js"),__vite__mapDeps([6,1,2,7,8,9,10,11,12,13,14,15,16,17,18,3])));function A({sectionRefs:i,categoryData:r,menuId:s}){const{updateDishOrder:d,isPending:c}=R(s),{deleteMenuDish:u,isPending:t}=$(s),{isPending:a}=S(s),e=v();if(a)return h.jsx(j,{});const l=async(g,m,p)=>{const f=r.find(C=>C.categoryName===g),o=f.dishes.findIndex(C=>C.id===m),n=[...f.dishes];p==="up"&&o>0?[n[o],n[o-1]]=[n[o-1],n[o]]:p==="down"&&o<n.length-1?[n[o],n[o+1]]=[n[o+1],n[o]]:p==="up"&&o===0?[n[o],n[n.length-1]]=[n[n.length-1],n[o]]:p==="down"&&o===n.length-1&&([n[o],n[0]]=[n[0],n[o]]),await d({categoryName:g,newOrder:n})},y=e.getQueryData(["menuCategoryList",s]);return h.jsx("div",{className:"font-notoTC relative  flex flex-col justify-start container mx-auto p-4",children:r==null?void 0:r.map((g,m)=>{var p;return h.jsxs("div",{ref:f=>i.current[m]=f,className:"w-full mb-8",children:[h.jsx(D.Suspense,{fallback:h.jsx(E,{className:"w-10 h-4"}),children:h.jsx(k,{categoryName:(p=y[m])==null?void 0:p.categoryName,menuId:s})}),h.jsx("div",{className:"grid gap-4",children:g==null?void 0:g.dishes.map((f,o)=>h.jsx(D.Suspense,{fallback:h.jsx(j,{}),children:h.jsx(q,{categoryName:g.categoryName,food:f,onMove:l,onDelete:u})},o))})]},m)})})}A.propTypes={sectionRefs:_.object.isRequired,categoryData:_.array.isRequired,menuId:_.string};const U=Object.freeze(Object.defineProperty({__proto__:null,default:A},Symbol.toStringTag,{value:"Module"}));export{U as M,S as u};
