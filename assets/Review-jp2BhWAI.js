import{j as e,F as d,o as g,P as y,r as p,n as j,p as P,d as b,f as C}from"./index-CUvlouwC.js";import{a as I,u as R}from"./index-BGB-1xRi.js";import{u as S}from"./merchantStore-CIAG8v1l.js";const T=t=>{const{name:s,starNumber:n,date:r,description:c}=t;return e.jsxs("div",{className:"font-notoTC w-[90%] mx-auto mt-10 p-4 bg-white rounded-lg border border-gray-300",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-800 font-semibold",children:s}),e.jsx("span",{className:"text-gray-500 text-sm",children:r})]}),e.jsxs("div",{className:"flex items-center mt-2",children:[[...Array(n)].map((o,i)=>e.jsx(d,{icon:g,className:"text-yellow-300"},i)),[...Array(5-n)].map((o,i)=>e.jsx(d,{icon:g,className:"text-gray-300"},i))]}),e.jsx("p",{className:"mt-2 text-gray-700 leading-relaxed",children:c})]})},E={getReivewByIds:async t=>{console.log("getReviewByIds",t);const s=await fetch("https://ntou-takeout-backend-production.up.railway.app/api/v1/stores/reviews/query",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok)throw new Error(`Failed to fetch details for review ID: ${t}`);return await s.json()}},v=({reviewIdList:t,merchantId:s})=>{const{ref:r,inView:c}=I({rootMargin:"100px"}),{data:o,fetchNextPage:i,hasNextPage:x,isFetchingNextPage:l,isLoading:w}=R({queryKey:["reviewCards"+s],queryFn:async({pageParam:m})=>{const a=m*10,f=a+10,h=t.slice(a,f);if(h.length===0)return[];const N=await E.getReivewByIds(h);return console.log("reviewCards:",N),N},initialPageParam:0,getNextPageParam:(m,a)=>{const f=a.length,h=(t==null?void 0:t.length)||0;if(f*10<h)return f}});return p.useEffect(()=>{c&&x&&!l&&i()},[c,x,l,i]),w?e.jsx("div",{className:"font-notoTC w-screen flex justify-center items-center mt-4 fa-2x",children:e.jsx(d,{icon:j,spinPulse:!0,className:"flex justify-center items-center"})}):e.jsxs("div",{className:"font-notoTC flex flex-col items-center ",children:[o==null?void 0:o.pages.map(m=>m.map(a=>e.jsx(T,{name:a.userName,starNumber:a.rating,date:a.date,description:a.comment},a.id))),e.jsx("div",{ref:r,className:"my-5"}),x?e.jsx("div",{className:"flex justify-center items-center mt-4 fa-2x",children:e.jsx(d,{icon:j,spinPulse:!0})}):"No more reviews to show"]})};v.propTypes={reviewIdList:y.arrayOf(y.string).isRequired,merchantId:y.string.isRequired};const u=t=>{const{stars:s,percentage:n,count:r}=t;return e.jsxs("div",{className:"font-notoTC items-center mt-1 flex flex-row",children:[e.jsx("div",{className:"flex",children:[...Array(5)].map((c,o)=>e.jsx(d,{icon:g,className:o<s?"text-yellow-300":"text-gray-300"},o))}),e.jsx("div",{className:"w-full mr-31 bg-gray-200 rounded-full h-2.5 mx-2",children:e.jsx("div",{className:"bg-yellow-300 h-2.5 rounded-full",style:{width:`${n}%`}})}),e.jsxs("span",{className:"text-gray-700",children:["(",r,")"]})]})},k={getStoreIdList:async(t={})=>{const s=new URL("https://ntou-takeout-backend-production.up.railway.app/api/v2/stores/search");Object.keys(t).forEach(r=>{s.searchParams.append(r,t[r])});const n=await fetch(s);if(!n.ok)throw new Error("Failed to fetch store ID list");return await n.json()},getMerchantsByIdList:async t=>{if(!t||!t[0])return;const s=await fetch("https://ntou-takeout-backend-production.up.railway.app/api/v2/stores/query",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok)throw new Error(`Failed to fetch details for merchant ID: ${t}`);return await s.json()}},D=10,O=15,F=40,L=20,M=15,A=2,B=3,_=8,q=4,$=3,K=()=>{const{merchantId:t}=P(),s=S(l=>l.getMerchantById),[n,r]=p.useState(null),[c,o]=p.useState([]),i=b(),x=()=>{i(-1)};return p.useEffect(()=>{const l=s(t);l?(r(l),o(l.reviewIdList)):(async()=>{var m;try{const a=await k.getMerchantsByIdList([t]);r(a.data[0]),o(((m=a.data[0])==null?void 0:m.reviewIdList)||null)}catch(a){console.error("Failed to fetch merchant data:",a)}})()},[t,s]),!n||!c?e.jsx("div",{className:"font-notoTC flex justify-center items-center mt-4 fa-2x",children:e.jsx(d,{icon:j,spinPulse:!0})}):e.jsx("div",{className:"overflow-y-auto font-notoTC fixed top-0 left-0 w-full h-full  bg-white flex flex-col justify-start items-start",children:e.jsxs("div",{className:"w-full mt-8",children:[e.jsx("div",{className:"absolute top-4 right-4",children:e.jsx("button",{className:"text-gray-500 hover:text-gray-700",onClick:x,children:e.jsx(d,{icon:C,className:"w-8 h-8"})})}),e.jsxs("div",{className:"title flex flex-col items-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-black text-center",children:[n.name,"的評論"]}),e.jsxs("div",{className:"flex items-center mt-4 text-left",children:[e.jsx("span",{className:"text-3xl font-bold",children:Number(n.rating.toFixed(1))}),e.jsx(d,{icon:g,className:"text-yellow-300 ml-2 w-8 h-8"})]}),e.jsxs("div",{className:"mt-4 text-left w-3/4 max-w-md mx-5",children:[e.jsx(u,{stars:5,percentage:D,count:A}),e.jsx(u,{stars:4,percentage:O,count:B}),e.jsx(u,{stars:3,percentage:F,count:_}),e.jsx(u,{stars:2,percentage:L,count:q}),e.jsx(u,{stars:1,percentage:M,count:$})]})]}),e.jsx(v,{reviewIdList:c,merchantId:t})]})})};export{K as default};
