import{A as v,b as N,f as I,P as x,r as y,j as e,H as E,a as P,u as H}from"./index-Cw-wFHxr.js";import{H as U}from"./Header-CwwPu8U4.js";import{F as w,q as k}from"./index-DBIAE8Aj.js";import{B as q}from"./BusinessHoursSelector-A5C4reo9.js";import{u as S}from"./useImageUploadMutation-ByuHKHSW.js";import{u as j}from"./sidebarStore-8yPJH6Z0.js";import{u as Q}from"./useSystemContext-DFNIlIRi.js";import{u as A}from"./useMutation-1xaQ7THY.js";import{f as F}from"./faEllipsis-CxEkbWIP.js";const R=async(o,s)=>{console.debug("getStoreInfo",o,s);try{const r=await v.get(`/v2/stores/${o}`,{signal:s});return console.debug("rrrrrrrrrrrrrrrr",r.data),r.data.data}catch(r){if(N.isCancel(r)){console.debug("Get store information request cancelled");return}throw console.error(`Failed to get store information (ID: ${o}):`,r),r}},M=(o,s=!0)=>{const{data:r,isLoading:c,error:d,isError:n}=I({queryKey:["storeInformation",o],queryFn:async({signal:i})=>await R(o,i),enabled:!!o&&s,refetchOnWindowFocus:!1,staleTime:6e5});return{storeInfo:r,isLoading:c,error:d,isError:n}};function C({storeId:o,formData:s,setFormData:r,isUpdating:c,isMutationError:d}){const{storeInfo:n,isLoading:i,isError:l}=M(o);y.useEffect(()=>{n&&r(t=>({name:n.name||"",description:n.description||"",file:null,filePath:n.picture||"",address:n.address||"",phoneNumber:n.phoneNumber||"",businessHours:n.businessHours?n.businessHours.map(f=>f.map(p=>({first:p.first||"09:00",second:p.second||"18:00"}))):t.businessHours}))},[n,r]);const{uploadImage:a,isPending:m,isError:b}=S(),u=(t,f)=>{r(p=>({...p,[t]:f}))},h=async t=>{const f=t.target.files[0];if(f)try{r(g=>({...g,file:f,filePath:"上傳中..."}));const p=await a(f);r(g=>({...g,file:null,filePath:p}))}catch(p){console.error("上傳圖片失敗:",p),r(g=>({...g,file:null,filePath:g.filePath}))}};return i?e.jsx(E,{}):l||d?e.jsx("div",{className:"flex flex-col justify-center items-center",children:"載入發生錯誤"}):e.jsx("div",{className:"p-4 max-w-screen",children:e.jsxs("form",{className:"p-4 space-y-4 font-semibold font-notoTC",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家名稱："}),e.jsx("input",{type:"text",value:s.name,onChange:t=>u("name",t.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家名稱"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家描述："}),e.jsx("textarea",{rows:"3",value:s.description,onChange:t=>u("description",t.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家描述"})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"圖片："}),e.jsxs("div",{className:"flex items-center w-full space-x-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",value:s.filePath,readOnly:!0,className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"請選擇圖片"})}),e.jsx("div",{className:"flex-none w-30",children:e.jsxs("label",{htmlFor:"file-upload",className:"bg-orange-500 text-white px-4 py-2 rounded-lg cursor-pointer whitespace-nowrap",children:[e.jsx(w,{icon:k,className:"mr-1"}),"上傳圖片"]})}),e.jsx("input",{id:"file-upload",type:"file",className:"hidden",onChange:h})]}),s.filePath&&!m&&e.jsx("img",{src:s.filePath,alt:"預覽圖片",className:"right-2 top-1 mt-2 object-cover rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家地址："}),e.jsx("input",{type:"text",value:s.address,onChange:t=>u("address",t.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家地址"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家電話："}),e.jsx("input",{type:"number",value:s.phoneNumber,onChange:t=>u("phoneNumber",t.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家電話"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"營業時間："}),e.jsx(q,{businessHours:s.businessHours,onUpdate:t=>u("businessHours",t)})]})]})})}C.propTypes={storeId:x.string.isRequired,formData:x.object.isRequired,setFormData:x.func.isRequired,isUpdating:x.bool,isMutationError:x.bool.isRequired};const T=async({storeId:o,name:s,picture:r,address:c,description:d,businessHours:n},i)=>{const l=P.get("authToken");try{return(await v.put(`/v2/stores/${o}`,{name:s,picture:r,address:c,description:d,businessHours:n},{signal:i,headers:{Authorization:`Bearer ${l}`}})).data}catch(a){if(N.isCancel(a)){console.debug("Update store information request cancelled");return}throw console.error(`Failed to update store information (ID: ${o}):`,a),a}},$=o=>{const s=H(),r=y.useRef(null),{mutateAsync:c,isError:d,isPending:n}=A({mutationFn:async({name:i,picture:l,address:a,description:m,businessHours:b})=>{console.debug("updateStoreInformation",{name:i,picture:l,address:a,description:m,businessHours:b}),r.current&&r.current.abort();const u=new AbortController;r.current=u;const h=await T({storeId:o,name:i,picture:l,address:a,description:m,businessHours:b},u.signal);return r.current===u&&(r.current=null),h},onMutate:async i=>{await s.cancelQueries(["storeInformation",o]);const l=s.getQueryData(["storeInformation",o]);return s.setQueryData(["storeInformation",o],{...l,...i}),{previousStoreData:l}},onError:(i,l,a)=>{console.debug("variables",l,a),a!=null&&a.previousStoreData&&s.setQueryData(["storeInformation",o],a.previousStoreData),alert("更新錯誤，請重整頁面後再試"),console.error("Update store information error:",i)},onSettled:()=>{s.invalidateQueries(["storeInformation",o])}});return{updateStore:c,isError:d,isPending:n}},V=()=>{const o=j(t=>t.title),s=j(t=>t.toggleSidebar),{userInfo:r}=Q(),[c,d]=y.useState({name:"",description:"",file:null,filePath:"",address:"",phoneNumber:"",businessHours:Array(7).fill().map(()=>Array(2).fill().map(()=>({first:"09:00",second:"18:00"})))}),{updateStore:n,isPending:i,isError:l}=$(r==null?void 0:r.storeId),{uploadImage:a,isPending:m,isError:b}=S(),u=async t=>{t.preventDefault();try{await n({name:c.name,picture:c.filePath,address:c.address,description:c.description,businessHours:c.businessHours})}catch(f){console.error("提交表單時發生錯誤:",f)}},h=e.jsx("button",{onClick:u,className:" bg-orange-500 text-white rounded-lg px-3 py-1 font-sm shadow-md relative right-4  w-[60px]",children:i||m?e.jsx(w,{icon:F.faEllipsis,beatFade:!0,size:"lg"}):"儲存"});return e.jsxs("div",{className:"flex flex-col h-screen",children:[e.jsx(U,{title:o,onLeftClick:s,rightComponents:[h]}),e.jsx("div",{className:"sticky top-[54px] mt-[54px] z-20 ",children:e.jsx(C,{storeId:r==null?void 0:r.storeId,formData:c,setFormData:d,isUpdating:i,isMutationError:l})})]})};export{V as default};
