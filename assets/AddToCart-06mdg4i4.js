const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ConfirmClearCartModal-lIGt1Jk3.js","assets/index-CFrlWo3n.js","assets/index-CO-7yoI2.css"])))=>i.map(i=>d[i]);
import{a as y,A as b,b as A,u as D,r as h,_ as M,j as f,P as m}from"./index-CFrlWo3n.js";import{u as E}from"./useMutation-DcNzvGfk.js";import{u as S}from"./useSystemContext-Cf21cK5y.js";import{u as p}from"./MenuDishDetail-xmf-MN6C.js";import"./blur-B0sOPoAv.js";const Q=async s=>{try{const t=y.get("authToken");return(await b.delete("/v1/cart",{headers:{Authorization:`Bearer ${t}`},signal:s})).data}catch(t){if(A.isCancel(t)){console.debug("DELETE cart request cancelled");return}else console.error("DELETE cart error:",t);throw t}},R=async(s,t)=>{try{const n=y.get("authToken");return(await b.post("/v1/cart/dishes",t,{headers:{Authorization:`Bearer ${n}`},signal:s})).data}catch(n){if(A.isCancel(n)){console.debug("POST cart request cancelled");return}else console.error("POST cart error:",n);throw n}},g=()=>{const s=D(),t=h.useRef(null),{mutateAsync:n,onError:a,onMutate:l,isError:d}=E({mutationFn:async r=>{t.current&&t.current.abort();const i=new AbortController;t.current=i;const e=await R(t.current.signal,r);return t.current===i&&(t.current=null),e},onMutate:async r=>{await s.cancelQueries(["cart"]);const i=s.getQueryData(["cart"]),e=i?{...i}:{orderedDishes:[]};e.orderedDishes||(e.orderedDishes=[]);const c=e.orderedDishes.findIndex(o=>o.dishId===r.dishId&&o.chosenAttributes===r.chosenAttributes);if(c>-1){const o=e.orderedDishes[c];e.orderedDishes=[...e.orderedDishes.slice(0,c),{...o,quantity:o.quantity+r.quantity,note:r.note||o.note},...e.orderedDishes.slice(c+1)]}else e.orderedDishes.push({id:crypto.randomUUID(),dishId:r.dishId,dishName:r.dishName,price:r.price,quantity:r.quantity,note:r.note||"",chosenAttributes:r.chosenAttributes||[],storeId:r.storeId});return s.setQueryData(["cart"],e),{previousCart:i}},onError:(r,i,e)=>{throw e!=null&&e.previousCart&&s.setQueryData(["cart"],e.previousCart),alert("新增購物車失敗，請稍後再試"),r},onSettled:()=>{console.debug("patchCartAsync onSettled"),s.invalidateQueries(["cart"])}});return{postCartAsync:n,postCartError:a,postCartOnMutate:l,postCartIsError:d}},O=()=>{const s=D(),t=h.useRef(null),{postCartAsync:n}=g(),{mutateAsync:a,onError:l,onSuccess:d,onMutate:r,isError:i}=E({mutationFn:async e=>{t.current&&t.current.abort();const c=new AbortController;return t.current=c,await Q(t.current.signal),t.current===c&&(t.current=null),e},onMutate:async()=>{await s.cancelQueries(["cart"]);const e=s.getQueryData(["cart"]);return e&&{...e},console.debug("previousCart",e),s.setQueryData(["cart"],[]),{previousCart:e}},onSuccess:e=>{n(e)},onError:(e,c,o)=>{throw o!=null&&o.previousCart&&s.setQueryData(["cart"],o.previousCart),alert("刪除購物車失敗，請稍後再試"),e},onSettled:()=>{console.debug("deleteCartAsync onSettled"),s.invalidateQueries(["cart"])}});return{deleteCartAsync:a,deleteCartSuccess:d,deleteCartError:l,deleteCartOnMutate:r,deleteCartIsError:i}},_=h.lazy(()=>M(()=>import("./ConfirmClearCartModal-lIGt1Jk3.js"),__vite__mapDeps([0,1,2]))),x=({dishId:s,onRequiredMissing:t,onClose:n})=>{const{cartData:a}=S(),[l,d]=h.useState(!1),r=p(u=>u.dishes),i=p(u=>u.allDishAttributes),{deleteCartAsync:e}=O(),{postCartAsync:c}=g(),o=async()=>{d(!1);const u=r[s];await e(u),n()},w=()=>{d(!1)},v=async()=>{const u=r[s];if(!u)return;const I=u.chosenAttributes||[],q=i[s]||[];for(const C of q)if(C.isRequired===!0&&I.filter(T=>T.attributeName===C.name).length===0){t(C.name);return}if(a!=null&&a.storeId&&(a==null?void 0:a.storeId)!==u.storeId){d(!0);return}await c(u),n()};return f.jsxs("div",{className:"flex items-center justify-center",children:[f.jsx("button",{className:"shadow-md bg-orange-500 text-white text-md px-6 py-2 rounded-full border border-orange-700 font-notoTC",onClick:v,children:"加入"}),f.jsx(_,{isOpen:l,onCancel:w,onConfirm:o})]})};x.propTypes={dishId:m.string.isRequired,onRequiredMissing:m.func.isRequired,onClose:m.func.isRequired};export{x as default};
