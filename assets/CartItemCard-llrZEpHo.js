import{a as w,A as N,b as v,u as A,r as C,P as a,j as t}from"./index-DsRyyW-m.js";import{u as q}from"./useMutation-BthwnVr5.js";import{F as D,v as Q}from"./index-D7_j1ucI.js";import{b as E}from"./blur-CmM0UiMk.js";const R=async(n,o,u)=>{try{const c=w.get("authToken");return(await N.patch(`/v1/cart/dishes/${n}`,o,{headers:{Authorization:`Bearer ${c}`},signal:u})).data}catch(c){if(v.isCancel(c)){console.debug("PATCH cart request cancelled");return}else throw console.error("PATCH cart error; ",c),c}},k=()=>{const n=A(),o=C.useRef(null),{mutateAsync:u,onError:c,onMutate:p,isError:h}=q({mutationFn:async({orderedDishId:l,newQuantity:i})=>{o.current&&(console.debug("Abort previous patchCart request"),o.current.abort());const e=new AbortController;o.current=e;const s={quantity:i.toString()},r=await R(l,s,o.current.signal);return o.current===e&&(o.current=null),r},onMutate:async({orderedDishId:l,newQuantity:i})=>{await n.cancelQueries(["cart"]);const e=n.getQueryData(["cart"]),s=e?{...e}:{orderedDishes:[]};return s.orderedDishes||(s.orderedDishes=[]),i===0?s.orderedDishes=s.orderedDishes.filter(r=>r.id!==l):s.orderedDishes=s.orderedDishes.map(r=>r.id===l?{...r,quantity:i}:r),n.setQueryData(["cart"],s),{previousCart:e}},onError:(l,i,e)=>{throw e!=null&&e.previousCart&&(console.debug("rollback to previous cart",e),n.setQueryData(["cart"],e.previousCart)),alert("更新數量失敗，請稍後再試"),l},onSettled:()=>{console.debug("patchCartAsync onSettled"),n.invalidateQueries(["cart"])}});return{patchCartAsync:u,patchCartError:c,patchCartOnMutate:p,ispatchCartError:h}},T=({dishData:n,imageUrl:o,showAdjustBtn:u=!0})=>{const{dishId:c,id:p,dishName:h,price:l,quantity:i,chosenAttributes:e,note:s}=n,[r,b]=C.useState(i),{patchCartAsync:g}=k(),y=async m=>{const d=r+m;if(!(d<0||d>25)){d>0&&b(d);try{await g({orderedDishId:p,newQuantity:d})}catch(j){console.debug("patchCartAsync error:",j),b(i)}}};let x=0;const f=e!=null&&e.length?e.map(m=>(x+=m.extraCost||0,m.chosenOption)).join(", "):"";return r<=0?null:t.jsxs("div",{className:"relative flex rounded-lg p-4 w-full items-start min-h-[142px]",children:[o&&t.jsx(E.LazyLoadImage,{src:o,alt:h,className:"w-20 h-26 object-cover rounded-lg flex-shrink-0",effect:"blur",wrapperClassName:"flex-shrink-0"}),t.jsxs("div",{className:"ml-4 flex min-w-0 flex-col h-full",children:[t.jsx("h2",{className:"text-lg font-semibold truncate",children:h}),f&&t.jsxs("p",{className:"text-sm text-gray-500 truncate",children:["+$",x," : ",f]}),s&&t.jsx("p",{className:"text-sm text-gray-500 line-clamp-2",children:s}),t.jsxs("p",{className:"text-xl mt-2 absolute bottom-[15px] font-semibold",children:["$ ",(l+x)*r]})]}),u?t.jsxs("div",{className:"absolute bottom-[15px] right-[15px] flex items-end border border-gray-300 rounded-md",children:[t.jsx("button",{onClick:()=>y(-1),className:"px-2 py-0 text-lg rounded-l-md w-7",children:i<=1?t.jsx(D,{icon:Q,size:"xs",style:{color:"#d00b0b"}}):"-"}),t.jsx("span",{className:"px-4 py-0.5",children:r}),t.jsx("button",{onClick:()=>y(1),className:"px-2 py-0 text-lg rounded-r-md w-7",children:"+"})]}):t.jsx("div",{className:"absolute bottom-[21px] right-[15px]",children:t.jsxs("span",{className:"px-4 font-extrabold text-sm bg-gray-200 rounded-md text-black py-2",children:["數量： ",r]})})]})};T.propTypes={dishData:a.shape({id:a.string.isRequired,dishId:a.string.isRequired,dishName:a.string.isRequired,price:a.number.isRequired,quantity:a.number.isRequired,chosenAttributes:a.arrayOf(a.shape({name:a.string})),note:a.string}).isRequired,imageUrl:a.string,showAdjustBtn:a.bool};export{T as C,k as u};
