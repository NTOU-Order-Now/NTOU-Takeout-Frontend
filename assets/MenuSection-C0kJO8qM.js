const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CartItemCardSkeleton-t-PeHlN1.js","assets/index-CFrlWo3n.js","assets/index-CO-7yoI2.css","assets/MenuItemCard-DHuN-aK8.js","assets/blur-B0sOPoAv.js","assets/blur-DOfe2hmq.css","assets/Menu-CbhUNeHE.js","assets/sidebarStore-JTAWPSbi.js","assets/Header-CdveAT2q.js","assets/NavbarSkeleton-CQcu5wyZ.js","assets/MenuSectionSkeleton-ZqPEuH_5.js","assets/useCategoryQueries-C-dpPC4Q.js","assets/merchantMenuNav-CbP8-yYk.js","assets/useMutation-DcNzvGfk.js","assets/useSystemContext-Cf21cK5y.js"])))=>i.map(i=>d[i]);
import{r as m,a as C,A as w,b,u as D,P as y,j as p,_ as k}from"./index-CFrlWo3n.js";import{u as N}from"./useMutation-DcNzvGfk.js";/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _=s=>s.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),E=(...s)=>s.filter((e,t,l)=>!!e&&e.trim()!==""&&l.indexOf(e)===t).join(" ").trim();/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var A={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const L=m.forwardRef(({color:s="currentColor",size:e=24,strokeWidth:t=2,absoluteStrokeWidth:l,className:u="",children:a,iconNode:n,...i},r)=>m.createElement("svg",{ref:r,...A,width:e,height:e,stroke:s,strokeWidth:l?Number(t)*24/Number(e):t,className:E("lucide",u),...i},[...n.map(([o,c])=>m.createElement(o,c)),...Array.isArray(a)?a:[a]]));/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=(s,e)=>{const t=m.forwardRef(({className:l,...u},a)=>m.createElement(L,{ref:a,iconNode:e,className:E(`lucide-${_(s)}`,l),...u}));return t.displayName=`${s}`,t};/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $=M("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=M("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),x=async(s,e,t,l)=>{const u=C.get("authToken");try{return(await w.patch(`/v2/menu/${s}/dishes`,{categoryName:t},{params:{category:e},signal:l,headers:{Authorization:`Bearer ${u}`}})).data}catch(a){if(b.isCancel(a)){console.debug("Update category name request cancelled");return}throw console.error(`Failed to update category name from ${e} to ${t}:`,a),a}},j=s=>{const e=D(),t=m.useRef(null),{mutateAsync:l,isError:u,isPending:a}=N({mutationFn:async({oldCategoryName:n,newCategoryName:i})=>{console.debug("changeCategoryName",n,i),t.current&&t.current.abort();const r=new AbortController;t.current=r;const o=await x(s,n,i,r.signal);return t.current===r&&(t.current=null),{oldCategoryName:n,newCategoryName:i,result:o}},onMutate:async({oldCategoryName:n,newCategoryName:i})=>{await Promise.all([e.cancelQueries(["menuCategoryList",s]),e.cancelQueries(["categoryDishes",n])]);const r=e.getQueryData(["menuCategoryList",s]),o=e.getQueryData(["categoryDishes",n]);return e.setQueryData(["menuCategoryList",s],r.map(c=>c.categoryName===n?{...c,categoryName:i}:c)),o&&(e.removeQueries(["categoryDishes",n]),e.setQueryData(["categoryDishes",i],o)),{previousMenuCategoryList:r,previousCategoryDishes:o,oldCategoryName:n}},onError:(n,i,r)=>{console.debug("varoables",i,r),r!=null&&r.previousMenuCategoryList&&e.setQueryData(["menuCategoryList",s],r.previousMenuCategoryList),r!=null&&r.previousCategoryDishes&&(e.setQueryData(["categoryDishes",r.oldCategoryName],r.previousCategoryDishes),e.removeQueries(["categoryDishes",i.newCategoryName])),alert("更新錯誤，請重整頁面後再試"),console.error("Update category name error:",n)},onSettled:n=>{e.invalidateQueries(["menuCategoryList",s]),n&&(e.invalidateQueries(["categoryDishes",n.oldCategoryName]),e.invalidateQueries(["categoryDishes",n.newCategoryName]))}});return{changeCategoryName:l,isError:u,isPending:a}},P=({categoryData:s,menuId:e})=>{const[t,l]=m.useState(!1),[u,a]=m.useState((s==null?void 0:s.categoryName)||"未命名類別"),{changeCategoryName:n}=j(e);m.useEffect(()=>{a((s==null?void 0:s.categoryName)||"未命名類別")},[s]);const i=async c=>{if(c.preventDefault(),c.stopPropagation(),u.trim()!==""&&u.trim()!==(s==null?void 0:s.categoryName))try{await n({oldCategoryName:s==null?void 0:s.categoryName,newCategoryName:u.trim()})}catch(f){console.error("Failed to update category name:",f)}else u.trim()===""&&alert("不可為空");l(!1)},r=async c=>{c.key==="Enter"?await i(c):c.key==="Escape"&&(a((s==null?void 0:s.categoryName)||"未命名類別"),l(!1))},o=()=>{t?i():l(!0)};return p.jsxs("div",{className:"flex items-center gap-2 py-3 ",children:[t?p.jsx("input",{type:"text",value:u,onChange:c=>a(c.target.value),onBlur:i,onKeyDown:r,className:"border-b-2 border-gray-400 focus:border-blue-500 focus:outline-none text-2xl font-bold px-1 bg-transparent h-10",autoFocus:!0}):p.jsx("h2",{className:"text-2xl font-bold h-10 flex items-center px-1",children:(s==null?void 0:s.categoryName)||"未命名類別"}),p.jsx("button",{onClick:o,className:"p-2 hover:bg-gray-100 rounded-full transition-colors right-3 relative",title:t?"儲存":"編輯",children:t?p.jsx(R,{className:"w-5 h-5 text-blue-600"}):p.jsx($,{className:"w-5 h-5 text-gray-600"})})]})};P.propTypes={categoryData:y.shape({categoryName:y.string,dishes:y.array}),menuId:y.string.isRequired};const T=async(s,e,t,l)=>{const u=C.get("authToken");try{return(await w.put(`/v2/menu/${s}/dishes`,t,{params:{category:e},signal:l,headers:{Authorization:`Bearer ${u}`}})).data}catch(a){if(b.isCancel(a)){console.debug("Update dishes order request cancelled");return}throw console.error(`Failed to update dishes order in category ${e}:`,a),a}},S=s=>{const e=D(),t=m.useRef(null),{mutateAsync:l,isError:u,isPending:a}=N({mutationFn:async({categoryName:n,newOrder:i})=>{t.current&&t.current.abort();const r=i.map(f=>f.id),o=new AbortController;t.current=o;const c=await T(s,n,r,o.signal);return t.current===o&&(t.current=null),c},onMutate:async({categoryName:n,newOrder:i})=>{await e.cancelQueries(["categoryDishes",n]);const r=e.getQueryData(["categoryDishes",n]),o={...r,dishes:i};return e.setQueryData(["categoryDishes",n],o),{previousDishes:r,categoryName:n}},onError:(n,i,r)=>{r!=null&&r.previousDishes&&e.setQueryData(["categoryDishes",r.categoryName],r.previousDishes),alert("變更錯誤，請重整後再試")},onSettled:(n,i,r)=>{e.invalidateQueries(["categoryDishes",r.categoryName])}});return{updateDishOrder:l,isError:u,isPending:a}},O=async(s,e,t)=>{const l=C.get("authToken");try{return(await w.delete(`/v2/menu/${s}/dish/${e}`,{signal:t,headers:{Authorization:`Bearer ${l}`}})).data}catch(u){if(b.isCancel(u)){console.debug("Delete dish request cancelled");return}throw console.error(`Failed to delete dish (ID: ${e}) from menu (ID: ${s}):`,u),u}},q=s=>{const e=D(),t=m.useRef(null),{mutateAsync:l,isError:u,isPending:a}=N({mutationFn:async({dishId:n,categoryName:i})=>{t.current&&t.current.abort();const r=new AbortController;t.current=r;const o=await O(s,n,r.signal);return t.current===r&&(t.current=null),o},onMutate:async({dishId:n,categoryName:i})=>{await e.cancelQueries(["categoryDishes",i]);const r=e.getQueryData(["categoryDishes",i]);return e.setQueryData(["categoryDishes",i],{previousDishes:r,dishes:r.dishes.filter(o=>o.id!==n)}),{previousDishes:r,categoryName:i}},onError:(n,i,r)=>{r!=null&&r.previousDishes&&e.setQueryData(["categoryDishes",r.categoryName],r.previousDishes),alert("刪除失敗，請重整頁面後再試一次"),console.error("Delete dish error:",n)},onSettled:(n,i,r)=>{e.invalidateQueries(["categoryDishes",r.categoryName]),e.invalidateQueries(["menuCategoryList",s])}});return{deleteMenuDish:l,isError:u,isPending:a}},Q=m.lazy(()=>k(()=>import("./CartItemCardSkeleton-t-PeHlN1.js"),__vite__mapDeps([0,1,2]))),F=m.lazy(()=>k(()=>import("./MenuItemCard-DHuN-aK8.js"),__vite__mapDeps([3,1,2,4,5,6,7,8,9,10,11,12,13,14])));function z({sectionRefs:s,categoryData:e,menuId:t}){const{updateDishOrder:l,isPending:u}=S(t),{deleteMenuDish:a,isPending:n}=q(t),{isPending:i}=j(t);if(i||n)return p.jsx(Q,{});const r=async(o,c,f)=>{const g=e.find(v=>v.categoryName===o),h=g.dishes.findIndex(v=>v.id===c),d=[...g.dishes];f==="up"&&h>0?[d[h],d[h-1]]=[d[h-1],d[h]]:f==="down"&&h<d.length-1?[d[h],d[h+1]]=[d[h+1],d[h]]:f==="up"&&h===0?[d[h],d[d.length-1]]=[d[d.length-1],d[h]]:f==="down"&&h===d.length-1&&([d[h],d[0]]=[d[0],d[h]]),await l({categoryName:o,newOrder:d})};return p.jsx("div",{className:"font-notoTC relative min-h-screen flex flex-col justify-center container mx-auto p-4",children:e==null?void 0:e.map((o,c)=>p.jsxs("div",{ref:f=>s.current[c]=f,className:"w-full mb-8",children:[p.jsx(P,{categoryData:o,menuId:t}),p.jsx("div",{className:"grid gap-4",children:o==null?void 0:o.dishes.map((f,g)=>p.jsx(m.Suspense,{fallback:p.jsx(Q,{}),children:p.jsx(F,{categoryName:o.categoryName,food:f,onMove:r,onDelete:a})},g))})]},c))})}z.propTypes={sectionRefs:y.object.isRequired,categoryData:y.array.isRequired,menuId:y.string};export{z as default};
