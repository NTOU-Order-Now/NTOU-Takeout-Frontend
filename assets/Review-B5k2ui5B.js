import{j as e,F as d,E as p,P as y,r as g,z as j,k as P,G as b,d as C,f as I}from"./index-Bejcf61O.js";import{a as R,u as S}from"./index-C9sSlQ-j.js";const E=t=>{const{name:s,starNumber:a,date:c,description:o}=t;return e.jsxs("div",{className:"font-notoTC w-[90%] mx-auto mt-10 p-4 bg-white rounded-lg border border-gray-300",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-800 font-semibold",children:s}),e.jsx("span",{className:"text-gray-500 text-sm",children:c})]}),e.jsxs("div",{className:"flex items-center mt-2",children:[[...Array(a)].map((r,i)=>e.jsx(d,{icon:p,className:"text-yellow-300"},i)),[...Array(5-a)].map((r,i)=>e.jsx(d,{icon:p,className:"text-gray-300"},i))]}),e.jsx("p",{className:"mt-2 text-gray-700 leading-relaxed",children:o})]})},T={getReivewByIds:async t=>{console.log("getReviewByIds",t);const s=await fetch("https://ntou-takeout-backend-production.up.railway.app/api/v1/stores/reviews/query",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok)throw new Error(`Failed to fetch details for review ID: ${t}`);return await s.json()}},v=({reviewIdList:t,merchantId:s})=>{const{ref:c,inView:o}=R({rootMargin:"100px"}),{data:r,fetchNextPage:i,hasNextPage:x,isFetchingNextPage:l,isLoading:w}=S({queryKey:["reviewCards"+s],queryFn:async({pageParam:m})=>{const n=m*10,h=n+10,f=t.slice(n,h);if(f.length===0)return[];const N=await T.getReivewByIds(f);return console.log("reviewCards:",N),N},initialPageParam:0,getNextPageParam:(m,n)=>{const h=n.length,f=(t==null?void 0:t.length)||0;if(h*10<f)return h}});return g.useEffect(()=>{o&&x&&!l&&i()},[o,x,l,i]),w?e.jsx("div",{className:"font-notoTC w-screen flex justify-center items-center mt-4 fa-2x",children:e.jsx(d,{icon:j,spinPulse:!0,className:"flex justify-center items-center"})}):e.jsxs("div",{className:"font-notoTC flex flex-col items-center ",children:[r==null?void 0:r.pages.map(m=>m.map(n=>e.jsx(E,{name:n.userName,starNumber:n.rating,date:n.date,description:n.comment},n.id))),e.jsx("div",{ref:c,className:"my-5"}),x?e.jsx("div",{className:"flex justify-center items-center mt-4 fa-2x",children:e.jsx(d,{icon:j,spinPulse:!0})}):"No more reviews to show"]})};v.propTypes={reviewIdList:y.arrayOf(y.string).isRequired,merchantId:y.string.isRequired};const u=t=>{const{stars:s,percentage:a,count:c}=t;return e.jsxs("div",{className:"font-notoTC items-center mt-1 flex flex-row",children:[e.jsx("div",{className:"flex",children:[...Array(5)].map((o,r)=>e.jsx(d,{icon:p,className:r<s?"text-yellow-300":"text-gray-300"},r))}),e.jsx("div",{className:"w-full mr-31 bg-gray-200 rounded-full h-2.5 mx-2",children:e.jsx("div",{className:"bg-yellow-300 h-2.5 rounded-full",style:{width:`${a}%`}})}),e.jsxs("span",{className:"text-gray-700",children:["(",c,")"]})]})},k={getStoreIdList:async(t={})=>{const s=new URL("https://ntou-takeout-backend-production.up.railway.app/api/v2/stores/search");Object.keys(t).forEach(c=>{s.searchParams.append(c,t[c])});const a=await fetch(s);if(!a.ok)throw new Error("Failed to fetch store ID list");return await a.json()},getMerchantsByIdList:async t=>{if(!t||!t[0])return;const s=await fetch("https://ntou-takeout-backend-production.up.railway.app/api/v2/stores/query",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok)throw new Error(`Failed to fetch details for merchant ID: ${t}`);return await s.json()}},M=P((t,s)=>({merchants:{},addMerchants:a=>t(c=>({merchants:{...c.merchants,...a.reduce((o,r)=>(o[r.id]=r,o),{})}})),getMerchantById:a=>s().merchants[a]||null})),D=10,O=15,B=40,F=20,L=15,A=2,_=3,q=8,$=4,Z=3,z=()=>{const{merchantId:t}=b(),s=M(l=>l.getMerchantById),[a,c]=g.useState(null),[o,r]=g.useState([]),i=C(),x=()=>{i(-1)};return g.useEffect(()=>{const l=s(t);l?(c(l),r(l.reviewIdList)):(async()=>{var m;try{const n=await k.getMerchantsByIdList([t]);c(n.data[0]),r(((m=n.data[0])==null?void 0:m.reviewIdList)||null)}catch(n){console.error("Failed to fetch merchant data:",n)}})()},[t,s]),!a||!o?e.jsx("div",{className:"font-notoTC flex justify-center items-center mt-4 fa-2x",children:e.jsx(d,{icon:j,spinPulse:!0})}):e.jsx("div",{className:"overflow-y-auto font-notoTC fixed top-0 left-0 w-full h-full  bg-white flex flex-col justify-start items-start",children:e.jsxs("div",{className:"w-full mt-8",children:[e.jsx("div",{className:"absolute top-4 right-4",children:e.jsx("button",{className:"text-gray-500 hover:text-gray-700",onClick:x,children:e.jsx(d,{icon:I,className:"w-8 h-8"})})}),e.jsxs("div",{className:"title flex flex-col items-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-black text-center",children:[a.name,"的評論"]}),e.jsxs("div",{className:"flex items-center mt-4 text-left",children:[e.jsx("span",{className:"text-3xl font-bold",children:Number(a.rating.toFixed(1))}),e.jsx(d,{icon:p,className:"text-yellow-300 ml-2 w-8 h-8"})]}),e.jsxs("div",{className:"mt-4 text-left w-3/4 max-w-md mx-5",children:[e.jsx(u,{stars:5,percentage:D,count:A}),e.jsx(u,{stars:4,percentage:O,count:_}),e.jsx(u,{stars:3,percentage:B,count:q}),e.jsx(u,{stars:2,percentage:F,count:$}),e.jsx(u,{stars:1,percentage:L,count:Z})]})]}),e.jsx(v,{reviewIdList:o,merchantId:t})]})})};export{z as default};
