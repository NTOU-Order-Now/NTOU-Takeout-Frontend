import{P as m,j as e,A as w,b as S,h as k,r as j,H as I,a as U,u as T,c as q}from"./index-OyfSnvV0.js";import{H as R}from"./Header-Bx_nG7py.js";import{F as y,d as $,n as F}from"./index-COzbDde_.js";import{u as C}from"./useImageUploadMutation-f6U98pHh.js";import{u as N}from"./sidebarStore-_FV24hSk.js";import{u as Q}from"./useMutation-CvaJ0Pug.js";import{f as A}from"./faEllipsis-CxEkbWIP.js";const v=()=>{const r=[];for(let t=0;t<24;t++){const s=t.toString().padStart(2,"0");r.push(e.jsx("option",{value:`${s}:00`,children:`${s}:00`},`${t}:00`)),r.push(e.jsx("option",{value:`${s}:30`,children:`${s}:30`},`${t}:30`))}return r},E=({value:r,onChange:t,label:s})=>{const l=c=>c?c.split(":").slice(0,2).join(":"):"";return e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-gray-600",children:s}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"開始時間"}),e.jsxs("select",{value:l(r==null?void 0:r.first),onChange:c=>t("start",c.target.value),className:`w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm
                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                     text-gray-700 bg-white text-sm`,children:[e.jsx("option",{value:"",children:"選擇時間"}),v()]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"結束時間"}),e.jsxs("select",{value:l(r==null?void 0:r.second),onChange:c=>t("end",c.target.value),className:`w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm
                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                     text-gray-700 bg-white text-sm`,children:[e.jsx("option",{value:"",children:"選擇時間"}),v()]})]})]})]})};E.propTypes={value:m.shape({first:m.string,second:m.string}),onChange:m.func.isRequired,label:m.string};const H=({businessHours:r,onUpdate:t})=>{const s=["星期一","星期二","星期三","星期四","星期五","星期六","星期日"],l=["午段","晚段"],c=(o,i,u,a)=>{const g=r.map((h,d)=>d===o?h.map((f,n)=>{if(n===i){const p=u==="start"?"first":"second";return{first:p==="first"?a:f.first,second:p==="second"?a:f.second}}return{...f}}):h.map(f=>({...f})));t(g)};return e.jsx("div",{className:"w-full flex flex-col p-3 bg-white rounded-lg font-notoTC",children:e.jsx("div",{className:"space-y-4",children:s.map((o,i)=>e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"font-medium text-gray-700 mb-4",children:o}),e.jsx("div",{className:"space-y-4",children:l.map((u,a)=>e.jsx(E,{label:u,value:r[i][a],onChange:(g,h)=>c(i,a,g,h)},u))})]},o))})})};H.propTypes={businessHours:m.array.isRequired,onUpdate:m.func.isRequired};const M=async(r,t)=>{console.debug("getStoreInfo",r,t);try{return(await w.get(`/v2/stores/${r}`,{signal:t})).data.data}catch(s){if(S.isCancel(s)){console.debug("Get store information request cancelled");return}throw console.error(`Failed to get store information (ID: ${r}):`,s),s}},L=(r,t=!0)=>{const{data:s,isLoading:l,error:c,isError:o}=k({queryKey:["storeInformation",r],queryFn:async({signal:i})=>await M(r,i),enabled:!!r&&t,refetchOnWindowFocus:!1,staleTime:6e5});return{storeInfo:s,isLoading:l,error:c,isError:o}};function P({storeId:r,formData:t,setFormData:s,isUpdating:l,isMutationError:c}){const{storeInfo:o,isLoading:i,isError:u}=L(r);j.useEffect(()=>{o&&s(n=>({name:o.name||"",description:o.description||"",file:null,filePath:o.picture||"",address:o.address||"",phoneNumber:o.phoneNumber||"",businessHours:o.businessHours?o.businessHours.map(p=>p.map(x=>({first:x.first||"09:00",second:x.second||"18:00"}))):n.businessHours}))},[o,s]);const{uploadImage:a,isPending:g,isError:h}=C(),d=(n,p)=>{s(x=>({...x,[n]:p}))},f=async n=>{const p=n.target.files[0];if(p)try{s(b=>({...b,file:p,filePath:"上傳中..."}));const x=await a(p);s(b=>({...b,file:null,filePath:x}))}catch(x){console.error("上傳圖片失敗:",x),s(b=>({...b,file:null,filePath:b.filePath}))}};return i?e.jsx(I,{}):u||c?e.jsx("div",{className:"flex flex-col justify-center items-center",children:"載入發生錯誤"}):e.jsx("div",{className:"p-4 max-w-screen",children:e.jsxs("form",{className:"p-4 space-y-4 font-semibold font-notoTC",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家名稱："}),e.jsx("input",{type:"text",value:t.name,onChange:n=>d("name",n.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家名稱"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家描述："}),e.jsx("textarea",{rows:"3",value:t.description,onChange:n=>d("description",n.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家描述"})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"圖片："}),e.jsxs("div",{className:"flex items-center w-full space-x-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",value:t.filePath,readOnly:!0,className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"請選擇圖片"})}),e.jsx("div",{className:"flex-none w-30",children:g?e.jsxs("label",{htmlFor:"file-upload",className:"bg-gray-500 text-white px-4 py-2 rounded-lg cursor-pointer whitespace-nowrap",children:[e.jsx(y,{icon:$,className:"mr-2 animate-spin"}),"上傳中"]}):e.jsxs("label",{htmlFor:"file-upload",className:"bg-orange-500 text-white px-4 py-2 rounded-lg cursor-pointer whitespace-nowrap",children:[e.jsx(y,{icon:F,className:"mr-1"}),"上傳圖片"]})}),e.jsx("input",{id:"file-upload",type:"file",className:"hidden",onChange:f})]}),t.filePath&&!g&&e.jsx("img",{src:t.filePath,alt:"預覽圖片",className:"right-2 top-1 mt-2 object-cover rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家地址："}),e.jsx("input",{type:"text",value:t.address,onChange:n=>d("address",n.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家地址"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家電話："}),e.jsx("input",{type:"number",value:t.phoneNumber,onChange:n=>d("phoneNumber",n.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家電話"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"營業時間："}),e.jsx(H,{businessHours:t.businessHours,onUpdate:n=>d("businessHours",n)})]})]})})}P.propTypes={storeId:m.string.isRequired,formData:m.object.isRequired,setFormData:m.func.isRequired,isUpdating:m.bool,isMutationError:m.bool.isRequired};const O=async({storeId:r,name:t,picture:s,address:l,description:c,businessHours:o},i)=>{const u=U.get("authToken");try{return(await w.put(`/v2/stores/${r}`,{name:t,picture:s,address:l,description:c,businessHours:o},{signal:i,headers:{Authorization:`Bearer ${u}`}})).data}catch(a){if(S.isCancel(a)){console.debug("Update store information request cancelled");return}throw console.error(`Failed to update store information (ID: ${r}):`,a),a}},z=r=>{const t=T(),s=j.useRef(null),{mutateAsync:l,isError:c,isPending:o}=Q({mutationFn:async({name:i,picture:u,address:a,description:g,businessHours:h})=>{s.current&&s.current.abort();const d=new AbortController;s.current=d;const f=await O({storeId:r,name:i,picture:u,address:a,description:g,businessHours:h},d.signal);return s.current===d&&(s.current=null),f},onMutate:async i=>{await t.cancelQueries(["storeInformation",r]);const u=t.getQueryData(["storeInformation",r]);return t.setQueryData(["storeInformation",r],{...u,...i}),{previousStoreData:u}},onError:(i,u,a)=>{console.debug("variables",u,a),a!=null&&a.previousStoreData&&t.setQueryData(["storeInformation",r],a.previousStoreData),alert("更新錯誤，請重整頁面後再試"),console.error("Update store information error:",i)},onSettled:()=>{t.invalidateQueries(["storeInformation",r])}});return{updateStore:l,isError:c,isPending:o}},X=()=>{const r=N(n=>n.title),t=N(n=>n.toggleSidebar),{userInfo:s}=q(),[l,c]=j.useState({name:"",description:"",file:null,filePath:"",address:"",phoneNumber:"",businessHours:Array(7).fill().map(()=>Array(2).fill().map(()=>({first:"09:00",second:"18:00"})))}),{updateStore:o,isPending:i,isError:u}=z(s==null?void 0:s.storeId),{uploadImage:a,isPending:g,isError:h}=C(),d=async n=>{n.preventDefault();try{await o({name:l.name,picture:l.filePath,address:l.address,description:l.description,businessHours:l.businessHours})}catch(p){console.error("提交表單時發生錯誤:",p)}},f=e.jsx("button",{onClick:d,className:" bg-orange-500 text-white rounded-lg px-3 py-1 font-sm shadow-md relative right-4  w-[60px]",children:i||g?e.jsx(y,{icon:A.faEllipsis,beatFade:!0,size:"lg"}):"儲存"});return e.jsxs("div",{className:"flex flex-col h-screen",children:[e.jsx(R,{title:r,onLeftClick:t,rightComponents:[f]}),e.jsx("div",{className:"sticky top-[54px] mt-[54px] z-20 ",children:e.jsx(P,{storeId:s==null?void 0:s.storeId,formData:l,setFormData:c,isUpdating:i,isMutationError:u})})]})};export{X as default};
