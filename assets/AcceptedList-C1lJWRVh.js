import{a as S,A as j,b as D,u as U,r as N,c as F,P as i,e as v,j as t}from"./index-bvl9KHtn.js";import{a as K,u as w}from"./index-Bkl8AXpy.js";import{u as T}from"./useSystemContext-BTaq2Wwc.js";import{u as I}from"./orderStore-C2dj1PFj.js";const Q=async(e,l,s)=>{try{const a=S.get("authToken"),c=new URLSearchParams({status:l});return(await j.patch(`/v1/order/${e}/status?${c.toString()}`,null,{headers:{Authorization:`Bearer ${a}`},signal:s})).data}catch(a){if(D.isCancel(a)){console.debug("Update order status request cancelled");return}throw console.error("Update order status error:",a),a}},L=()=>{const e=U(),l=N.useRef(null),{mutateAsync:s,isError:a,error:c,isLoading:r}=F({mutationFn:async({orderId:u,newStatus:n})=>{l.current&&l.current.abort();const o=new AbortController;return l.current=o,await Q(u,n,o.signal),l.current===o&&(l.current=null),{orderId:u,newStatus:n}},onMutate:async({orderId:u,newStatus:n})=>{const o=n==="PROCESSING"?"PENDING":"ALL";return await e.cancelQueries(["orders",o]),{previousOrders:e.getQueryData(["orders",o])}},onError:(u,n,o)=>{const g=n.newStatus==="PROCESSING"?"PENDING":"ALL";console.debug("newOrder",n,"context",o),o!=null&&o.previousOrders&&e.setQueryData(["orders",g],o.previousOrders),alert("更新訂單狀態失敗，請稍後再試"),console.error("Update order status error:",u)},onSettled:({newStatus:u})=>{const n=u==="PROCESSING"?"PENDING":"ALL";console.debug("updateOrderStatusAsync onSettled"),e.invalidateQueries(["orders",n])}});return{updateOrderStatusAsync:s,isError:a,error:c,isLoading:r}},_=e=>{switch(e){case"PROCESSING":return{bgColor:"bg-blue-500",textColor:"text-gray-100",statusText:"製作中"};case"COMPLETED":return{bgColor:"bg-yellow-500",textColor:"text-gray-100",statusText:"未取餐"};case"PICKED_UP":return{bgColor:"bg-lime-600",textColor:"text-gray-100",statusText:"已取餐"};case"CANCELED":return{bgColor:"bg-gray-500",textColor:"text-gray-100",statusText:"取消"};default:return{bgColor:"bg-gray-200",textColor:"text-gray-100",statusText:""}}},f=e=>{switch(e){case"PROCESSING":return"COMPLETED";case"COMPLETED":return"PICKED_UP";case"PICKED_UP":return"CANCELED";case"PENDING":return"PROCESSING";default:return null}},E=({order:e,showStatus:l=!0})=>{const{bgColor:s,textColor:a,statusText:c}=_(e.status),{updateOrderStatusAsync:r,isLoading:u}=L(),n=I(x=>x.setOrderData),o=N.useCallback(async()=>{const x=f(e.status);if(x)try{await r({orderId:e.id,newStatus:x})}catch(C){console.error("Failed to update order status:",C)}},[e.id,e.status,r]),g=N.useCallback(async x=>{try{await r({orderId:x,newStatus:"PROCESSING"})}catch(C){console.error("Failed to accept order:",C)}},[r]),h=N.useCallback(async x=>{try{await r({orderId:x,newStatus:"CANCELED"}),console.debug("Reject order: ",x)}catch(C){console.error("Failed to reject order:",C)}},[r]),d=(x,C)=>{const b=new Date,[R,A,G]=x.split(":"),[q,M]=G.split("."),k=new Date(b.getFullYear(),b.getMonth(),b.getDate(),parseInt(R),parseInt(A),parseInt(q),parseInt(M)),$=new Date(k.getTime()+C*60*1e3);return new Date>$},p=v(),m=x=>{x.preventDefault(),n(e),p(`/store/pos/management/order/${e.id.slice(-5)}`)};return t.jsxs("div",{className:"relative flex justify-between rounded-lg p-4 shadow-lg mb-6 bg-gray-50",children:[t.jsxs("div",{className:"flex flex-col items-start text-start",children:[t.jsxs("p",{className:"text-xl font-bold ",children:["單號： ",e.id.slice(-5)]}),t.jsxs("p",{className:"text-sm font-semibold ",children:["預估製作時間: ",e.estimatedPrepTime," 分鐘"]}),t.jsxs("p",{className:"text-sm font-medium",children:["下單時間: ",e.orderTime]}),t.jsx("button",{className:"bg-orange-500 mt-6 text-white px-3 py-1 text-sm font-bold rounded hover:bg-orange-600",onClick:m,children:"訂單內容"})]}),t.jsxs("div",{className:"flex flex-col items-end",children:[l&&e.status!=="PENDING"&&t.jsxs("div",{className:"flex items-center mb-2",children:[d(e.orderTime,e.estimatedPrepTime)&&e.status==="PROCESSING"&&t.jsx("span",{className:"text-red-500 text-sm ml-2 font-bold pr-2",children:"超時"}),t.jsx("button",{onClick:o,disabled:!f(e.status),className:`px-3 py-1 rounded-md text-sm font-bold ${s} ${a} ${f(e.status)?"":"opacity-50 cursor-not-allowed"}`,children:c})]}),e.status==="PENDING"&&t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:()=>h(e.id),className:"bg-red-500 text-white px-3 py-1 text-sm font-bold rounded hover:bg-red-600",children:"拒絕"}),t.jsx("button",{onClick:()=>g(e.id),className:"bg-green-500 text-white px-3 py-1 text-sm font-bold rounded hover:bg-green-600",children:"接單"})]})]}),t.jsx("div",{className:"absolute bottom-4 right-4 mt-5",children:t.jsxs("p",{className:"mt-2 font-semibold",children:["總金額: ",e.cost," 元"]})})]})};E.propTypes={order:i.shape({id:i.string.isRequired,status:i.string.isRequired,cost:i.number.isRequired,orderTime:i.string.isRequired,estimatedPrepTime:i.number.isRequired}).isRequired,onAccept:i.func,onReject:i.func,onStatusChange:i.func,showStatus:i.bool};const z=e=>{switch(e){case"PENDING":return{bgColor:"bg-stone-600",textColor:"text-gray-100",statusText:"未接單"};case"PROCESSING":return{bgColor:"bg-blue-500",textColor:"text-gray-100",statusText:"製作中"};case"COMPLETED":return{bgColor:"bg-yellow-500",textColor:"text-gray-100",statusText:"未取餐"};case"PICKED_UP":return{bgColor:"bg-lime-600",textColor:"text-gray-100",statusText:"已取餐"};case"CANCELED":return{bgColor:"bg-gray-500",textColor:"text-gray-100",statusText:"取消"};default:return{bgColor:"bg-gray-200",textColor:"text-gray-100",statusText:""}}},y=e=>{switch(e){case"PROCESSING":return"COMPLETED";case"COMPLETED":return"PICKED_UP";case"PICKED_UP":return"CANCELED";case"PENDING":return"PROCESSING";default:return null}},P=({order:e,showStatus:l=!0})=>{const{bgColor:s,textColor:a,statusText:c}=z(e.status),{updateOrderStatusAsync:r,isLoading:u}=L(),n=I(d=>d.setOrderData),o=N.useCallback(async()=>{const d=y(e.status);if(d)try{await r({orderId:e.id,newStatus:d})}catch(p){console.error("Failed to update order status:",p)}},[e.id,e.status,r]),g=v(),h=d=>{d.preventDefault(),n(e),g(`/history/order/${e.id.slice(-5)}`)};return t.jsxs("div",{className:"relative flex justify-between rounded-lg p-4 shadow-lg mb-6 bg-gray-50",children:[t.jsxs("div",{className:"flex flex-col items-start text-start",children:[t.jsxs("p",{className:"text-xl font-bold ",children:["單號： ",e.id.slice(-5)]}),t.jsxs("p",{className:"text-sm font-semibold ",children:["預估製作時間: ",e.estimatedPrepTime," 分鐘"]}),t.jsxs("p",{className:"text-sm font-medium",children:["下單時間: ",e.orderTime]}),t.jsx("button",{className:"bg-orange-500 mt-6 text-white px-3 py-1 text-sm font-bold rounded hover:bg-orange-600",onClick:h,children:"訂單內容"})]}),t.jsx("div",{className:"flex flex-col items-end",children:l&&t.jsx("div",{className:"flex items-center mb-2",children:t.jsx("button",{onClick:o,disabled:!0,className:`px-3 py-1 rounded-md text-sm font-bold ${s} ${a} ${y(e.status)?"":"opacity-50 cursor-not-allowed"}`,children:c})})}),t.jsx("div",{className:"absolute bottom-4 right-4 mt-5",children:t.jsxs("p",{className:"mt-2 font-semibold",children:["總金額: ",e.cost," 元"]})})]})};P.propTypes={order:i.shape({id:i.string.isRequired,status:i.string.isRequired,cost:i.number.isRequired,orderTime:i.string.isRequired,estimatedPrepTime:i.number.isRequired}).isRequired,onAccept:i.func,onReject:i.func,onStatusChange:i.func,showStatus:i.bool};const H=async(e={},l)=>{try{const{page:s=0,size:a=3,status:c}=e,r=new URLSearchParams({page:s.toString(),size:a.toString()});c&&r.append("status",c);const u=S.get("authToken");return(await j.get(`/v1/order/search?${r.toString()}`,{headers:{Authorization:`Bearer ${u}`},signal:l})).data}catch(s){if(D.isCancel(s)){console.debug("Search order request cancelled");return}throw console.error("Search order error:",s),s}},O=e=>{const{data:s,fetchNextPage:a,hasNextPage:c,isFetchingNextPage:r,isLoading:u,isError:n,error:o}=K({queryKey:["orders",e],queryFn:async({pageParam:g=0})=>(await H({page:g,size:3,status:e==="ALL"?null:e})).data,getNextPageParam:(g,h)=>{const d=g.currentPage;return d<g.totalPages-1?d+1:void 0}});return{orders:s,fetchNextPage:a,hasNextPage:c,isFetchingNextPage:r,isLoading:u,isError:n,error:o}},W=()=>{const{ref:e,inView:l}=w({rootMargin:"100px"}),{userInfo:s}=T(),a=s==null?void 0:s.role,{orders:c,fetchNextPage:r,hasNextPage:u,isFetchingNextPage:n,isLoading:o,isError:g,error:h}=O(a==="MERCHANT"?"PENDING":"ALL");N.useEffect(()=>{l&&!n&&u&&r()},[l,n,u,r]);const d=c==null?void 0:c.pages.map(p=>p.content.filter(m=>a==="MERCHANT"?m.status==="PENDING":m.status!=="PICKED_UP"&&m.status!=="CANCELED"));return o||c===void 0||d===void 0?t.jsx("div",{className:"text-center pt-20",children:"Loading..."}):g?t.jsxs("div",{className:"text-center pt-20",children:["Error: ",h.message]}):t.jsxs("div",{className:"flex flex-col text-center justify-between ",children:[d==null?void 0:d.map(p=>p.map((m,x)=>a==="MERCHANT"?t.jsx(E,{order:m},x):t.jsx(P,{order:m},x))),t.jsx("div",{ref:e,children:u&&n&&t.jsx("div",{className:"text-center py-4",children:"Loading more..."})})]})};function V(){const{ref:e,inView:l}=w({rootMargin:"100px"}),{orders:s,fetchNextPage:a,hasNextPage:c,isFetchingNextPage:r,isLoading:u,isError:n,error:o}=O("ALL"),{userInfo:g}=T(),h=g==null?void 0:g.role,d=s==null?void 0:s.pages.map(p=>p.content.filter(m=>h==="MERCHANT"?m.status!=="PENDING":m.status!=="PENDING"&&m.status!=="PROCESSING"&&m.status!=="COMPLETED"));return N.useEffect(()=>{l&&!r&&c&&a()},[l,r,c,a]),u||d===void 0||s===void 0?t.jsx("div",{className:"text-center pt-20",children:"Loading..."}):n?t.jsxs("div",{className:"text-center pt-20",children:["Error: ",o]}):t.jsxs("div",{className:"flex flex-col text-center justify-between ",children:[d.map(p=>p.map((m,x)=>h==="MERCHANT"?t.jsx(E,{order:m},x):t.jsx(P,{order:m},x))),t.jsx("div",{ref:e,children:c&&r&&t.jsx("div",{className:"text-center py-4",children:"Loading more..."})})]})}V.prototype={orderData:i.object};export{V as A,W as U};
