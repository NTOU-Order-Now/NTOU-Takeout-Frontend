import{d as S,f as D,j as e,a as I,A as P,b as T,r as g,P as v,z as L,T as M,c as z,H as N,i as O,o as B}from"./index-C6Vrb7cb.js";import{u as F}from"./orderStore-DdcuXir2.js";import{U,O as H,E as $}from"./EstimatedTime-B98rclpm.js";import{H as q}from"./Header-C2cPzCVk.js";import{m as R,F as K}from"./index-D5PwHk5Q.js";import{u as Q}from"./useSystemContext-Buuh7hNb.js";import{u as _}from"./useCategoryQueries-l0ZVmd0i.js";import{C as G}from"./CartItemCard-C75hKD0V.js";import{N as V}from"./NormalHeader-DnADi936.js";import{u as J}from"./useMutation-Boh6fdnl.js";import{B as W}from"./button-qAOIA98S.js";import"./useQueries-DhayYAxL.js";import"./blur-AUN4FaEB.js";/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=S("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=S("MessageSquareDiff",[["path",{d:"m5 19-2 2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2",key:"1xuzuj"}],["path",{d:"M9 10h6",key:"9gxzsh"}],["path",{d:"M12 7v6",key:"lw1j43"}],["path",{d:"M9 17h6",key:"r8uit2"}]]),k=D(t=>({storeDescription:null,setStoreDescription:r=>{t({storeDescription:r})},storeAverageSpend:void 0,setstoreAverageSpend:r=>t({storeAverageSpend:r}),storeRating:0,setStoreRating:r=>{const a=Math.min(Math.max(r,1),5);t({storeRating:a})},reset:()=>t({storeDescription:"",storeAverageSpend:0,storeRating:0})}));function Z(){const{storeDescription:t,setStoreDescription:r,storeAverageSpend:a,setstoreAverageSpend:o,storeRating:i,setStoreRating:d}=k(),c=s=>{d(s)};return e.jsx("div",{className:"px-4 max-w-screen",children:e.jsxs("form",{className:"p-4 space-y-4 font-semibold font-notoTC",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"評論："}),e.jsx("textarea",{rows:"3",value:t||"",onChange:s=>r(s.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-zinc-800",placeholder:"請輸入您對這家店的想法"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"評分："}),e.jsx("div",{className:"flex space-x-4 m-2",children:[1,2,3,4,5].map(s=>e.jsx("button",{type:"button",className:`w-8 h-8 rounded-full flex items-center justify-center border ${i===s?"bg-orange-500 text-white border-orange-500":"bg-gray-200 text-gray-700 border-gray-300"}`,onClick:()=>c(s),children:s},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"平均花費："}),e.jsx("input",{type:"number",value:a||"",onChange:s=>{s.preventDefault(),s.stopPropagation(),o(s.target.value)},onKeyDown:s=>{s.key==="Enter"&&s.preventDefault()},className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-zinc-800",placeholder:"請輸入您的平均花費"})]})]})})}const ee=async(t,r,a)=>{try{const o=I.get("authToken");return(await P.post(`/v1/reviews/${a}`,r,{headers:{Authorization:`Bearer ${o}`},signal:t})).data}catch(o){if(T.isCancel(o)){console.debug("POST review request cancelled");return}else console.error("POST review error:",o);throw o}},te=t=>{const r=g.useRef(null),{mutateAsync:a,isError:o,error:i,isPending:d,isSuccess:c}=J({mutationFn:async({payload:s})=>{r.current&&r.current.abort();const n=new AbortController;r.current=n;const p=await ee(n.signal,s,t);return r.current===n&&(r.current=null),p},onError:(s,n)=>{console.debug("variables",n),console.error("add Review error:",s)}});return{addReview:a,error:i,isError:o,isPending:d,isSuccess:c}},A=({storeName:t,storeId:r,setShowAddReview:a})=>{const o=`對 ${t} 新增評論`,{storeDescription:i,storeAverageSpend:d,storeRating:c,reset:s}=k(),{addReview:n,isPending:p,isSuccess:h}=te(r),u=g.useCallback(()=>{a(!1)},[a]),{toast:m}=L();g.useEffect(()=>{h&&m({title:"成功",description:"已成功送出評論",action:e.jsx(M,{altText:"回訂單",onClick:()=>u(),children:"回歷史訂單"})})},[h,m,u]);let f="";const b=()=>i!=null&&i.trim()?d?c?(f="",!0):(f="請填寫評分",!1):(f="請填寫平均消費",!1):(f="請填寫評論內容",!1),j=async x=>{if(x.preventDefault(),!b()){m({title:"失敗",description:f,variant:"destructive"});return}const l={averageSpend:d,comment:i.trim(),rating:c};s();try{await n({payload:l})}catch{m({title:"失敗",description:"發生未預期錯誤，請重新整理再嘗試",variant:"destructive"})}};return e.jsxs("div",{className:"flex flex-col h-screen overflow-hidden",children:[e.jsx(V,{title:o,onLeftClick:u,leftIcon:R,handleClick:u}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsxs("div",{className:"sticky top-[54px] mt-[54px] z-20 ",children:[e.jsx(Z,{}),e.jsx("div",{className:"flex items-center w-full",children:e.jsxs(W,{className:"font-notoTC m-4 rounded-xl text-white text-lg fixed bottom-4 w-[80%] h-12 p-4 flex justify-center items-center shadow-md cursor-pointer mx-auto left-0 right-0",onClick:x=>{j(x)},children:[p&&e.jsx(X,{className:"animate-spin"}),"提交"]})})]})})]})};A.propTypes={storeName:v.string,storeId:v.string,setShowAddReview:v.func};const E=({setShowAddReview:t})=>e.jsxs("footer",{className:"cursor-pointer font-notoTC  bg-orange-500 p-4 text-center text-white flex justify-center items-center",onClick:()=>t(!0),children:[e.jsx("span",{className:"text-xl px-2 pt-1",children:e.jsx(Y,{})}),e.jsx("span",{className:"text-xl font-bold mr-2",children:"撰寫評論"})]});E.propTypes={setShowAddReview:v.func.isRequired};const pe=()=>{var x;const t=F(l=>l.orderData),r=z(),[a,o]=g.useState(!1),{userInfo:i}=Q();if(g.useEffect(()=>{t===null&&r("/history/order")},[t,r]),t===null)return e.jsx(N,{});const d={PENDING:{text:"未接單",bgColor:"bg-stone-600"},PROCESSING:{text:"製作中",bgColor:"bg-blue-500"},COMPLETED:{text:"未取餐",bgColor:"bg-yellow-500"},PICKED_UP:{text:"已取餐",bgColor:"bg-green-500"},CANCELED:{text:"取消",bgColor:"bg-gray-300"}},c=l=>d[l]||{text:"default",bgColor:"bg-gray-200"},s=e.jsx("button",{className:`${c(t==null?void 0:t.status).bgColor} text-sm px-3 py-1 rounded-md text-white font-bold`,children:c(t==null?void 0:t.status).text}),{storeData:n,isLoading:p,isError:h}=O([t.storeId]),u=n?n[0].menuId:null,{menuCategoryList:m}=B(u),{categoryData:f}=_(m,u,i!==void 0&&u!==void 0),b=async()=>{await r(-1)},j=l=>{const C=f.flatMap(w=>w.dishes).find(w=>w.id===l);return C?C.picture:null};return p||n===void 0||h?e.jsx(N,{}):(t==null?void 0:t.status)==="PICKED_UP"&&a&&n?e.jsx(A,{storeName:(x=n[0])==null?void 0:x.name,setShowAddReview:o,storeId:t.storeId}):e.jsxs("div",{className:"flex flex-col h-screen",children:[e.jsx("div",{className:"sticky mt-[54px] z-50 shadow-sm",children:e.jsx(q,{LeftIcon:e.jsx(K,{icon:R}),title:"單號 "+t.id.slice(-5),onLeftClick:b,rightComponents:[s]})}),e.jsxs("div",{className:"flex-1 overflow-auto pb-[48px]",children:[e.jsxs("div",{className:"bg-white text-black flex-1 p-4 overflow-auto",children:[e.jsx(U,{user:t,storeData:n[0],role:i.role}),e.jsx(H,{note:t.note}),t.orderedDishes.map((l,y)=>e.jsx(G,{dishData:l,imageUrl:j(l.dishId),showAdjustBtn:!1},y))]}),(t==null?void 0:t.status)==="PICKED_UP"?e.jsx("div",{className:"fixed bottom-0 left-0 right-0 w-full",children:e.jsx(E,{setShowAddReview:o})}):(t==null?void 0:t.status)!=="CANCELED"&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 w-full",children:e.jsx($,{value:t.estimatedPrepTime})})]})]})};export{pe as default};
