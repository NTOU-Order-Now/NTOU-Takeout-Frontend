import{A as v,b as N,w as E,P as x,r as y,j as e,H as I,a as P,u as H,c as U}from"./index-DO00HQGw.js";import{H as k}from"./Header-Cfr6_fd3.js";import{F as w,n as q}from"./index-BjwE_i7q.js";import{B as Q}from"./BusinessHoursSelector-BPa0ea9W.js";import{u as S}from"./useImageUploadMutation-ByDOD8Qs.js";import{u as j}from"./sidebarStore-BCM4GyRa.js";import{u as A}from"./useMutation-B8e66jdv.js";import{f as F}from"./faEllipsis-CxEkbWIP.js";const R=async(o,s)=>{console.debug("getStoreInfo",o,s);try{const r=await v.get(`/v2/stores/${o}`,{signal:s});return console.debug("rrrrrrrrrrrrrrrr",r.data),r.data.data}catch(r){if(N.isCancel(r)){console.debug("Get store information request cancelled");return}throw console.error(`Failed to get store information (ID: ${o}):`,r),r}},M=(o,s=!0)=>{const{data:r,isLoading:l,error:d,isError:n}=E({queryKey:["storeInformation",o],queryFn:async({signal:i})=>await R(o,i),enabled:!!o&&s,refetchOnWindowFocus:!1,staleTime:6e5});return{storeInfo:r,isLoading:l,error:d,isError:n}};function C({storeId:o,formData:s,setFormData:r,isUpdating:l,isMutationError:d}){const{storeInfo:n,isLoading:i,isError:c}=M(o);y.useEffect(()=>{n&&r(t=>({name:n.name||"",description:n.description||"",file:null,filePath:n.picture||"",address:n.address||"",phoneNumber:n.phoneNumber||"",businessHours:n.businessHours?n.businessHours.map(p=>p.map(f=>({first:f.first||"09:00",second:f.second||"18:00"}))):t.businessHours}))},[n,r]);const{uploadImage:a,isPending:g,isError:b}=S(),u=(t,p)=>{r(f=>({...f,[t]:p}))},h=async t=>{const p=t.target.files[0];if(p)try{r(m=>({...m,file:p,filePath:"上傳中..."}));const f=await a(p);r(m=>({...m,file:null,filePath:f}))}catch(f){console.error("上傳圖片失敗:",f),r(m=>({...m,file:null,filePath:m.filePath}))}};return i?e.jsx(I,{}):c||d?e.jsx("div",{className:"flex flex-col justify-center items-center",children:"載入發生錯誤"}):e.jsx("div",{className:"p-4 max-w-screen",children:e.jsxs("form",{className:"p-4 space-y-4 font-semibold font-notoTC",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家名稱："}),e.jsx("input",{type:"text",value:s.name,onChange:t=>u("name",t.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家名稱"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家描述："}),e.jsx("textarea",{rows:"3",value:s.description,onChange:t=>u("description",t.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家描述"})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"圖片："}),e.jsxs("div",{className:"flex items-center w-full space-x-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",value:s.filePath,readOnly:!0,className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"請選擇圖片"})}),e.jsx("div",{className:"flex-none w-30",children:e.jsxs("label",{htmlFor:"file-upload",className:"bg-orange-500 text-white px-4 py-2 rounded-lg cursor-pointer whitespace-nowrap",children:[e.jsx(w,{icon:q,className:"mr-1"}),"上傳圖片"]})}),e.jsx("input",{id:"file-upload",type:"file",className:"hidden",onChange:h})]}),s.filePath&&!g&&e.jsx("img",{src:s.filePath,alt:"預覽圖片",className:"right-2 top-1 mt-2 object-cover rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家地址："}),e.jsx("input",{type:"text",value:s.address,onChange:t=>u("address",t.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家地址"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家電話："}),e.jsx("input",{type:"number",value:s.phoneNumber,onChange:t=>u("phoneNumber",t.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家電話"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"營業時間："}),e.jsx(Q,{businessHours:s.businessHours,onUpdate:t=>u("businessHours",t)})]})]})})}C.propTypes={storeId:x.string.isRequired,formData:x.object.isRequired,setFormData:x.func.isRequired,isUpdating:x.bool,isMutationError:x.bool.isRequired};const T=async({storeId:o,name:s,picture:r,address:l,description:d,businessHours:n},i)=>{const c=P.get("authToken");try{return(await v.put(`/v2/stores/${o}`,{name:s,picture:r,address:l,description:d,businessHours:n},{signal:i,headers:{Authorization:`Bearer ${c}`}})).data}catch(a){if(N.isCancel(a)){console.debug("Update store information request cancelled");return}throw console.error(`Failed to update store information (ID: ${o}):`,a),a}},$=o=>{const s=H(),r=y.useRef(null),{mutateAsync:l,isError:d,isPending:n}=A({mutationFn:async({name:i,picture:c,address:a,description:g,businessHours:b})=>{r.current&&r.current.abort();const u=new AbortController;r.current=u;const h=await T({storeId:o,name:i,picture:c,address:a,description:g,businessHours:b},u.signal);return r.current===u&&(r.current=null),h},onMutate:async i=>{await s.cancelQueries(["storeInformation",o]);const c=s.getQueryData(["storeInformation",o]);return s.setQueryData(["storeInformation",o],{...c,...i}),{previousStoreData:c}},onError:(i,c,a)=>{console.debug("variables",c,a),a!=null&&a.previousStoreData&&s.setQueryData(["storeInformation",o],a.previousStoreData),alert("更新錯誤，請重整頁面後再試"),console.error("Update store information error:",i)},onSettled:()=>{s.invalidateQueries(["storeInformation",o])}});return{updateStore:l,isError:d,isPending:n}},J=()=>{const o=j(t=>t.title),s=j(t=>t.toggleSidebar),{userInfo:r}=U(),[l,d]=y.useState({name:"",description:"",file:null,filePath:"",address:"",phoneNumber:"",businessHours:Array(7).fill().map(()=>Array(2).fill().map(()=>({first:"09:00",second:"18:00"})))}),{updateStore:n,isPending:i,isError:c}=$(r==null?void 0:r.storeId),{uploadImage:a,isPending:g,isError:b}=S(),u=async t=>{t.preventDefault();try{await n({name:l.name,picture:l.filePath,address:l.address,description:l.description,businessHours:l.businessHours})}catch(p){console.error("提交表單時發生錯誤:",p)}},h=e.jsx("button",{onClick:u,className:" bg-orange-500 text-white rounded-lg px-3 py-1 font-sm shadow-md relative right-4  w-[60px]",children:i||g?e.jsx(w,{icon:F.faEllipsis,beatFade:!0,size:"lg"}):"儲存"});return e.jsxs("div",{className:"flex flex-col h-screen",children:[e.jsx(k,{title:o,onLeftClick:s,rightComponents:[h]}),e.jsx("div",{className:"sticky top-[54px] mt-[54px] z-20 ",children:e.jsx(C,{storeId:r==null?void 0:r.storeId,formData:l,setFormData:d,isUpdating:i,isMutationError:c})})]})};export{J as default};
