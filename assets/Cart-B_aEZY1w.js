import{a as T,A as k,b as q,u as M,r as f,P as o,j as e,c as A,C as E}from"./index-CGLjlMRI.js";import{u as I,C as P,U as h}from"./UserInfo-C2y61RST.js";import{f as Q}from"./faEllipsis-CxEkbWIP.js";import{u as U}from"./useMutation-DlAJJIzI.js";import{F as v,f as F}from"./index-DdxdYMTC.js";import{u as H}from"./useCategoryQueries-DuBIVxZG.js";import{u as $}from"./useSystemContext-B9O4VHUW.js";import z from"./CartRemark-Ba-7Fcgc.js";import"./blur-Cy3ahvP8.js";const L=async(t,r)=>{const s=T.get("authToken");try{return(await k.patch("/v1/cart/send",{note:t},{headers:{Authorization:`Bearer ${s}`},signal:r})).data}catch(a){if(q.isCancel(a))console.debug("PATCH cart request cancelled");else throw console.error("PATCH cart error; ",a),a}},B=()=>{const t=M(),r=f.useRef(null),{mutateAsync:s,isPending:a,isSuccess:l,error:u}=U({mutationFn:async n=>{r.current&&r.current.abort();const d=new AbortController;r.current=d;const i=await L(n,r.current.signal);return r.current===d&&(r.current=null),i},onMutate:async()=>{await t.cancelQueries(["cart"]);const n=t.getQueryData(["cart"]),d=n?{...n}:{orderedDishes:[]};return d.orderedDishes||(d.orderedDishes=[]),t.setQueryData(["cart"],d),{previousCart:n}},onError:(n,d,i)=>{throw i!=null&&i.previousCart&&t.setQueryData(["cart"],i.previousCart),alert("訂單送出失敗，請重整頁面後再試試"),n},onSettled:()=>{console.debug("useCartAddMutation onSettled"),t.invalidateQueries(["cart"])}});return{sendCartAsync:s,sendCartError:u,sendCartIsPending:a,sendCartIsSuccess:l}},N=({orderDetail:t,handleChangeRemark:r})=>{const{totalSpend:s,estimateTime:a,cartData:l,remark:u}=t,{ispatchCartError:n}=I(),d=n?"bg-gray-300":"bg-white",{sendCartAsync:i,sendCartIsPending:p}=B(),m=async x=>{x.preventDefault(),!(s===0||(l==null?void 0:l.orderedDishes.length)===0)&&(r(""),await i(u))};return e.jsxs("div",{className:" fixed bottom-0 w-full bg-orange-400 px-4 py-2 rounded-t-lg  text-white font-notoTC font-medium",children:[e.jsxs("div",{className:"flex justify-between mb-3 px-2 text-sm",children:[e.jsx("span",{children:"總金額"}),e.jsxs("span",{children:["$ ",s]})]}),l.orderedDishes.length>0&&e.jsxs("div",{className:"flex justify-between mb-3 px-2 text-sm",children:[e.jsx("span",{children:"預估完成時間"}),e.jsxs("span",{children:[a," ~ ",a+20," 分鐘"]})]}),e.jsx("button",{className:`w-full ${d} text-orange-500 py-2 px-2 rounded-full font-semibold `,disabled:n,onClick:m,children:p?e.jsx(v,{icon:Q.faEllipsis,beatFade:!0,size:"lg",className:"mr-2"}):"送出訂單"})]})};N.propTypes={orderDetail:o.shape({cartData:o.object.isRequired,totalSpend:o.number.isRequired,estimateTime:o.number.isRequired,remark:o.string.isRequired}).isRequired,handleChangeRemark:o.func.isRequired};const y=()=>{const t=A(),r=()=>{t(-1)};return e.jsx("header",{className:"h-16 fixed z-30 top-0 left-0 w-full flex justify-between items-center bg-white shadow-md transition-shadow duration-300 ease-in-out p-2 font-notoTC",children:e.jsxs("div",{className:"flex ml-3 items-center text-xl ",children:[e.jsx(v,{icon:F,className:"mr-4 cursor-pointer text-2xl mt-1",onClick:r}),e.jsx("h1",{className:"font-noto font-bold text-2xl",children:"購物車"})]})})},w=({orderDetail:t})=>{const{cartData:r,merchantName:s,totalSpend:a}=t;return e.jsxs("div",{className:"mt-[66px] flex justify-between items-center p-4 bg-white",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-gray-900",children:r.orderedDishes.length?s:""}),e.jsx("p",{className:"text-sm text-gray-500",children:"訂單詳細資訊"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"總金額"}),e.jsxs("h2",{className:"text-2xl font-bold text-black",children:["$",a]})]})]})};w.propTypes={orderDetail:o.shape({cartData:o.object.isRequired,merchantName:o.string,totalSpend:o.number.isRequired}).isRequired};const R=({cartData:t,dishesMap:r})=>!t.orderedDishes||t.orderedDishes.length===0?e.jsx("div",{className:"flex justify-center items-center mt-4 fa-2x",children:"目前購物車是空的:)"}):e.jsx("div",{children:t.orderedDishes.map((s,a)=>{var l;return e.jsx(P,{dishData:s,imageUrl:(l=r[s==null?void 0:s.dishId])==null?void 0:l.picture},a)})});R.propTypes={cartData:o.object.isRequired,dishesMap:o.object.isRequired};const _=()=>{var C,j;const{cartData:t,isCartError:r,merchantData:s,isMerchantLoading:a,menuCategoryList:l,totalSpend:u,totalQuantity:n,refetchCart:d}=$();t===void 0&&(console.error("Cart not found, refetchCart"),d());const{categoryData:i,isQueriesSuccess:p}=H(l,((C=h)==null?void 0:C.role)==="CUSTOMER"?t==null?void 0:t.menuId:(j=h)==null?void 0:j.storeId,h!==void 0),[m,x]=f.useState(""),D=f.useMemo(()=>i?i.reduce((g,S)=>(S.dishes.forEach(b=>{g[b.id]=b}),g),{}):{},[i]);if(t===void 0)return e.jsx(E,{});let c=10*n;return c>150&&c<300?c=Math.floor(c*.7):c>=300&&(c=Math.floor(c*.5)),r?e.jsxs("div",{className:"flex justify-center items-center mt-28 fa-2x",children:[e.jsx(y,{}),"購物車資料讀取失敗:("]}):e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex-none",children:[e.jsx(y,{}),e.jsx(w,{orderDetail:{cartData:t,merchantName:s==null?void 0:s.name,totalSpend:u}})]}),e.jsxs("div",{className:"flex-1 overflow-auto pb-[120px] ",children:[e.jsx(R,{cartData:t,dishesMap:D}),e.jsx("div",{className:"px-4",children:e.jsx(z,{onRemarkChange:x,value:m})})]}),e.jsx("div",{className:"flex-none",children:e.jsx(N,{orderDetail:{cartData:t,totalSpend:u,remark:m,estimateTime:c-(n>2?30:0)},handleChangeRemark:x})})]})};export{_ as default};
