const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ConfirmClearCartModal-1hJ5aH1f.js","assets/index-B63W5zLe.js","assets/index-BYhJshBL.css"])))=>i.map(i=>d[i]);
import{a as b,A,b as D,u as g,r as C,_ as Q,j as p,P as m}from"./index-B63W5zLe.js";import{u as E}from"./useMutation-DTmJSCIp.js";import{u as R}from"./useSystemContext-D2UnwePm.js";import{u as y}from"./DishDetail-Cy3cO0n1.js";import"./index-D3rtBfOE.js";import"./blur-CZbtjyQu.js";const O=async s=>{try{const t=b.get("authToken");return(await A.delete("/v1/cart",{headers:{Authorization:`Bearer ${t}`},signal:s})).data}catch(t){if(D.isCancel(t)){console.debug("DELETE cart request cancelled");return}else console.error("DELETE cart error:",t);throw t}},P=async(s,t)=>{try{const n=b.get("authToken");return(await A.post("/v1/cart/dishes",t,{headers:{Authorization:`Bearer ${n}`},signal:s})).data}catch(n){if(D.isCancel(n)){console.debug("POST cart request cancelled");return}else console.error("POST cart error:",n);throw n}},I=()=>{const s=g(),t=C.useRef(null),{mutateAsync:n,onError:a,onMutate:h,isError:l}=E({mutationFn:async r=>{t.current&&t.current.abort();const i=new AbortController;t.current=i;const e=await P(t.current.signal,r);return t.current===i&&(t.current=null),e},onMutate:async r=>{await s.cancelQueries(["cart"]);const i=s.getQueryData(["cart"]),e=i?{...i}:{orderedDishes:[]};e.orderedDishes||(e.orderedDishes=[]);const c=e.orderedDishes.findIndex(o=>o.dishId===r.dishId&&o.chosenAttributes===r.chosenAttributes);if(c>-1){const o=e.orderedDishes[c];e.orderedDishes=[...e.orderedDishes.slice(0,c),{...o,quantity:o.quantity+r.quantity,note:r.note||o.note},...e.orderedDishes.slice(c+1)]}else e.orderedDishes.push({id:crypto.randomUUID(),dishId:r.dishId,dishName:r.dishName,price:r.price,quantity:r.quantity,note:r.note||"",chosenAttributes:r.chosenAttributes||[],storeId:r.storeId});return s.setQueryData(["cart"],e),{previousCart:i}},onError:(r,i,e)=>{throw e!=null&&e.previousCart&&s.setQueryData(["cart"],e.previousCart),alert("新增購物車失敗，請稍後再試"),r},onSettled:()=>{console.debug("patchCartAsync onSettled"),s.invalidateQueries(["cart"])}});return{postCartAsync:n,postCartError:a,postCartOnMutate:h,postCartIsError:l}},_=()=>{const s=g(),t=C.useRef(null),{postCartAsync:n}=I(),{mutateAsync:a,onError:h,onSuccess:l,onMutate:r,isError:i}=E({mutationFn:async e=>{t.current&&t.current.abort();const c=new AbortController;return t.current=c,await O(t.current.signal),t.current===c&&(t.current=null),e},onMutate:async()=>{await s.cancelQueries(["cart"]);const e=s.getQueryData(["cart"]);return e&&{...e},console.debug("previousCart",e),s.setQueryData(["cart"],[]),{previousCart:e}},onSuccess:e=>{n(e)},onError:(e,c,o)=>{throw o!=null&&o.previousCart&&s.setQueryData(["cart"],o.previousCart),alert("刪除購物車失敗，請稍後再試"),e},onSettled:()=>{console.debug("deleteCartAsync onSettled"),s.invalidateQueries(["cart"])}});return{deleteCartAsync:a,deleteCartSuccess:l,deleteCartError:h,deleteCartOnMutate:r,deleteCartIsError:i}},x=C.lazy(()=>Q(()=>import("./ConfirmClearCartModal-1hJ5aH1f.js"),__vite__mapDeps([0,1,2]))),j=({dishId:s,onRequiredMissing:t,onClose:n})=>{const{cartData:a}=R(),[h,l]=C.useState(!1),r=y(u=>u.dishes),i=y(u=>u.allDishAttributes),{deleteCartAsync:e}=_(),{postCartAsync:c}=I(),o=async()=>{l(!1);const u=r[s];await e(u),n()},q=()=>{l(!1)},v=async u=>{u.preventDefault(),u.stopPropagation();const d=r[s];if(!d)return;const w=d.chosenAttributes||[],T=i[s]||[];for(const f of T)if(f.isRequired===!0&&w.filter(S=>S.attributeName===f.name).length===0){t(f.name);return}if(a!=null&&a.storeId&&(a==null?void 0:a.storeId)!==d.storeId){l(!0);return}const M={dishId:d.dishId,storeId:d.storeId,quantity:d.quantity,note:d.note,choosenAttributes:d.chosenAttributes};await c(M),n()};return p.jsxs("div",{className:"flex items-center justify-center",children:[p.jsx("button",{className:"shadow-md bg-orange-500 text-white text-md px-6 py-2 rounded-full border border-orange-700 font-notoTC",onClick:v,children:"加入"}),p.jsx(x,{isOpen:h,onCancel:q,onConfirm:o})]})};j.propTypes={dishId:m.string.isRequired,onRequiredMissing:m.func.isRequired,onClose:m.func.isRequired};export{j as default};
