const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MenuNavbar-Cj1WoZl8.js","assets/index-Bu6klRY2.js","assets/index-F2T2dUGP.css","assets/merchantMenuNav-CEGK-TKo.js","assets/MenuSection-DypHS05c.js"])))=>i.map(i=>d[i]);
import{P as i,j as e,F as C,K as X,o as E,Q as J,r as g,R as P,S as Y,T as Z,U as G,i as ee,a as T,A,b as _,u as F,c as M,_ as U,e as se,M as te}from"./index-Bu6klRY2.js";import{u as O}from"./sidebarStore-CLMzskf9.js";import{H as $}from"./Header-WhGRiolg.js";import ne from"./NavbarSkeleton-8qgr9yaS.js";import re from"./MenuSectionSkeleton-HvZsg-eN.js";import{u as ae}from"./useCategoryQueries-BWWeVwvd.js";import{u as oe}from"./merchantMenuNav-CEGK-TKo.js";import{u as ie}from"./useImageUploadMutation-B8nJkI7p.js";import{u as le}from"./useSystemContext-DQz_8l1v.js";const Q=({dishName:a,onSave:r,onBack:o})=>{const s=e.jsx("button",{onClick:r,className:"bg-orange-400 text-white px-4 py-1 rounded-lg font-bold hover:bg-orange-600",children:"保存"});return e.jsx($,{LeftIcon:e.jsx(C,{icon:X}),title:a,onLeftClick:o,rightComponents:[s]})};Q.propTypes={dishName:i.string.isRequired,onSave:i.func,onBack:i.func};const V=({defaultName:a,defaultDescription:r,defaultPrice:o,defaultCategory:s,defaultImage:c,categoryNames:d=[],onNameChange:n,onDescriptionChange:t,onPriceChange:l,onCategoryChange:m,onImageChange:h})=>{const{uploadImage:b,isPending:x,isError:v}=ie(),D=async f=>{const y=f.target.files[0];if(y)try{h({url:null}),console.debug("file:",y);const w=await b(y);h({url:w})}catch(w){console.error("upload Failed:",w),h({url:null})}};return e.jsxs("div",{className:"mt-10 p-6 bg-white",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"名稱："}),e.jsx("input",{type:"text",defaultValue:a,placeholder:"請輸入名稱",className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:f=>n(f.target.value)})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"商品描述："}),e.jsx("textarea",{defaultValue:r,placeholder:"請輸入商品描述",className:"w-full h-24 px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:f=>t(f.target.value)})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"圖片："}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"flex-1 relative",children:e.jsx("input",{type:"text",value:c||"",placeholder:"請選擇圖片",readOnly:!0,className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none"})}),e.jsx("label",{htmlFor:"dish-image-upload",className:`
                            flex-shrink-0 px-6 py-2 rounded-md
                            ${x?"bg-gray-400 cursor-not-allowed":"bg-orange-400 hover:bg-orange-600 cursor-pointer"}
                            text-white transition-colors duration-200
                        `,children:x?e.jsxs(e.Fragment,{children:[e.jsx(C,{icon:E,className:"mr-2 animate-spin"}),"上傳中"]}):e.jsxs(e.Fragment,{children:[e.jsx(C,{icon:J,className:"mr-2"}),"上傳圖片"]})}),e.jsx("input",{id:"dish-image-upload",type:"file",className:"hidden",onChange:D,accept:"image/*",disabled:x})]}),c&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:c,alt:"商品圖片",className:"w-32 h-32 object-cover rounded-lg shadow-md"})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"價格："}),e.jsx("input",{type:"number",defaultValue:o,placeholder:"請輸入價格",className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:f=>l(Number(f.target.value))})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"類別："}),e.jsx("input",{type:"text",defaultValue:s,placeholder:"請輸入類別",list:"category-options",className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:f=>m(f.target.value)}),e.jsx("datalist",{id:"category-options",children:d.map((f,y)=>e.jsx("option",{value:f},y))})]})]})};V.propTypes={defaultName:i.string,defaultDescription:i.string,defaultPrice:i.oneOfType([i.string,i.number]),defaultImage:i.string,defaultCategory:i.string,onImageUpload:i.func,categoryNames:i.arrayOf(i.string),onNameChange:i.func.isRequired,onDescriptionChange:i.func.isRequired,onPriceChange:i.func.isRequired,onCategoryChange:i.func.isRequired,onImageChange:i.func.isRequired};const B=({option:a,onDelete:r,onUpdate:o})=>{const[s,c]=g.useState(!1),[d,n]=g.useState(!1),t=g.useRef(null);g.useEffect(()=>{t.current&&(s||d)&&t.current.focus()},[s,d]);const l=h=>{const b=h.target.value;h.type==="keydown"&&h.key!=="Enter"||(c(!1),o({name:b}))},m=h=>{const b=h.target.value;h.type==="keydown"&&h.key!=="Enter"||(n(!1),o({extraCost:parseFloat(b)||0}))};return e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[s?e.jsx("input",{ref:t,type:"text",defaultValue:a.name,onBlur:l,onKeyDown:l,className:"border rounded px-2 py-1 text-lg focus:ring-orange-400"}):e.jsx("span",{onClick:()=>c(!0),className:"cursor-pointer hover:underline text-xl",children:a.name}),d?e.jsx("input",{ref:t,type:"number",defaultValue:a.extraCost,onBlur:m,onKeyDown:m,className:"border rounded px-2 py-1 text-sm focus:ring-orange-400"}):e.jsxs("span",{onClick:()=>n(!0),className:"px-3 border rounded-xl text-black border-black cursor-pointer hover:underline",children:["+ ",a.extraCost,"元"]})]}),e.jsx("button",{className:"text-red-400 hover:text-red-700",onClick:r,children:e.jsx(C,{icon:P})})]})};B.propTypes={option:i.shape({name:i.string.isRequired,extraCost:i.number.isRequired}).isRequired,onDelete:i.func.isRequired,onUpdate:i.func.isRequired};function z({options:a,selectedOption:r,onChange:o}){const s=Object.keys(a),c=s.findIndex(n=>n===r),d=100/s.length;return e.jsx("div",{className:"relative  h-full  w-full",children:e.jsxs("div",{className:"relative border-gray-200 border-2 h-full flex overflow-hidden rounded-xl",children:[e.jsx("div",{className:"absolute h-full bg-orange-500 transition-transform duration-300 ease-in-out rounded-xl",style:{width:`${d}%`,transform:`translateX(${c*100}%)`}}),s.map(n=>{const t=n===r;return e.jsx("button",{onClick:()=>o(n),className:`
                                relative flex-1 text-center text-sm font-bold 
                                transition-colors duration-300 ease-in-out z-10
                                ${t?"text-white":"text-black"}
                            `,children:n},n)})]})})}z.propTypes={options:i.object.isRequired,selectedOption:i.string.isRequired,onChange:i.func.isRequired};const L=({group:a,groupIndex:r,onUpdateGroup:o,onDeleteGroup:s})=>{const[c,d]=g.useState(!1),[n,t]=g.useState(a.name),[l,m]=g.useState(a.isRequired),[h,b]=g.useState(a.type),[x,v]=g.useState(a.attributeOptions||[]),D=()=>{d(!1),N()},f=()=>{const p={name:"新選項",extraCost:0,isChosen:!1},u=[...x,p];v(u),N({attributeOptions:u})},y=p=>{const u=x.filter((j,I)=>I!==p);v(u),N({attributeOptions:u})},w=(p,u)=>{const j=x.map((I,W)=>W===p?{...I,...u}:I);v(j),N({attributeOptions:j})},N=p=>{const u={...a,name:n,isRequired:l,type:h,attributeOptions:x,...p};o(u)},S={單選:()=>{b("single"),N({type:"single"})},複選:()=>{b("multiple"),N({type:"multiple"})}},k=h==="single"?"單選":"複選",R=()=>{const p=!l;m(p),N({isRequired:p})};return e.jsxs("div",{className:"p-4 bg-white border rounded-lg shadow-md mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[c?e.jsx("input",{type:"text",value:n,onChange:p=>t(p.target.value),onKeyDown:p=>{p.key==="Enter"&&D()},className:"border rounded px-2 py-1 text-lg font-bold focus:ring-orange-500 focus:outline-none"}):e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:"font-bold text-xl",children:n}),e.jsx("span",{className:`px-2 py-1 rounded-lg text-white text-sm cursor-pointer ${l?"bg-red-500":"bg-gray-500"}`,onClick:R,children:"必選"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{className:"text-orange-500 hover:text-orange-700 text-xl",onClick:()=>{c?D():d(!0)},children:e.jsx(C,{icon:c?Y:Z})}),e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:s,children:e.jsx(C,{icon:P})})]})]}),x.map((p,u)=>e.jsx(B,{option:p,onDelete:()=>y(u),onUpdate:j=>w(u,j)},u)),e.jsx("button",{className:"text-orange-500 mt-2 text-lg",onClick:f,children:"新增選項..."}),e.jsx("div",{className:"flex justify-end space-x-4 mt-4",children:e.jsx("div",{className:"flex w-[120px] h-10 overflow-hidden",children:e.jsx(z,{options:S,selectedOption:k,onChange:p=>{S[p]()}})})})]})};L.propTypes={group:i.object.isRequired,groupIndex:i.number.isRequired,onUpdateGroup:i.func.isRequired,onDeleteGroup:i.func.isRequired};const K=({groups:a,onGroupsChange:r})=>{const o=d=>{const n=a.filter((t,l)=>l!==d);r(n)},s=(d,n)=>{const t=a.map((l,m)=>m===d?n:l);r(t)},c=()=>{const d={name:"新選項標題",description:"",type:"single",isRequired:!1,attributeOptions:[]};r([...a,d])};return e.jsxs("div",{className:"p-4 bg-white mt-4",children:[a.map((d,n)=>e.jsx(L,{groupIndex:n,group:d,onUpdateGroup:t=>s(n,t),onDeleteGroup:()=>o(n)},n)),e.jsx("div",{className:"flex justify-center mt-6 z-50",children:e.jsxs("button",{className:"text-orange-500 hover:text-orange-700 flex items-center",onClick:c,children:[e.jsx(C,{icon:G,size:"lg",className:"mr-2"}),"新增客製化選項"]})})]})};K.propTypes={groups:i.array.isRequired,onGroupsChange:i.func.isRequired};const q=ee(a=>({selectedDish:null,setSelectedDish:r=>a({selectedDish:r})})),ce=async({menuId:a,id:r,name:o,description:s,picture:c,price:d,category:n,dishAttributes:t},l)=>{if(o===""||d===null||n===""||s==="")throw new Error("content can't be empty");try{const m=T.get("authToken");return(await A.put(`/v2/menu/${a}/dish/${r}`,{name:o,description:s,picture:c,price:d,category:n,dishAttributes:t},{signal:l,headers:{Authorization:`Bearer ${m}`}})).data}catch(m){if(_.isCancel(m)){console.debug("Update dish request cancelled");return}throw console.error(`Failed to update dish (ID: ${r}) in menu (ID: ${a}):`,m),m}},ue=a=>{const r=F(),o=g.useRef(null),{mutateAsync:s,isError:c,isPending:d}=M({mutationFn:async n=>{o.current&&o.current.abort();const t=new AbortController;return o.current=t,await ce({menuId:a,...n},t.signal),o.current===t&&(o.current=null),n.category},onMutate:async n=>{const{category:t,id:l}=n;await r.cancelQueries(["categoryDishes",t]);const m=r.getQueryData(["categoryDishes",t]);return r.setQueryData(["categoryDishes",t],{categoryName:t,dishes:m.dishes.map(h=>h.id===l?s:h)}),{previousDishes:m,category:t}},onError:(n,t,l)=>{console.debug("error",t,l),l!=null&&l.previousDishes&&r.setQueryData(["categoryDishes",l.category],l.previousDishes),alert("更新錯誤，請確保所有欄位都不為空"),console.error("Update dish error:",n)},onSettled:n=>{r.invalidateQueries(["categoryDishes",n])}});return{updateDish:s,isError:c,isPending:d}};function H({onClose:a,categoryNames:r,menuId:o}){const s=q(p=>p.selectedDish),[c,d]=g.useState(s.name),[n,t]=g.useState(s.description),[l,m]=g.useState(s.price),[h,b]=g.useState(s.category),[x,v]=g.useState(s.dishAttributes),[D,f]=g.useState(""),y=({url:p})=>{p&&f(p)},{updateDish:w,isPending:N}=ue(o),S=async()=>{const p=D,u={id:s.id,name:c,description:n,picture:p,price:l,category:h,dishAttributes:x};try{await w(u),a()}catch(j){console.error("更新失敗：",j)}},k=()=>{a()},R=p=>{v(p)};return e.jsxs("div",{children:[e.jsx(Q,{dishName:c,onBack:k,onSave:S,isPending:N}),e.jsx(V,{defaultName:c,defaultDescription:n,defaultPrice:l,defaultImage:D,defaultCategory:h,categoryNames:r,onNameChange:d,onDescriptionChange:t,onPriceChange:m,onCategoryChange:b,onImageChange:y}),e.jsx(K,{groups:x,onGroupsChange:R})]})}H.propTypes={onClose:i.func.isRequired,categoryNames:i.arrayOf(i.string),menuId:i.string.isRequired};const de=async(a,r)=>{const o=T.get("authToken");try{return(await A.get(`/v2/menu/${a}/dish/create`,{signal:r,headers:{Authorization:`Bearer ${o}`}})).data}catch(s){if(_.isCancel(s)){console.debug("Get new dish ID request cancelled");return}throw console.error(`Failed to get new dish ID for menu (ID: ${a}):`,s),s}},pe=a=>{const r=F(),o=g.useRef(null),s="",{mutateAsync:c,isError:d,isPending:n}=M({mutationFn:async()=>{o.current&&o.current.abort();const t=new AbortController;o.current=t;const l=await de(a,t.signal);return o.current===t&&(o.current=null),l},onMutate:async()=>{await r.cancelQueries(["categoryDishes",s]);const t=r==null?void 0:r.getQueryData(["categoryDishes",s]),l={id:`temp-${Date.now()}`,name:"",description:"",picture:"",price:null,category:s,salesVolume:0,dishAttributes:[]};return r.setQueryData(["categoryDishes",s],{categoryName:"",dishes:t?[t.dishes,l]:[l]}),{previousDishes:t}},onError:(t,l,m)=>{m!=null&&m.previousDishes?r.setQueryData(["categoryDishes",s],m.previousDishes):r.setQueryData(["categoryDishes",s],[]),alert("創建失敗，請重整頁面再試一次"),console.error("Create new dish error:",t)},onSettled:()=>{console.debug("onSettled"),r.invalidateQueries(["menuCategoryList",a]),r.invalidateQueries(["categoryDishes"],s)}});return{createDish:c,isError:d,isPending:n}},me=g.lazy(()=>U(()=>import("./MenuNavbar-Cj1WoZl8.js"),__vite__mapDeps([0,1,2,3]))),he=g.lazy(()=>U(()=>import("./MenuSection-DypHS05c.js"),__vite__mapDeps([4,1,2]))),ge=()=>{const a=O(u=>u.toggleSidebar),r=O(u=>u.title),{userInfo:o,merchantData:s,menuCategoryList:c}=le(),d=o==null?void 0:o.id,n=o==null?void 0:o.storeId,t=s==null?void 0:s.menuId,{categoryData:l}=ae(c,s==null?void 0:s.menuId,o!==void 0),m=se(),h=g.useRef([]),[b,x]=g.useState(!1),v=oe(u=>u.setNavbarItems),{createDish:D,isPending:f}=pe(t),y=u=>{var j;(j=h.current[u])==null||j.scrollIntoView({behavior:"smooth",inline:"start"})},w=q(u=>u.selectedDish),N=q(u=>u.setSelectedDish);if(g.useEffect(()=>{v(c==null?void 0:c.map(u=>u.categoryName))},[c,v]),d&&!s)return e.jsx(te,{});const S=async()=>{await D(t)},k=e.jsx("button",{onClick:S,className:"bg-orange-500 text-white rounded-lg p-2 flex  shadow-md content-center w-full h-full",children:f?e.jsx(C,{icon:E,spinPulse:!0,style:{color:"#ffffff"},size:"xs"}):e.jsx(C,{icon:G})}),R=e.jsx("button",{onClick:()=>{m(`/menu/${n}`)},className:" bg-slate-400 text-white rounded-lg px-3 py-1 font-sm shadow-md",children:"預覽"}),p=c.map(u=>u.categoryName);return w?e.jsx(H,{onClose:()=>{N(null)},categoryNames:p,menuId:t}):e.jsxs("div",{className:"flex flex-col h-screen",children:[e.jsx($,{title:r,onLeftClick:a,rightComponents:[k,R]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"sticky top-[54px] mt-[54px] z-20 shadow-sm",children:e.jsx(g.Suspense,{fallback:e.jsx(ne,{isNavbarFixed:!1}),children:e.jsx(me,{onNavClick:y,isNavbarFixed:b})})}),e.jsx("div",{className:"overflow-auto h-[dvh-34px]  ",children:e.jsx(g.Suspense,{fallback:e.jsx(re,{}),children:e.jsx(he,{menuId:t,sectionRefs:h,categoryData:l})})})]})]})},Ce=Object.freeze(Object.defineProperty({__proto__:null,default:ge},Symbol.toStringTag,{value:"Module"}));export{Ce as M,q as u};
