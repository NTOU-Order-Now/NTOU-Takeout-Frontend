import{A as h,b,f as N,P as m,r as g,j as e,H as w,a as S,u as C}from"./index-B1d1xkVu.js";import{H}from"./Header-BG2s69AD.js";import{F as y,w as E}from"./index-Dh1a5gK-.js";import{B as k}from"./BusinessHoursSelector-4QbsQmdr.js";import{u as x}from"./sidebarStore-BpCeRPS_.js";import{u as I}from"./useSystemContext-CLvFq4Mr.js";import{u as P}from"./useMutation-BEkH6uOz.js";import{f as F}from"./faEllipsis-CxEkbWIP.js";const q=async(t,o)=>{console.debug("getStoreInfo",t,o);try{const r=await h.get(`/v2/stores/${t}`,{signal:o});return console.debug("rrrrrrrrrrrrrrrr",r.data),r.data.data}catch(r){if(b.isCancel(r)){console.debug("Get store information request cancelled");return}throw console.error(`Failed to get store information (ID: ${t}):`,r),r}},Q=(t,o=!0)=>{const{data:r,isLoading:i,error:d,isError:a}=N({queryKey:["storeInformation",t],queryFn:async({signal:l})=>await q(t,l),enabled:!!t&&o,refetchOnWindowFocus:!1,staleTime:6e5});return{storeInfo:r,isLoading:i,error:d,isError:a}};function j({storeId:t,formData:o,setFormData:r,isUpdating:i,isMutationError:d}){const{storeInfo:a,isLoading:l,isError:u}=Q(t);g.useEffect(()=>{a&&r(s=>({name:a.name||"",description:a.description||"",file:null,filePath:a.picture||"",address:a.address||"",phoneNumber:a.phoneNumber||"",businessHours:a.businessHours?a.businessHours.map(c=>c.map(f=>({first:f.first||"09:00",second:f.second||"18:00"}))):s.businessHours}))},[a,r]);const n=(s,c)=>{r(f=>({...f,[s]:c}))},p=s=>{const c=s.target.files[0];if(c){const f=s.target.value;r(v=>({...v,file:c,filePath:f}))}};return l?e.jsx(w,{}):u||d?e.jsx("div",{className:"flex flex-col justify-center items-center",children:"載入發生錯誤"}):e.jsx("div",{className:"p-4 max-w-screen",children:e.jsxs("form",{className:"p-4 space-y-4 font-semibold font-notoTC",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家名稱："}),e.jsx("input",{type:"text",value:o.name,onChange:s=>n("name",s.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家名稱"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家描述："}),e.jsx("textarea",{rows:"3",value:o.description,onChange:s=>n("description",s.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家描述"})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"圖片："}),e.jsxs("div",{className:"flex items-center w-full space-x-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",value:o.filePath,readOnly:!0,className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"請選擇圖片"})}),e.jsx("div",{className:"flex-none w-30",children:e.jsxs("label",{htmlFor:"file-upload",className:"bg-orange-500 text-white px-4 py-2 rounded-lg cursor-pointer whitespace-nowrap",children:[e.jsx(y,{icon:E,className:"mr-1"}),"上傳圖片"]})}),e.jsx("input",{id:"file-upload",type:"file",className:"hidden",onChange:p})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家地址："}),e.jsx("input",{type:"text",value:o.address,onChange:s=>n("address",s.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家地址"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"商家電話："}),e.jsx("input",{type:"number",value:o.phoneNumber,onChange:s=>n("phoneNumber",s.target.value),className:"w-full border rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"輸入商家電話"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1",children:"營業時間："}),e.jsx(k,{businessHours:o.businessHours,onUpdate:s=>n("businessHours",s)})]})]})})}j.propTypes={storeId:m.string.isRequired,formData:m.object.isRequired,setFormData:m.func.isRequired,isUpdating:m.bool,isMutationError:m.bool.isRequired};const A=async({storeId:t,name:o,picture:r,address:i,description:d,businessHours:a},l)=>{const u=S.get("authToken");try{return(await h.put(`/v2/stores/${t}`,{name:o,picture:r,address:i,description:d,businessHours:a},{signal:l,headers:{Authorization:`Bearer ${u}`}})).data}catch(n){if(b.isCancel(n)){console.debug("Update store information request cancelled");return}throw console.error(`Failed to update store information (ID: ${t}):`,n),n}},R=t=>{const o=C(),r=g.useRef(null),{mutateAsync:i,isError:d,isPending:a}=P({mutationFn:async({name:l,picture:u,address:n,description:p,businessHours:s})=>{console.debug("updateStoreInformation",{name:l,picture:u,address:n,description:p,businessHours:s}),r.current&&r.current.abort();const c=new AbortController;r.current=c;const f=await A({storeId:t,name:l,picture:u,address:n,description:p,businessHours:s},c.signal);return r.current===c&&(r.current=null),f},onMutate:async l=>{await o.cancelQueries(["storeInformation",t]);const u=o.getQueryData(["storeInformation",t]);return o.setQueryData(["storeInformation",t],{...u,...l}),{previousStoreData:u}},onError:(l,u,n)=>{console.debug("variables",u,n),n!=null&&n.previousStoreData&&o.setQueryData(["storeInformation",t],n.previousStoreData),alert("更新錯誤，請重整頁面後再試"),console.error("Update store information error:",l)},onSettled:()=>{o.invalidateQueries(["storeInformation",t])}});return{updateStore:i,isError:d,isPending:a}},O=()=>{const t=x(s=>s.title),o=x(s=>s.toggleSidebar),{userInfo:r}=I(),[i,d]=g.useState({name:"",description:"",file:null,filePath:"",address:"",phoneNumber:"",businessHours:Array(7).fill().map(()=>Array(2).fill().map(()=>({first:"09:00",second:"18:00"})))}),{updateStore:a,isPending:l,isError:u}=R(r==null?void 0:r.storeId),n=async s=>{s.preventDefault();try{await a({name:i.name,picture:i.file?i.file:i.filePath,address:i.address,description:i.description,businessHours:i.businessHours})}catch(c){console.error("提交表單時發生錯誤:",c)}},p=e.jsx("button",{onClick:n,className:" bg-orange-500 text-white rounded-lg px-3 py-1 font-sm shadow-md relative right-4  w-[60px]",children:l?e.jsx(y,{icon:F.faEllipsis,beatFade:!0,size:"lg"}):"儲存"});return e.jsxs("div",{className:"flex flex-col h-screen",children:[e.jsx(H,{title:t,onLeftClick:o,rightComponents:[p]}),e.jsx("div",{className:"sticky top-[54px] mt-[54px] z-20 ",children:e.jsx(j,{storeId:r==null?void 0:r.storeId,formData:i,setFormData:d,isUpdating:l,isMutationError:u})})]})};export{O as default};
