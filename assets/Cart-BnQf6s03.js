import{a as w,A as S,b as D,u as T,r as f,P as o,j as e,C as k}from"./index-DYHXqZsK.js";import{u as q,C as M}from"./CartItemCard-Bw_ja-oE.js";import{f as A}from"./faEllipsis-CxEkbWIP.js";import{u as E}from"./useMutation-mPCfgLum.js";import{F as I,f as Q}from"./index-CmwBhuE2.js";import{N as g}from"./NormalHeader-CEzq1B6i.js";import{u as P}from"./useCategoryQueries-BIYTyedy.js";import{u as F}from"./useSystemContext-CjQp9xYW.js";import H from"./CartRemark-BH7nSIVF.js";import"./blur-DrY2LElb.js";import"./useQueries-Cnsg1vf2.js";const $=async(r,t)=>{const a=w.get("authToken");try{return(await S.patch("/v1/cart/send",{note:r},{headers:{Authorization:`Bearer ${a}`},signal:t})).data}catch(s){if(D.isCancel(s))console.debug("PATCH cart request cancelled");else throw console.error("PATCH cart error; ",s),s}},L=()=>{const r=T(),t=f.useRef(null),{mutateAsync:a,isPending:s,isSuccess:d,error:m}=E({mutationFn:async n=>{t.current&&t.current.abort();const i=new AbortController;t.current=i;const l=await $(n,t.current.signal);return t.current===i&&(t.current=null),l},onMutate:async()=>{await r.cancelQueries(["cart"]);const n=r.getQueryData(["cart"]),i=n?{...n}:{orderedDishes:[]};return i.orderedDishes||(i.orderedDishes=[]),r.setQueryData(["cart"],i),{previousCart:n}},onError:(n,i,l)=>{throw l!=null&&l.previousCart&&r.setQueryData(["cart"],l.previousCart),alert("訂單送出失敗，請重整頁面後再試試"),n},onSettled:()=>{console.debug("useCartAddMutation onSettled"),r.invalidateQueries(["cart"])}});return{sendCartAsync:a,sendCartError:m,sendCartIsPending:s,sendCartIsSuccess:d}},b=({orderDetail:r,handleChangeRemark:t})=>{const{totalSpend:a,estimateTime:s,cartData:d,remark:m}=r,{ispatchCartError:n}=q(),i=n?"bg-gray-300":"bg-white",{sendCartAsync:l,sendCartIsPending:u}=L(),x=async p=>{p.preventDefault(),!(a===0||(d==null?void 0:d.orderedDishes.length)===0)&&(t(""),await l(m))};return e.jsxs("div",{className:" fixed bottom-0 w-full bg-orange-400 px-4 py-2 rounded-t-lg  text-white font-notoTC font-medium",children:[e.jsxs("div",{className:"flex justify-between mb-3 px-2 text-sm",children:[e.jsx("span",{children:"總金額"}),e.jsxs("span",{children:["$ ",a]})]}),d.orderedDishes.length>0&&e.jsxs("div",{className:"flex justify-between mb-3 px-2 text-sm",children:[e.jsx("span",{children:"預估完成時間"}),e.jsxs("span",{children:[s," ~ ",s+20," 分鐘"]})]}),e.jsx("button",{className:`w-full ${i} text-orange-500 py-2 px-2 rounded-full font-semibold `,disabled:n,onClick:x,children:u?e.jsx(I,{icon:A.faEllipsis,beatFade:!0,size:"lg",className:"mr-2"}):"送出訂單"})]})};b.propTypes={orderDetail:o.shape({cartData:o.object.isRequired,totalSpend:o.number.isRequired,estimateTime:o.number.isRequired,remark:o.string.isRequired}).isRequired,handleChangeRemark:o.func.isRequired};const y=({orderDetail:r})=>{const{cartData:t,merchantName:a,totalSpend:s}=r;return e.jsxs("div",{className:"mt-[66px] flex justify-between items-center p-4 bg-white",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-gray-900",children:t.orderedDishes.length?a:""}),e.jsx("p",{className:"text-sm text-gray-500",children:"訂單詳細資訊"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"總金額"}),e.jsxs("h2",{className:"text-2xl font-bold text-black",children:["$",s]})]})]})};y.propTypes={orderDetail:o.shape({cartData:o.object.isRequired,merchantName:o.string,totalSpend:o.number.isRequired}).isRequired};const v=({cartData:r,dishesMap:t})=>!r.orderedDishes||r.orderedDishes.length===0?e.jsx("div",{className:"flex justify-center items-center mt-4 fa-2x",children:"目前購物車是空的:)"}):e.jsx("div",{children:r.orderedDishes.map((a,s)=>{var d;return e.jsx(M,{dishData:a,imageUrl:(d=t[a==null?void 0:a.dishId])==null?void 0:d.picture},s)})});v.propTypes={cartData:o.object.isRequired,dishesMap:o.object.isRequired};const Z=()=>{const{userInfo:r,cartData:t,isCartError:a,merchantData:s,isMerchantLoading:d,menuCategoryList:m,totalSpend:n,totalQuantity:i,refetchCart:l}=F();t===void 0&&(console.error("Cart not found, refetchCart"),l());const{categoryData:u,isQueriesSuccess:x}=P(m,s==null?void 0:s.menuId,r!==void 0&&(r==null?void 0:r.role)==="CUSTOMER"),[p,h]=f.useState(""),N=f.useMemo(()=>u?u==null?void 0:u.reduce((C,R)=>(R.dishes.forEach(j=>{C[j.id]=j}),C),{}):{},[u]);if(t===void 0||!x)return e.jsx(k,{});let c=10*i;return c>150&&c<300?c=Math.floor(c*.7):c>=300&&(c=Math.floor(c*.5)),a?e.jsxs("div",{className:"flex justify-center items-center mt-28 fa-2x",children:[e.jsx(g,{}),"購物車資料讀取失敗:("]}):e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex-none",children:[e.jsx(g,{leftIcon:Q,title:"購物車"}),e.jsx(y,{orderDetail:{cartData:t,merchantName:s==null?void 0:s.name,totalSpend:n}})]}),e.jsxs("div",{className:"flex-1 overflow-auto pb-[120px] ",children:[e.jsx(v,{cartData:t,dishesMap:N}),e.jsx("div",{className:"px-4",children:e.jsx(H,{onRemarkChange:h,value:p})})]}),e.jsx("div",{className:"flex-none",children:e.jsx(b,{orderDetail:{cartData:t,totalSpend:n,remark:p,estimateTime:c-(i>2?30:0)},handleChangeRemark:h})})]})};export{Z as default};
