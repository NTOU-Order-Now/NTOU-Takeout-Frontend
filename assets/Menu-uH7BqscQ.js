const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MenuNavbar-DcfcQwT_.js","assets/index-OyfSnvV0.js","assets/index-CEqBSek3.css","assets/merchantMenuNav-phqT_DS4.js","assets/MenuSection-kyC5R1yV.js","assets/useMutation-CvaJ0Pug.js","assets/skeleton-DmVPG9bm.js"])))=>i.map(i=>d[i]);
import{P as l,j as e,r as m,g as X,a as O,A as P,b as G,u as A,_ as T,c as J,d as Y}from"./index-OyfSnvV0.js";import{F as j,m as Z,d as _,n as ee,o as F,p as se,q as te,r as $}from"./index-COzbDde_.js";import{u as E}from"./sidebarStore-_FV24hSk.js";import{H as M}from"./Header-Bx_nG7py.js";import ne from"./NavbarSkeleton-DXIjei6W.js";import re from"./MenuSectionSkeleton-CzymON5L.js";import{u as ae}from"./useCategoryQueries-YqjCH9Fr.js";import{u as oe}from"./merchantMenuNav-phqT_DS4.js";import{f as ie}from"./faEllipsis-CxEkbWIP.js";import{u as le}from"./useImageUploadMutation-f6U98pHh.js";import{u as U}from"./useMutation-CvaJ0Pug.js";const Q=({dishName:a,onSave:o,onBack:i,isPending:s})=>{const d=e.jsx("button",{onClick:o,className:"bg-orange-400 text-white px-4 py-1 rounded-lg font-bold hover:bg-orange-600",children:s?e.jsx(j,{icon:ie.faEllipsis,beatFade:!0,size:"lg",className:"mr-2"}):"保存"});return e.jsx(M,{LeftIcon:e.jsx(j,{icon:Z}),title:a,onLeftClick:i,rightComponents:[d]})};Q.propTypes={dishName:l.string.isRequired,onSave:l.func,onBack:l.func,isPending:l.bool};const V=({defaultName:a,defaultDescription:o,defaultPrice:i,defaultCategory:s,defaultImage:d,categoryNames:u=[],onNameChange:t,onDescriptionChange:n,onPriceChange:c,onCategoryChange:p,onImageChange:h})=>{const{uploadImage:b,isPending:x,isError:w}=le(),v=async f=>{const y=f.target.files[0];if(y)try{h({url:null}),console.debug("file:",y);const D=await b(y);h({url:D})}catch(D){console.error("upload Failed:",D),h({url:null})}};return e.jsxs("div",{className:"mt-10 p-6 bg-white",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"名稱："}),e.jsx("input",{type:"text",defaultValue:a,placeholder:"請輸入名稱",className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:f=>t(f.target.value)})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"商品描述："}),e.jsx("textarea",{defaultValue:o,placeholder:"請輸入商品描述",className:"w-full h-24 px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:f=>n(f.target.value)})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"圖片："}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"flex-1 relative",children:e.jsx("input",{type:"text",value:d||"",placeholder:"請選擇圖片",readOnly:!0,className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none"})}),e.jsx("label",{htmlFor:"dish-image-upload",className:`
                            flex-shrink-0 px-6 py-2 rounded-md
                            ${x?"bg-gray-400 cursor-not-allowed":"bg-orange-400 hover:bg-orange-600 cursor-pointer"}
                            text-white transition-colors duration-200
                        `,children:x?e.jsxs(e.Fragment,{children:[e.jsx(j,{icon:_,className:"mr-2 animate-spin"}),"上傳中"]}):e.jsxs(e.Fragment,{children:[e.jsx(j,{icon:ee,className:"mr-2"}),"上傳圖片"]})}),e.jsx("input",{id:"dish-image-upload",type:"file",className:"hidden",onChange:v,accept:"image/*",disabled:x})]}),d&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:d,alt:"商品圖片",className:"w-32 h-32 object-cover rounded-lg shadow-md"})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"價格："}),e.jsx("input",{type:"number",defaultValue:i,placeholder:"請輸入價格",className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:f=>c(Number(f.target.value))})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"類別："}),e.jsx("input",{type:"text",defaultValue:s,placeholder:"請輸入類別",list:"category-options",className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:f=>p(f.target.value)}),e.jsx("datalist",{id:"category-options",children:u.map((f,y)=>e.jsx("option",{value:f},y))})]})]})};V.propTypes={defaultName:l.string,defaultDescription:l.string,defaultPrice:l.oneOfType([l.string,l.number]),defaultImage:l.string,defaultCategory:l.string,onImageUpload:l.func,categoryNames:l.arrayOf(l.string),onNameChange:l.func.isRequired,onDescriptionChange:l.func.isRequired,onPriceChange:l.func.isRequired,onCategoryChange:l.func.isRequired,onImageChange:l.func.isRequired};const z=({option:a,onDelete:o,onUpdate:i})=>{const[s,d]=m.useState(!1),[u,t]=m.useState(!1),n=m.useRef(null);m.useEffect(()=>{n.current&&(s||u)&&n.current.focus()},[s,u]);const c=h=>{const b=h.target.value;h.type==="keydown"&&h.key!=="Enter"||(d(!1),i({name:b}))},p=h=>{const b=h.target.value;h.type==="keydown"&&h.key!=="Enter"||(t(!1),i({extraCost:parseFloat(b)||0}))};return e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[s?e.jsx("input",{ref:n,type:"text",defaultValue:a.name,onBlur:c,onKeyDown:c,className:"border rounded px-2 py-1 text-lg focus:ring-orange-400"}):e.jsx("span",{onClick:()=>d(!0),className:"cursor-pointer hover:underline text-xl",children:a.name}),u?e.jsx("input",{ref:n,type:"number",defaultValue:a.extraCost,onBlur:p,onKeyDown:p,className:"border rounded px-2 py-1 text-sm focus:ring-orange-400"}):e.jsxs("span",{onClick:()=>t(!0),className:"px-3 border rounded-xl text-black border-black cursor-pointer hover:underline",children:["+ ",a.extraCost,"元"]})]}),e.jsx("button",{className:"text-red-400 hover:text-red-700",onClick:o,children:e.jsx(j,{icon:F})})]})};z.propTypes={option:l.shape({name:l.string.isRequired,extraCost:l.number.isRequired}).isRequired,onDelete:l.func.isRequired,onUpdate:l.func.isRequired};function B({options:a,selectedOption:o,onChange:i}){const s=Object.keys(a),d=s.findIndex(t=>t===o),u=100/s.length;return e.jsx("div",{className:"relative  h-full  w-full",children:e.jsxs("div",{className:"relative border-gray-200 border-2 h-full flex overflow-hidden rounded-xl",children:[e.jsx("div",{className:"absolute h-full bg-orange-500 transition-transform duration-300 ease-in-out rounded-xl",style:{width:`${u}%`,transform:`translateX(${d*100}%)`}}),s.map(t=>{const n=t===o;return e.jsx("button",{onClick:()=>i(t),className:`
                                relative flex-1 text-center text-sm font-bold 
                                transition-colors duration-300 ease-in-out z-10
                                ${n?"text-white":"text-black"}
                            `,children:t},t)})]})})}B.propTypes={options:l.object.isRequired,selectedOption:l.string.isRequired,onChange:l.func.isRequired};const L=({group:a,groupIndex:o,onUpdateGroup:i,onDeleteGroup:s})=>{const[d,u]=m.useState(!1),[t,n]=m.useState(a.name),[c,p]=m.useState(a.isRequired),[h,b]=m.useState(a.type),[x,w]=m.useState(a.attributeOptions||[]),v=()=>{u(!1),N()},f=()=>{const r={name:"新選項",extraCost:0,isChosen:!1},g=[...x,r];w(g),N({attributeOptions:g})},y=r=>{const g=x.filter((C,I)=>I!==r);w(g),N({attributeOptions:g})},D=(r,g)=>{const C=x.map((I,W)=>W===r?{...I,...g}:I);w(C),N({attributeOptions:C})},N=r=>{const g={...a,name:t,isRequired:c,type:h,attributeOptions:x,...r};i(g)},S={單選:()=>{b("single"),N({type:"single"})},複選:()=>{b("multiple"),N({type:"multiple"})}},k=h==="single"?"單選":"複選",R=()=>{const r=!c;p(r),N({isRequired:r})};return e.jsxs("div",{className:"p-4 bg-white border rounded-lg shadow-md mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[d?e.jsx("input",{type:"text",value:t,onChange:r=>n(r.target.value),onKeyDown:r=>{r.key==="Enter"&&v()},className:"border rounded px-2 py-1 text-lg font-bold focus:ring-orange-500 focus:outline-none"}):e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:"font-bold text-xl",children:t}),e.jsx("span",{className:`px-2 py-1 rounded-lg text-white text-sm cursor-pointer ${c?"bg-red-500":"bg-gray-500"}`,onClick:R,children:"必選"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{className:"text-orange-500 hover:text-orange-700 text-xl",onClick:()=>{d?v():u(!0)},children:e.jsx(j,{icon:d?se:te})}),e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:s,children:e.jsx(j,{icon:F})})]})]}),x.map((r,g)=>e.jsx(z,{option:r,onDelete:()=>y(g),onUpdate:C=>D(g,C)},g)),e.jsx("button",{className:"text-orange-500 mt-2 text-lg",onClick:f,children:"新增選項..."}),e.jsx("div",{className:"flex justify-end space-x-4 mt-4",children:e.jsx("div",{className:"flex w-[120px] h-10 overflow-hidden",children:e.jsx(B,{options:S,selectedOption:k,onChange:r=>{S[r]()}})})})]})};L.propTypes={group:l.object.isRequired,groupIndex:l.number.isRequired,onUpdateGroup:l.func.isRequired,onDeleteGroup:l.func.isRequired};const K=({groups:a,onGroupsChange:o})=>{const i=u=>{const t=a.filter((n,c)=>c!==u);o(t)},s=(u,t)=>{const n=a.map((c,p)=>p===u?t:c);o(n)},d=()=>{const u={name:"新選項標題",description:"",type:"single",isRequired:!1,attributeOptions:[]};o([...a,u])};return e.jsxs("div",{className:"p-4 bg-white mt-4",children:[a.map((u,t)=>e.jsx(L,{groupIndex:t,group:u,onUpdateGroup:n=>s(t,n),onDeleteGroup:()=>i(t)},t)),e.jsx("div",{className:"flex justify-center mt-6 z-50",children:e.jsxs("button",{className:"text-orange-500 hover:text-orange-700 flex items-center",onClick:d,children:[e.jsx(j,{icon:$,size:"lg",className:"mr-2"}),"新增客製化選項"]})})]})};K.propTypes={groups:l.array.isRequired,onGroupsChange:l.func.isRequired};const q=X(a=>({selectedDish:null,setSelectedDish:o=>a({selectedDish:o})})),ce=async({menuId:a,id:o,name:i,description:s,picture:d,price:u,category:t,dishAttributes:n},c)=>{if(i===""||u===null||t===""||s==="")throw new Error("content can't be empty");try{const p=O.get("authToken");return(await P.put(`/v2/menu/${a}/dish/${o}`,{name:i,description:s,picture:d,price:u,category:t,dishAttributes:n},{signal:c,headers:{Authorization:`Bearer ${p}`}})).data}catch(p){if(G.isCancel(p)){console.debug("Update dish request cancelled");return}throw console.error(`Failed to update dish (ID: ${o}) in menu (ID: ${a}):`,p),p}},de=a=>{const o=A(),i=m.useRef(null),{mutateAsync:s,isError:d,isPending:u}=U({mutationFn:async t=>{i.current&&i.current.abort();const n=new AbortController;return i.current=n,await ce({menuId:a,...t},n.signal),i.current===n&&(i.current=null),t.category},onMutate:async t=>{const{category:n,id:c}=t;await o.cancelQueries(["categoryDishes",n]);const p=o.getQueryData(["categoryDishes",n]);return o.setQueryData(["categoryDishes",n],{categoryName:n,dishes:p.dishes.map(h=>h.id===c?s:h)}),{previousDishes:p,category:n}},onError:(t,n,c)=>{console.debug("error",n,c),c!=null&&c.previousDishes&&o.setQueryData(["categoryDishes",c.category],c.previousDishes),alert("更新錯誤，請確保所有欄位都不為空"),console.error("Update dish error:",t)},onSettled:t=>{o.invalidateQueries(["categoryDishes",t])}});return{updateDish:s,isError:d,isPending:u}};function H({onClose:a,categoryNames:o,menuId:i}){const s=q(r=>r.selectedDish),[d,u]=m.useState(s.name),[t,n]=m.useState(s.description),[c,p]=m.useState(s.price),[h,b]=m.useState(s.category),[x,w]=m.useState(s.dishAttributes),[v,f]=m.useState(s.picture),y=({url:r})=>{r&&f(r)},{updateDish:D,isPending:N}=de(i),S=async()=>{const r=v,g={id:s.id,name:d,description:t,picture:r,price:c,category:h,dishAttributes:x};try{await D(g),a()}catch(C){console.error("更新失敗：",C)}},k=()=>{a()},R=r=>{w(r)};return e.jsxs("div",{children:[e.jsx(Q,{dishName:d,onBack:k,onSave:S,isPending:N}),e.jsx(V,{defaultName:d,defaultDescription:t,defaultPrice:c,defaultImage:v,defaultCategory:h,categoryNames:o,onNameChange:u,onDescriptionChange:n,onPriceChange:p,onCategoryChange:b,onImageChange:y}),e.jsx(K,{groups:x,onGroupsChange:R})]})}H.propTypes={onClose:l.func.isRequired,categoryNames:l.arrayOf(l.string),menuId:l.string.isRequired};const ue=async(a,o)=>{const i=O.get("authToken");try{return(await P.get(`/v2/menu/${a}/dish/create`,{signal:o,headers:{Authorization:`Bearer ${i}`}})).data}catch(s){if(G.isCancel(s)){console.debug("Get new dish ID request cancelled");return}throw console.error(`Failed to get new dish ID for menu (ID: ${a}):`,s),s}},pe=a=>{const o=A(),i=m.useRef(null),s="",{mutateAsync:d,isError:u,isPending:t}=U({mutationFn:async()=>{i.current&&i.current.abort();const n=new AbortController;i.current=n;const c=await ue(a,n.signal);return i.current===n&&(i.current=null),c},onMutate:async()=>{await o.cancelQueries(["categoryDishes",s]);const n=o==null?void 0:o.getQueryData(["categoryDishes",s]),c={id:`temp-${Date.now()}`,name:"",description:"",picture:"",price:null,category:s,salesVolume:0,dishAttributes:[]};return o.setQueryData(["categoryDishes",s],{categoryName:"",dishes:n?[n.dishes,c]:[c]}),{previousDishes:n}},onError:(n,c,p)=>{p!=null&&p.previousDishes?o.setQueryData(["categoryDishes",s],p.previousDishes):o.setQueryData(["categoryDishes",s],[]),alert("創建失敗，請重整頁面再試一次"),console.error("Create new dish error:",n)},onSettled:()=>{o.invalidateQueries(["menuCategoryList",a]),o.invalidateQueries(["categoryDishes"],s)}});return{createDish:d,isError:u,isPending:t}},me=m.lazy(()=>T(()=>import("./MenuNavbar-DcfcQwT_.js"),__vite__mapDeps([0,1,2,3]))),he=m.lazy(()=>T(()=>import("./MenuSection-kyC5R1yV.js").then(a=>a.M),__vite__mapDeps([4,1,2,5,6]))),ge=()=>{const a=E(r=>r.toggleSidebar),o=E(r=>r.title),{userInfo:i,merchantData:s,menuCategoryList:d}=J();i==null||i.id;const u=i==null?void 0:i.storeId,t=s==null?void 0:s[0].menuId,{categoryData:n}=ae(d,s==null?void 0:s[0].menuId,i!==void 0),c=Y(),p=m.useRef([]),[h,b]=m.useState(!1),x=oe(r=>r.setNavbarItems),{createDish:w,isPending:v}=pe(t),f=r=>{var g;(g=p.current[r])==null||g.scrollIntoView({behavior:"smooth",inline:"start"})},y=q(r=>r.selectedDish),D=q(r=>r.setSelectedDish);m.useEffect(()=>{x(d==null?void 0:d.map(r=>r.categoryName))},[d,x]);const N=async()=>{await w(t)},S=e.jsx("button",{onClick:N,className:"bg-orange-500 text-white rounded-lg p-2 flex  shadow-md content-center w-full h-full",children:v?e.jsx(j,{icon:_,spinPulse:!0,style:{color:"#ffffff"},size:"xs"}):e.jsx(j,{icon:$})}),k=e.jsx("button",{onClick:()=>{c(`/menu/${u}`)},className:" bg-slate-400 text-white rounded-lg px-3 py-1 font-sm shadow-md",children:"預覽"}),R=d.map(r=>r.categoryName);return y?e.jsx(H,{onClose:()=>{D(null)},categoryNames:R,menuId:t}):e.jsxs("div",{className:"flex flex-col h-screen",children:[e.jsx(M,{title:o,onLeftClick:a,rightComponents:[S,k]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"sticky top-[54px] mt-[54px] z-20 shadow-sm",children:e.jsx(m.Suspense,{fallback:e.jsx(ne,{isNavbarFixed:!1}),children:e.jsx(me,{onNavClick:f,isNavbarFixed:h})})}),e.jsx("div",{className:"overflow-auto h-[dvh-34px]  ",children:e.jsx(m.Suspense,{fallback:e.jsx(re,{}),children:e.jsx(he,{menuId:t,sectionRefs:p,categoryData:n})})})]})]})},ke=Object.freeze(Object.defineProperty({__proto__:null,default:ge},Symbol.toStringTag,{value:"Module"}));export{ke as M,q as u};
