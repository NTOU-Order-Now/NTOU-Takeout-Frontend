import{a as N,A as y,b as S,u as C,r as m,P as g,j as t}from"./index-CFrlWo3n.js";import{H as v}from"./Header-CdveAT2q.js";import{u as f}from"./sidebarStore-JTAWPSbi.js";import{u as w}from"./useMutation-DcNzvGfk.js";import{a as T,u as j}from"./index-B00z8IGU.js";import{T as O}from"./ToggleNavBar-ebeYBKy5.js";const A=async(e,o,r)=>{try{const n=N.get("authToken");return(await y.patch(`/v1/order/${e}/status`,null,{headers:{Authorization:`Bearer ${n}`},params:{status:o},signal:r})).data}catch(n){if(S.isCancel(n)){console.debug("Update order status request cancelled");return}throw console.error("Update order status error:",n),n}},I=()=>{const e=C(),o=m.useRef(null),{mutateAsync:r,isError:n,error:i,isLoading:a}=w({mutationFn:async({orderId:d,newStatus:l})=>{o.current&&(console.debug("Abort previous updateOrderStatus request"),o.current.abort());const s=new AbortController;o.current=s;const u=await A(d,l,s.signal);return o.current===s&&(o.current=null),u},onMutate:async({orderId:d,newStatus:l})=>{await e.cancelQueries(["orders"]);const s=e.getQueryData(["orders"]),u=s==null?void 0:s.pages.map(x=>x.map(c=>c.id===d?{...c,status:l,...l==="PROCESSING"&&{acceptTime:new Date().toISOString().replace("T"," ").slice(0,19)}}:c));return u&&e.setQueryData(["orders"],x=>({...x,pages:u})),{previousOrders:s}},onError:(d,l,s)=>{s!=null&&s.previousOrders&&e.setQueryData(["orders"],s.previousOrders),alert("更新訂單狀態失敗，請稍後再試"),console.error("Update order status error:",d)},onSettled:()=>{console.debug("updateOrderStatusAsync onSettled"),e.invalidateQueries(["orders"])}});return{updateOrderStatusAsync:r,isError:n,error:i,isLoading:a}},D=e=>{switch(e){case"PROCESSING":return{bgColor:"bg-blue-500",textColor:"text-gray-100",statusText:"製作中"};case"COMPLETED":return{bgColor:"bg-yellow-500",textColor:"text-gray-100",statusText:"未取餐"};case"PICKED_UP":return{bgColor:"bg-lime-600",textColor:"text-gray-100",statusText:"已取餐"};case"CANCELED":return{bgColor:"bg-gray-500",textColor:"text-gray-100",statusText:"取消"};default:return{bgColor:"bg-gray-200",textColor:"text-gray-100",statusText:""}}},h=e=>{switch(e){case"PROCESSING":return"COMPLETED";case"COMPLETED":return"PICKED_UP";case"PENDING":return"PROCESSING";default:return null}},b=({order:e,showStatus:o=!0})=>{const{bgColor:r,textColor:n,statusText:i}=D(e.status),{updateOrderStatusAsync:a,isLoading:d}=I(),l=m.useCallback(async c=>{try{await a({orderId:c,newStatus:"PROCESSING"}),console.debug("Accept order: ",c)}catch(p){console.error("Failed to accept order:",p)}},[a]),s=m.useCallback(async c=>{try{await a({orderId:c,newStatus:"CANCELED"}),console.debug("Reject order: ",c)}catch(p){console.error("Failed to reject order:",p)}},[a]),u=()=>{const c=new Date,p=new Date(e.estimatedPrepTime);return e.status==="PROCESSING"&&c>p},x=m.useCallback(async()=>{const c=h(e.status);if(c)try{await a({orderId:e.id,newStatus:c})}catch(p){console.error("Failed to update order status:",p)}},[e.id,e.status,a]);return t.jsxs("div",{className:"relative flex justify-between rounded-lg p-4 shadow-lg mb-6 bg-gray-50",children:[t.jsxs("div",{className:"flex flex-col items-start text-start",children:[t.jsxs("p",{className:"text-xl font-bold ",children:["單號： ",e.id.slice(-5)]}),t.jsxs("p",{className:"text-sm font-semibold ",children:["預估製作時間: ",e.estimatedPrepTime," 分鐘"]}),t.jsxs("p",{className:"text-sm font-medium",children:["下單時間: ",e.orderTime]}),t.jsx("button",{className:"bg-orange-500 mt-6 text-white px-3 py-1 text-sm font-bold rounded hover:bg-orange-600",children:"訂單內容"})]}),t.jsxs("div",{className:"flex flex-col items-end",children:[o&&e.status!=="PENDING"&&t.jsxs("div",{className:"flex items-center mb-2",children:[u()&&t.jsx("span",{className:"text-red-500 text-sm ml-2 font-bold pr-2",children:"超時"}),t.jsx("button",{onClick:x,disabled:!h(e.status),className:`px-3 py-1 rounded-md text-sm font-bold ${r} ${n} ${h(e.status)?"":"opacity-50 cursor-not-allowed"}`,children:i})]}),e.status==="PENDING"&&t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:()=>s(e.id),className:"bg-red-500 text-white px-3 py-1 text-sm font-bold rounded hover:bg-red-600",children:"拒絕"}),t.jsx("button",{onClick:()=>l(e.id),className:"bg-green-500 text-white px-3 py-1 text-sm font-bold rounded hover:bg-green-600",children:"接單"})]})]}),t.jsx("div",{className:"absolute bottom-4 right-4 mt-5",children:t.jsxs("p",{className:"mt-2 font-semibold",children:["總金額: ",e.cost," 元"]})})]})};b.propTypes={order:g.shape({id:g.string.isRequired,status:g.string.isRequired,cost:g.number.isRequired,orderTime:g.string.isRequired,estimatedPrepTime:g.number.isRequired}).isRequired,onAccept:g.func,onReject:g.func,onStatusChange:g.func,showStatus:g.bool};const R=async(e={},o)=>{try{const{page:r=0,size:n=3,status:i}=e,a=new URLSearchParams({page:r.toString(),size:n.toString()});i&&a.append("status",i);const d=N.get("authToken");return(await y.get(`/v1/order/search?${a.toString()}`,{headers:{Authorization:`Bearer ${d}`},signal:o})).data}catch(r){if(S.isCancel(r)){console.debug("Search order request cancelled");return}throw console.error("Search order error:",r),r}},P=e=>{const{data:r,fetchNextPage:n,hasNextPage:i,isFetchingNextPage:a,isLoading:d,isError:l,error:s}=T({queryKey:["orders",e],queryFn:async({pageParam:u=0})=>{const x=await R({page:u,size:3,status:e});return console.debug("response",x.data),x.data},getNextPageParam:(u,x)=>{const c=x.length-1;return u.length===3?c+1:void 0},staleTime:6e4});return{orders:r,fetchNextPage:n,hasNextPage:i,isFetchingNextPage:a,isLoading:d,isError:l,error:s}},L=()=>{const{ref:e,inView:o}=j({rootMargin:"100px"}),{orders:r,fetchNextPage:n,hasNextPage:i,isFetchingNextPage:a,isLoading:d,isError:l,error:s}=P("PENDING");return m.useEffect(()=>{o&&!a&&i&&n()},[o,a,i,n]),d?t.jsx("div",{className:"text-center pt-20",children:"Loading..."}):l?t.jsxs("div",{className:"text-center pt-20",children:["Error: ",s.message]}):t.jsxs("div",{className:"flex flex-col text-center justify-between ",children:[r==null?void 0:r.pages.map(u=>u.map((x,c)=>t.jsx(b,{order:x},c))),t.jsx("div",{ref:e,children:i&&a&&t.jsx("div",{className:"text-center py-4",children:"Loading more..."})})]})};function E(){const{ref:e,inView:o}=j({rootMargin:"100px"}),{orders:r,fetchNextPage:n,hasNextPage:i,isFetchingNextPage:a,isLoading:d,isError:l,error:s}=P("PROCESSING");return m.useEffect(()=>{o&&!a&&i&&n()},[o,a,i,n]),d?t.jsx("div",{className:"text-center pt-20",children:"Loading..."}):l?t.jsxs("div",{className:"text-center pt-20",children:["Error: ",s.message]}):t.jsxs("div",{className:"flex flex-col text-center justify-between ",children:[r==null?void 0:r.pages.map(u=>u.map((x,c)=>t.jsx(b,{order:x},c))),t.jsx("div",{ref:e,children:i&&a&&t.jsx("div",{className:"text-center py-4",children:"Loading more..."})})]})}E.prototype={orderData:g.object};const M=()=>{C().getQueryData(["order","PENDING"]);const[o,r]=m.useState(0),n=f(s=>s.toggleSidebar),i=f(s=>s.title),l={未接受:()=>{r(0),console.debug("handleToUnaccepted")},已接受:()=>{r(1),console.debug("handleToAccepted")}};return t.jsxs("div",{className:"h-dvh",children:[t.jsx(v,{title:i,onLeftClick:n}),t.jsx("div",{className:"sticky top-[55px] z-20 px-10   h-[85px] bg-white content-center rounded-2xl shadow-md ",children:t.jsx(O,{options:l,InitActiveTab:"未接受"})}),t.jsx("div",{className:"relative top-20 mx-8",children:o===0?t.jsx(L,{}):t.jsx(E,{})})]})};export{M as default};
