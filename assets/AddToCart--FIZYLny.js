const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ConfirmClearCartModal-D1P1Di1n.js","assets/index-BVyBSOmJ.js","assets/index-AsxfWBjN.css"])))=>i.map(i=>d[i]);
import{a as y,A as b,b as A,u as D,r as h,_ as M,d as S,j as f,P as m}from"./index-BVyBSOmJ.js";import{u as E}from"./useMutation-DJX0FVuL.js";import{u as p}from"./MenuDishDetail-a-Fj9wSe.js";import"./index.es-BJrB9fUl.js";import"./index-CuE17EBt.js";import"./blur-DLlne5MJ.js";import"./react-CxkCoJ2v.js";const Q=async t=>{try{const r=y.get("authToken");return(await b.delete("/v1/cart",{headers:{Authorization:`Bearer ${r}`},signal:t})).data}catch(r){if(A.isCancel(r)){console.debug("DELETE cart request cancelled");return}else console.error("DELETE cart error:",r);throw r}},R=async(t,r)=>{try{const o=y.get("authToken");return(await b.post("/v1/cart/dishes",r,{headers:{Authorization:`Bearer ${o}`},signal:t})).data}catch(o){if(A.isCancel(o)){console.debug("POST cart request cancelled");return}else console.error("POST cart error:",o);throw o}},g=()=>{const t=D(),r=h.useRef(null),{mutateAsync:o,onError:i,onMutate:l,isError:d}=E({mutationFn:async s=>{r.current&&r.current.abort();const c=new AbortController;r.current=c;const e=await R(r.current.signal,s);return r.current===c&&(r.current=null),e},onMutate:async s=>{await t.cancelQueries(["cart"]);const c=t.getQueryData(["cart"]),e=c?{...c}:{orderedDishes:[]};e.orderedDishes||(e.orderedDishes=[]);const n=e.orderedDishes.findIndex(a=>a.dishId===s.dishId&&a.chosenAttributes===s.chosenAttributes);if(n>-1){const a=e.orderedDishes[n];e.orderedDishes=[...e.orderedDishes.slice(0,n),{...a,quantity:a.quantity+s.quantity,note:s.note||a.note},...e.orderedDishes.slice(n+1)]}else e.orderedDishes.push({id:crypto.randomUUID(),dishId:s.dishId,dishName:s.dishName,price:s.price,quantity:s.quantity,note:s.note||"",chosenAttributes:s.chosenAttributes||[],storeId:s.storeId});return t.setQueryData(["cart"],e),{previousCart:c}},onError:(s,c,e)=>{e!=null&&e.previousCart&&t.setQueryData(["cart"],e.previousCart),alert("新增購物車失敗，請稍後再試")},onSettled:()=>{console.debug("patchCartAsync onSettled"),t.invalidateQueries(["cart"])}});return{postCartAsync:o,postCartError:i,postCartOnMutate:l,postCartIsError:d}},O=()=>{const t=D(),r=h.useRef(null),{postCartAsync:o}=g(),{mutateAsync:i,onError:l,onSuccess:d,onMutate:s,isError:c}=E({mutationFn:async e=>{r.current&&r.current.abort();const n=new AbortController;return r.current=n,await Q(r.current.signal),r.current===n&&(r.current=null),e},onMutate:async e=>{await t.cancelQueries(["cart"]);const n=t.getQueryData(["cart"]);return n&&{...n},console.debug("previousCart",n),t.setQueryData(["cart"],[]),{previousCart:n}},onSuccess:e=>{o(e)},onError:(e,n,a)=>{a!=null&&a.previousCart&&t.setQueryData(["cart"],a.previousCart),alert("刪除購物車失敗，請稍後再試")},onSettled:()=>{console.debug("deleteCartAsync onSettled"),t.invalidateQueries(["cart"])}});return{deleteCartAsync:i,deleteCartSuccess:d,deleteCartError:l,deleteCartOnMutate:s,deleteCartIsError:c}},_=h.lazy(()=>M(()=>import("./ConfirmClearCartModal-D1P1Di1n.js"),__vite__mapDeps([0,1,2]))),x=({dishId:t,onRequiredMissing:r,onClose:o})=>{const{cartData:i}=S(),[l,d]=h.useState(!1),s=p(u=>u.dishes),c=p(u=>u.allDishAttributes),{deleteCartAsync:e}=O(),{postCartAsync:n}=g(),a=()=>{d(!1);const u=s[t];e(u),o()},v=()=>{d(!1)},I=async()=>{const u=s[t];if(!u)return;const q=u.chosenAttributes||[],T=c[t]||[];for(const C of T)if(C.isRequired===!0&&q.filter(w=>w.attributeName===C.name).length===0){r(C.name);return}if(i!=null&&i.storeId&&(i==null?void 0:i.storeId)!==u.storeId){d(!0);return}n(u),o()};return f.jsxs("div",{className:"flex items-center justify-center",children:[f.jsx("button",{className:"shadow-md bg-orange-500 text-white text-md px-6 py-2 rounded-full border border-orange-700 font-notoTC",onClick:I,children:"加入"}),f.jsx(_,{isOpen:l,onCancel:v,onConfirm:a})]})};x.propTypes={dishId:m.string.isRequired,onRequiredMissing:m.func.isRequired,onClose:m.func.isRequired};export{x as default};
