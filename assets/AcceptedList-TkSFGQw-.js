const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/OrderCard-CB3xNLoX.js","assets/index-BYRL8AI_.js","assets/index-C6hs_cfB.css","assets/orderStore-DR24lrt6.js","assets/useMutation-DsXj7Dnr.js","assets/useSystemContext-a0QPEVCW.js","assets/useQueries-Cmt9nGbt.js"])))=>i.map(i=>d[i]);
import{a as E,A as L,b as w,u as q,r as g,P as f,c as Q,j as t,x as k,y as A,g as O,f as U,_ as V}from"./index-BYRL8AI_.js";import{u as z}from"./orderStore-DR24lrt6.js";import{u as F}from"./useMutation-DsXj7Dnr.js";import{u as K}from"./useSystemContext-a0QPEVCW.js";import{u as B}from"./useQueries-Cmt9nGbt.js";const H=async(e,s,o)=>{try{const n=E.get("authToken"),i=new URLSearchParams({status:s});return(await L.patch(`/v1/order/${e}/status?${i.toString()}`,null,{headers:{Authorization:`Bearer ${n}`},signal:o})).data}catch(n){if(w.isCancel(n)){console.debug("Update order status request cancelled");return}throw console.error("Update order status error:",n),n}},X=e=>{const s=q(),o=g.useRef(null),{mutateAsync:n,isError:i,error:x,isLoading:d}=F({mutationFn:async({orderId:a,newStatus:l})=>{o.current&&o.current.abort();const r=new AbortController;return o.current=r,await H(a,l,r.signal),o.current===r&&(o.current=null),{orderId:a,newStatus:l}},onMutate:async({orderId:a,newStatus:l})=>{const r=l==="PROCESSING"?"PENDING":"ALL";await s.cancelQueries(["orders",r,e]);const u=s.getQueryData(["orders",r,e]),c=u==null?void 0:u.content.map(p=>p.id===a?{...p,status:l,...l==="PROCESSING"&&{acceptTime:new Date().toISOString().replace("T"," ").slice(0,19)}}:p);return c&&s.setQueryData(["orders",r,e],{previousOrders:u,content:c}),{previousOrders:u}},onError:(a,l,r)=>{const u=l.newStatus==="PROCESSING"?"PENDING":"ALL";console.debug("newOrder",l,"context",r),r!=null&&r.previousOrders&&s.setQueryData(["orders",u,e],r.previousOrders),console.error("Update order status error:",a)},onSettled:({newStatus:a})=>{const l=a==="PROCESSING"?"PENDING":"ALL";console.debug("updateOrderStatusAsync onSettled"),s.invalidateQueries(["orders",l,e])}});return{updateOrderStatusAsync:n,isError:i,error:x,isLoading:d}},Z=e=>{switch(e){case"PENDING":return{bgColor:"bg-stone-600",textColor:"text-gray-100",statusText:"未接單"};case"PROCESSING":return{bgColor:"bg-blue-500",textColor:"text-gray-100",statusText:"製作中"};case"COMPLETED":return{bgColor:"bg-yellow-500",textColor:"text-gray-100",statusText:"未取餐"};case"PICKED_UP":return{bgColor:"bg-lime-600",textColor:"text-gray-100",statusText:"已取餐"};case"CANCELED":return{bgColor:"bg-gray-500",textColor:"text-gray-100",statusText:"取消"};default:return{bgColor:"bg-gray-200",textColor:"text-gray-100",statusText:""}}},S=e=>{switch(e){case"PROCESSING":return"COMPLETED";case"COMPLETED":return"PICKED_UP";case"PICKED_UP":return"CANCELED";case"PENDING":return"PROCESSING";default:return null}},R=({order:e,showStatus:s=!0})=>{const{bgColor:o,textColor:n,statusText:i}=Z(e.status),{updateOrderStatusAsync:x,isLoading:d}=X(),a=z(c=>c.setOrderData),l=g.useCallback(async()=>{const c=S(e.status);if(c)try{await x({orderId:e.id,newStatus:c})}catch(p){console.error("Failed to update order status:",p)}},[e.id,e.status,x]),r=Q(),u=c=>{c.preventDefault(),a(e),r(`/history/order/${e.id.slice(-5)}`)};return t.jsxs("div",{className:"relative flex justify-between rounded-lg p-4 shadow-lg mb-6 bg-gray-50",children:[t.jsxs("div",{className:"flex flex-col items-start text-start",children:[t.jsxs("p",{className:"text-xl font-bold ",children:["單號： ",e.id.slice(-5)]}),t.jsxs("p",{className:"text-sm font-semibold ",children:["預估製作時間: ",e.estimatedPrepTime," 分鐘"]}),t.jsxs("p",{className:"text-sm font-medium",children:["下單時間: ",e.orderTime]}),t.jsx("button",{className:"bg-orange-500 mt-6 text-white px-3 py-1 text-sm font-bold rounded hover:bg-orange-600",onClick:u,children:"訂單內容"})]}),t.jsx("div",{className:"flex flex-col items-end",children:s&&t.jsx("div",{className:"flex items-center mb-2",children:t.jsx("button",{onClick:l,disabled:!0,className:`px-3 py-1 rounded-md text-sm font-bold ${o} ${n} ${S(e.status)?"":"opacity-50 cursor-not-allowed"}`,children:i})})}),t.jsx("div",{className:"absolute bottom-4 right-4 mt-5",children:t.jsxs("p",{className:"mt-2 font-semibold",children:["總金額: ",e.cost," 元"]})})]})};R.propTypes={order:f.shape({id:f.string.isRequired,status:f.string.isRequired,cost:f.number.isRequired,orderTime:f.string.isRequired,estimatedPrepTime:f.number.isRequired}).isRequired,onAccept:f.func,onReject:f.func,onStatusChange:f.func,showStatus:f.bool};var v="Progress",P=100,[J,pe]=k(v),[W,Y]=J(v),D=g.forwardRef((e,s)=>{const{__scopeProgress:o,value:n=null,max:i,getValueLabel:x=ee,...d}=e;(i||i===0)&&!j(i)&&console.error(te(`${i}`,"Progress"));const a=j(i)?i:P;n!==null&&!C(n,a)&&console.error(se(`${n}`,"Progress"));const l=C(n,a)?n:null,r=b(l)?x(l,a):void 0;return t.jsx(W,{scope:o,value:l,max:a,children:t.jsx(A.div,{"aria-valuemax":a,"aria-valuemin":0,"aria-valuenow":b(l)?l:void 0,"aria-valuetext":r,role:"progressbar","data-state":$(l,a),"data-value":l??void 0,"data-max":a,...d,ref:s})})});D.displayName=v;var T="ProgressIndicator",I=g.forwardRef((e,s)=>{const{__scopeProgress:o,...n}=e,i=Y(T,o);return t.jsx(A.div,{"data-state":$(i.value,i.max),"data-value":i.value??void 0,"data-max":i.max,...n,ref:s})});I.displayName=T;function ee(e,s){return`${Math.round(e/s*100)}%`}function $(e,s){return e==null?"indeterminate":e===s?"complete":"loading"}function b(e){return typeof e=="number"}function j(e){return b(e)&&!isNaN(e)&&e>0}function C(e,s){return b(e)&&!isNaN(e)&&e<=s&&e>=0}function te(e,s){return`Invalid prop \`max\` of value \`${e}\` supplied to \`${s}\`. Only numbers greater than 0 are valid max values. Defaulting to \`${P}\`.`}function se(e,s){return`Invalid prop \`value\` of value \`${e}\` supplied to \`${s}\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or ${P} if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`}var G=D,re=I;const _=g.forwardRef(({className:e,value:s,...o},n)=>t.jsx(G,{ref:n,className:O("relative h-2 w-full overflow-hidden rounded-full bg-primary/20",e),...o,children:t.jsx(re,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(s||0)}%)`}})}));_.displayName=G.displayName;const ae=async(e={},s)=>{try{const{page:o=0,size:n=3,status:i}=e,x=new URLSearchParams({page:o.toString(),size:n.toString()});i&&x.append("status",i);const d=E.get("authToken");return(await L.get(`/v1/order/search?${x.toString()}`,{headers:{Authorization:`Bearer ${d}`},signal:s})).data}catch(o){if(w.isCancel(o)){console.debug("Search order request cancelled");return}throw console.error("Search order error:",o),o}},M=U(e=>({acceptedListNumber:1,setAcceptedListNumber:s=>e({acceptedListNumber:s}),unacceptedListNumber:1,setUnacceptedListNumber:s=>e({unacceptedListNumber:s})})),oe=e=>{const{acceptedListNumber:o,setAcceptedListNumber:n,unacceptedListNumber:i,setUnacceptedListNumber:x}=M();let d=e==="ALL"?o:i;d<=0&&(d=1);const a=g.useMemo(()=>Array.from({length:d},(r,u)=>u),[d]);return{...B({queries:a==null?void 0:a.map(r=>({queryKey:["orders",e,r],queryFn:async({signal:u})=>{const c=await ae({page:r,size:5,status:e==="ALL"?null:e},u);return c.data.totalPages!==d&&(e==="ALL"?n(c.data.totalPages):x(c.data.totalPages)),c.data}})),combine:r=>{var y;const u=r.filter(m=>m.isSuccess&&m.data),c=d,p=r.filter(m=>m.isSuccess||m.isError).length,h=Math.round(p/c*180);return{orders:{pages:u.map(m=>m.data)},isQueriesSuccess:r.every(m=>m.isSuccess),isLoading:r.some(m=>m.isLoading),isError:r.some(m=>m.isError),error:(y=r.find(m=>m.error))==null?void 0:y.error,progress:h,completedQueries:p}}})}};function N({className:e,...s}){return t.jsx("div",{className:O("animate-pulse rounded-md bg-primary/10",e),...s})}const ne=()=>t.jsxs("div",{className:"relative flex justify-between rounded-lg p-4 shadow-lg mb-6 bg-gray-50",children:[t.jsxs("div",{className:"flex flex-col items-start text-start",children:[t.jsxs("div",{className:"mb-2",children:[t.jsx(N,{className:"w-32 h-7"})," "]}),t.jsxs("div",{className:"mb-1",children:[t.jsx(N,{className:"w-48 h-5"})," "]}),t.jsxs("div",{className:"mb-2",children:[t.jsx(N,{className:"w-40 h-5"})," "]}),t.jsx(N,{className:"w-20 h-8 mt-6"})," "]}),t.jsx("div",{className:"flex flex-col items-end",children:t.jsxs("div",{className:"flex items-center mb-2",children:[t.jsx(N,{className:"w-16 h-8"})," "]})}),t.jsxs("div",{className:"absolute bottom-4 right-4",children:[t.jsx(N,{className:"w-32 h-6"})," "]})]}),ie=g.lazy(()=>V(()=>import("./OrderCard-CB3xNLoX.js"),__vite__mapDeps([0,1,2,3,4,5,6])));function le(){const{orders:e,isLoading:s,isError:o,error:n,progress:i,completedQueries:x}=oe("ALL"),{userInfo:d}=K(),a=d==null?void 0:d.role,l=e==null?void 0:e.pages.map(u=>u.content.filter(c=>a==="MERCHANT"?c.status!=="PENDING":c.status!=="PENDING"&&c.status!=="PROCESSING"&&c.status!=="COMPLETED")),{acceptedListNumber:r}=M();return s||i<180?t.jsx("div",{className:"w-full flex justify-center mt-20",children:t.jsxs("div",{className:"w-3/5 flex flex-col justify-center items-center",children:[t.jsx(_,{value:i,className:"w-full"}),t.jsxs("div",{className:"text-sm text-gray-500",children:["Loading ",x," of ",r," ..."]})]})}):l[0].length===0?t.jsx("div",{className:"w-full flex justify-center mt-20",children:t.jsx("div",{className:"w-3/5 flex flex-col justify-center items-center",children:t.jsx("div",{className:"text-lg text-gray-500",children:"目前無已接訂單"})})}):o?t.jsxs("div",{className:"text-center pt-20",children:["Error: ",n]}):t.jsx("div",{className:"flex flex-col text-center justify-between ",children:l.map((u,c)=>u.map((p,h)=>a==="MERCHANT"?t.jsx(g.Suspense,{fallback:t.jsx(ne,{}),children:t.jsx(ie,{order:p,pageId:c},h)},h):t.jsx(R,{order:p},h)))})}le.prototype={orderData:f.object};export{le as A,ne as O,_ as P,N as S,R as a,X as b,M as o,oe as u};
