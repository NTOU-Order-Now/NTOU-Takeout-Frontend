import{a as w,A as D,b as q,u as R,r as C,P as i,j as e,c as I,C as P}from"./index-NGzkvcc4.js";import{u as T}from"./useMutation--dmrRt6a.js";import{f as $}from"./faEllipsis-CxEkbWIP.js";import{F as j,f as H,a as z}from"./index-Basaqh1b.js";import{b as F}from"./blur-Dwm1PFOt.js";import{u as L}from"./useCategoryQueries-D0DcMVAD.js";import{u as O}from"./useSystemContext-Bg3dPr5V.js";import U from"./CartRemark-r91hryxr.js";import{U as g}from"./UserInfo-DFqPFUtS.js";const B=async(t,r,a)=>{try{const n=w.get("authToken");return(await D.patch(`/v1/cart/dishes/${t}`,r,{headers:{Authorization:`Bearer ${n}`},signal:a})).data}catch(n){if(q.isCancel(n)){console.debug("PATCH cart request cancelled");return}else throw console.error("PATCH cart error; ",n),n}},A=()=>{const t=R(),r=C.useRef(null),{mutateAsync:a,onError:n,onMutate:d,isError:u}=T({mutationFn:async({orderedDishId:o,newQuantity:c})=>{r.current&&(console.debug("Abort previous patchCart request"),r.current.abort());const s=new AbortController;r.current=s;const l={quantity:c.toString()},h=await B(o,l,r.current.signal);return r.current===s&&(r.current=null),h},onMutate:async({orderedDishId:o,newQuantity:c})=>{await t.cancelQueries(["cart"]);const s=t.getQueryData(["cart"]),l=s?{...s}:{orderedDishes:[]};return l.orderedDishes||(l.orderedDishes=[]),c===0?l.orderedDishes=l.orderedDishes.filter(h=>h.id!==o):l.orderedDishes=l.orderedDishes.map(h=>h.id===o?{...h,quantity:c}:h),t.setQueryData(["cart"],l),{previousCart:s}},onError:(o,c,s)=>{throw s!=null&&s.previousCart&&(console.debug("rollback to previous cart",s),t.setQueryData(["cart"],s.previousCart)),alert("更新數量失敗，請稍後再試"),o},onSettled:()=>{console.debug("patchCartAsync onSettled"),t.invalidateQueries(["cart"])}});return{patchCartAsync:a,patchCartError:n,patchCartOnMutate:d,ispatchCartError:u}},G=async(t,r)=>{try{const a=w.get("authToken");return(await D.patch("/v1/cart/send",t,{headers:{Authorization:`Bearer ${a}`},signal:r})).data}catch(a){if(q.isCancel(a))console.debug("PATCH cart request cancelled");else throw console.error("PATCH cart error; ",a),a}},J=()=>{const t=R(),r=C.useRef(null),{mutateAsync:a,isPending:n,isSuccess:d,error:u}=T({mutationFn:async o=>{r.current&&r.current.abort();const c=new AbortController;r.current=c;const s=await G(o,r.current.signal);return r.current===c&&(r.current=null),s},onMutate:async()=>{await t.cancelQueries(["cart"]);const o=t.getQueryData(["cart"]),c=o?{...o}:{orderedDishes:[]};return c.orderedDishes||(c.orderedDishes=[]),t.setQueryData(["cart"],c),{previousCart:o}},onError:(o,c,s)=>{throw s!=null&&s.previousCart&&t.setQueryData(["cart"],s.previousCart),alert("訂單送出失敗，請重整頁面後再試試"),o},onSettled:()=>{console.debug("useCartAddMutation onSettled"),t.invalidateQueries(["cart"])}});return{sendCartAsync:a,sendCartError:u,sendCartIsPending:n,sendCartIsSuccess:d}},S=({orderDetail:t})=>{const{totalSpend:r,estimateTime:a,cartData:n}=t,{ispatchCartError:d}=A(),u=d?"bg-gray-300":"bg-white",{sendCartAsync:o,sendCartIsPending:c}=J(),s=async l=>{l.preventDefault(),!(r===0||(n==null?void 0:n.orderedDishes.length)===0)&&(console.debug("sendCartHandler payload:",n),await o(n))};return e.jsxs("div",{className:" fixed bottom-0 w-full bg-orange-400 px-4 py-2 rounded-t-lg  text-white font-notoTC font-medium",children:[e.jsxs("div",{className:"flex justify-between mb-3 px-2 text-sm",children:[e.jsx("span",{children:"總金額"}),e.jsxs("span",{children:["$ ",r]})]}),n.orderedDishes.length>0&&e.jsxs("div",{className:"flex justify-between mb-3 px-2 text-sm",children:[e.jsx("span",{children:"預估完成時間"}),e.jsxs("span",{children:[a," ~ ",a+20," 分鐘"]})]}),e.jsx("button",{className:`w-full ${u} text-orange-500 py-2 px-2 rounded-full font-semibold `,disabled:d,onClick:s,children:c?e.jsx(j,{icon:$.faEllipsis,beatFade:!0,size:"lg",className:"mr-2"}):"送出訂單"})]})};S.propTypes={orderDetail:i.shape({cartData:i.object.isRequired,totalSpend:i.number.isRequired,estimateTime:i.number.isRequired}).isRequired};const N=()=>{const t=I(),r=()=>{t(-1)};return e.jsx("header",{className:"h-16 fixed z-30 top-0 left-0 w-full flex justify-between items-center bg-white shadow-md transition-shadow duration-300 ease-in-out p-2 font-notoTC",children:e.jsxs("div",{className:"flex ml-3 items-center text-xl ",children:[e.jsx(j,{icon:H,className:"mr-4 cursor-pointer text-2xl mt-1",onClick:r}),e.jsx("h1",{className:"font-noto font-bold text-2xl",children:"購物車"})]})})},E=({orderDetail:t})=>{const{cartData:r,merchantName:a,totalSpend:n}=t;return e.jsxs("div",{className:"mt-[66px] flex justify-between items-center p-4 bg-white",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-gray-900",children:r.orderedDishes.length?a:""}),e.jsx("p",{className:"text-sm text-gray-500",children:"訂單詳細資訊"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"總金額"}),e.jsxs("h2",{className:"text-2xl font-bold text-black",children:["$",n]})]})]})};E.propTypes={orderDetail:i.shape({cartData:i.object.isRequired,merchantName:i.string,totalSpend:i.number.isRequired}).isRequired};const Q=({dishData:t,imageUrl:r})=>{const{id:a,dishName:n,price:d,quantity:u,chosenAttributes:o,note:c}=t,[s,l]=C.useState(u),{patchCartAsync:h}=A(),y=async x=>{const p=s+x;if(!(p<0||p>25)){p>0&&l(p);try{await h({orderedDishId:a,newQuantity:p})}catch(b){console.debug("patchCartAsync error:",b),l(u)}}};let f=0;const m=o!=null&&o.length?o.map(x=>(f+=x.extraCost||0,x.chosenOption)).join(", "):"";return s<=0?null:e.jsxs("div",{className:"relative flex rounded-lg p-4 w-full items-start min-h-[142px]",children:[r&&e.jsx(F.LazyLoadImage,{src:r,alt:n,className:"w-20 h-26 object-cover rounded-lg flex-shrink-0",effect:"blur",wrapperClassName:"flex-shrink-0"}),e.jsxs("div",{className:"ml-4 flex min-w-0 flex-col h-full",children:[e.jsx("h2",{className:"text-lg font-semibold truncate",children:n}),m&&e.jsxs("p",{className:"text-sm text-gray-500 truncate",children:["+$",f," : ",m]}),c&&e.jsx("p",{className:"text-sm text-gray-500 line-clamp-2",children:c}),e.jsxs("p",{className:"text-xl mt-2 absolute bottom-[15px] font-semibold",children:["$ ",(d+f)*s]})]}),e.jsxs("div",{className:"absolute bottom-[15px] right-[15px] flex items-end border border-gray-300 rounded-md",children:[e.jsx("button",{onClick:()=>y(-1),className:"px-2 py-0 text-lg rounded-l-md w-7",children:u<=1?e.jsx(j,{icon:z,size:"xs",style:{color:"#d00b0b"}}):"-"}),e.jsx("span",{className:"px-4 py-0.5",children:s}),e.jsx("button",{onClick:()=>y(1),className:"px-2 py-0 text-lg rounded-r-md w-7",children:"+"})]})]})};Q.propTypes={dishData:i.shape({id:i.string.isRequired,dishId:i.string.isRequired,dishName:i.string.isRequired,price:i.number.isRequired,quantity:i.number.isRequired,chosenAttributes:i.arrayOf(i.shape({name:i.string})),note:i.string}).isRequired,imageUrl:i.string};const k=({cartData:t,dishesMap:r})=>!t.orderedDishes||t.orderedDishes.length===0?e.jsx("div",{className:"flex justify-center items-center mt-4 fa-2x",children:"目前購物車是空的:)"}):e.jsx("div",{children:t.orderedDishes.map((a,n)=>{var d;return e.jsx(Q,{dishData:a,imageUrl:(d=r[a==null?void 0:a.dishId])==null?void 0:d.picture},n)})});k.propTypes={cartData:i.object.isRequired,dishesMap:i.object.isRequired};const re=()=>{var x,p;const{cartData:t,isCartError:r,merchantData:a,isMerchantLoading:n,menuCategoryList:d,totalSpend:u,totalQuantity:o,refetchCart:c}=O();t===void 0&&(console.error("Cart not found, refetchCart"),c()),console.debug("Cart loaded merchantData:",a);const{categoryData:s,isQueriesSuccess:l}=L(d,((x=g)==null?void 0:x.role)==="CUSTOMER"?t==null?void 0:t.menuId:(p=g)==null?void 0:p.storeId,g!==void 0),[h,y]=C.useState(""),f=C.useMemo(()=>s?s.reduce((b,M)=>(M.dishes.forEach(v=>{b[v.id]=v}),b),{}):{},[s]);if(t===void 0)return e.jsx(P,{});let m=10*o;return m>150&&m<300?m=Math.floor(m*.7):m>=300&&(m=Math.floor(m*.5)),r?e.jsxs("div",{className:"flex justify-center items-center mt-28 fa-2x",children:[e.jsx(N,{}),"購物車資料讀取失敗:("]}):e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex-none",children:[e.jsx(N,{}),e.jsx(E,{orderDetail:{cartData:t,merchantName:a==null?void 0:a.name,totalSpend:u}})]}),e.jsxs("div",{className:"flex-1 overflow-auto pb-[120px] ",children:[e.jsx(k,{cartData:t,dishesMap:f}),e.jsx("div",{className:"px-4",children:e.jsx(U,{onRemarkChange:y})})]}),e.jsx("div",{className:"flex-none",children:e.jsx(S,{orderDetail:{cartData:t,totalSpend:u,estimateTime:m-(o>2?30:0)}})})]})};export{re as default};
