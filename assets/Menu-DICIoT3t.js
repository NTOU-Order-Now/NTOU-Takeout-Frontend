const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MenuNavbar-CV8q9faP.js","assets/index-CZV2z4L2.js","assets/index-DH9S0eys.css","assets/merchantMenuNav-cxqkOOhN.js","assets/MenuSection-D7GNz6bj.js","assets/useMutation-CzB-mLXn.js"])))=>i.map(i=>d[i]);
import{P as l,j as e,r as h,e as W,a as E,A as P,b as G,u as A,_ as T,c as X,M as J}from"./index-CZV2z4L2.js";import{F as j,u as Y,v as _,w as Z,x as ee,y as M,k as te}from"./index-wPuIc0We.js";import{u as q}from"./sidebarStore-mfOTrqn7.js";import{H as $}from"./Header-GQ3LpFEU.js";import se from"./NavbarSkeleton-kvotX8tk.js";import ne from"./MenuSectionSkeleton-VHOpJ6On.js";import{u as re}from"./useCategoryQueries-C24iVXcW.js";import{u as oe}from"./merchantMenuNav-cxqkOOhN.js";import{u as Q}from"./useMutation-CzB-mLXn.js";import{u as ae}from"./useSystemContext-CREwBBG8.js";const V=({dishName:o,onSave:r,onBack:a})=>{const t=e.jsx("button",{onClick:r,className:"bg-orange-400 text-white px-4 py-1 rounded-lg font-bold hover:bg-orange-600",children:"保存"});return e.jsx($,{LeftIcon:e.jsx(j,{icon:Y}),title:o,onLeftClick:a,rightComponents:[t]})};V.propTypes={dishName:l.string.isRequired,onSave:l.func,onBack:l.func};const U=({defaultName:o,defaultDescription:r,defaultPrice:a,defaultCategory:t,categoryNames:u=[],onImageUpload:d,onNameChange:n,onDescriptionChange:s,onPriceChange:i,onCategoryChange:m})=>e.jsxs("div",{className:"mt-10 p-6 bg-white",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"名稱："}),e.jsx("input",{type:"text",defaultValue:o,placeholder:"請輸入名稱",className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:c=>n(c.target.value)})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"商品描述："}),e.jsx("textarea",{defaultValue:r,placeholder:"請輸入商品描述",className:"w-full h-24 px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:c=>s(c.target.value)})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"圖片："}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"text",placeholder:"請選擇圖片",readOnly:!0,className:"flex-1 px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none mr-2"}),e.jsx("button",{onClick:d,className:"flex-shrink-0 bg-orange-400 text-white px-6 py-2 rounded-md hover:bg-orange-600",children:"上傳圖片"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"價格："}),e.jsx("input",{type:"number",defaultValue:a,placeholder:"請輸入價格",className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:c=>i(Number(c.target.value))})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"類別："}),e.jsx("input",{type:"text",defaultValue:t,placeholder:"請輸入類別",list:"category-options",className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:c=>m(c.target.value)}),e.jsx("datalist",{id:"category-options",children:u.map((c,f)=>e.jsx("option",{value:c},f))})]})]});U.propTypes={defaultName:l.string,defaultDescription:l.string,defaultPrice:l.oneOfType([l.string,l.number]),defaultCategory:l.string,onImageUpload:l.func,categoryNames:l.arrayOf(l.string),onNameChange:l.func.isRequired,onDescriptionChange:l.func.isRequired,onPriceChange:l.func.isRequired,onCategoryChange:l.func.isRequired};const B=({option:o,onDelete:r,onUpdate:a})=>{const[t,u]=h.useState(!1),[d,n]=h.useState(!1),s=h.useRef(null);h.useEffect(()=>{s.current&&(t||d)&&s.current.focus()},[t,d]);const i=c=>{const f=c.target.value;c.type==="keydown"&&c.key!=="Enter"||(u(!1),a({name:f}))},m=c=>{const f=c.target.value;c.type==="keydown"&&c.key!=="Enter"||(n(!1),a({extraCost:parseFloat(f)||0}))};return e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[t?e.jsx("input",{ref:s,type:"text",defaultValue:o.name,onBlur:i,onKeyDown:i,className:"border rounded px-2 py-1 text-lg focus:ring-orange-400"}):e.jsx("span",{onClick:()=>u(!0),className:"cursor-pointer hover:underline text-xl",children:o.name}),d?e.jsx("input",{ref:s,type:"number",defaultValue:o.extraCost,onBlur:m,onKeyDown:m,className:"border rounded px-2 py-1 text-sm focus:ring-orange-400"}):e.jsxs("span",{onClick:()=>n(!0),className:"px-3 border rounded-xl text-black border-black cursor-pointer hover:underline",children:["+ ",o.extraCost,"元"]})]}),e.jsx("button",{className:"text-red-400 hover:text-red-700",onClick:r,children:e.jsx(j,{icon:_})})]})};B.propTypes={option:l.shape({name:l.string.isRequired,extraCost:l.number.isRequired}).isRequired,onDelete:l.func.isRequired,onUpdate:l.func.isRequired};function F({options:o,selectedOption:r,onChange:a}){const t=Object.keys(o),u=t.findIndex(n=>n===r),d=100/t.length;return e.jsx("div",{className:"relative  h-full  w-full",children:e.jsxs("div",{className:"relative border-gray-200 border-2 h-full flex overflow-hidden rounded-xl",children:[e.jsx("div",{className:"absolute h-full bg-orange-500 transition-transform duration-300 ease-in-out rounded-xl",style:{width:`${d}%`,transform:`translateX(${u*100}%)`}}),t.map(n=>{const s=n===r;return e.jsx("button",{onClick:()=>a(n),className:`
                                relative flex-1 text-center text-sm font-bold 
                                transition-colors duration-300 ease-in-out z-10
                                ${s?"text-white":"text-black"}
                            `,children:n},n)})]})})}F.propTypes={options:l.object.isRequired,selectedOption:l.string.isRequired,onChange:l.func.isRequired};const z=({group:o,groupIndex:r,onUpdateGroup:a,onDeleteGroup:t})=>{const[u,d]=h.useState(!1),[n,s]=h.useState(o.name),[i,m]=h.useState(o.isRequired),[c,f]=h.useState(o.type),[b,y]=h.useState(o.attributeOptions||[]),D=()=>{d(!1),x()},C=()=>{const g={name:"新選項",extraCost:0,isChosen:!1},p=[...b,g];y(p),x({attributeOptions:p})},S=g=>{const p=b.filter((v,I)=>I!==g);y(p),x({attributeOptions:p})},k=(g,p)=>{const v=b.map((I,H)=>H===g?{...I,...p}:I);y(v),x({attributeOptions:v})},x=g=>{const p={...o,name:n,isRequired:i,type:c,attributeOptions:b,...g};a(p)},w={單選:()=>{f("single"),x({type:"single"})},複選:()=>{f("multiple"),x({type:"multiple"})}},N=c==="single"?"單選":"複選",R=()=>{const g=!i;m(g),x({isRequired:g})};return e.jsxs("div",{className:"p-4 bg-white border rounded-lg shadow-md mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[u?e.jsx("input",{type:"text",value:n,onChange:g=>s(g.target.value),onKeyDown:g=>{g.key==="Enter"&&D()},className:"border rounded px-2 py-1 text-lg font-bold focus:ring-orange-500 focus:outline-none"}):e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:"font-bold text-xl",children:n}),e.jsx("span",{className:`px-2 py-1 rounded-lg text-white text-sm cursor-pointer ${i?"bg-red-500":"bg-gray-500"}`,onClick:R,children:"必選"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{className:"text-orange-500 hover:text-orange-700 text-xl",onClick:()=>{u?D():d(!0)},children:e.jsx(j,{icon:u?Z:ee})}),e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:t,children:e.jsx(j,{icon:_})})]})]}),b.map((g,p)=>e.jsx(B,{option:g,onDelete:()=>S(p),onUpdate:v=>k(p,v)},p)),e.jsx("button",{className:"text-orange-500 mt-2 text-lg",onClick:C,children:"新增選項..."}),e.jsx("div",{className:"flex justify-end space-x-4 mt-4",children:e.jsx("div",{className:"flex w-[120px] h-10 overflow-hidden",children:e.jsx(F,{options:w,selectedOption:N,onChange:g=>{w[g]()}})})})]})};z.propTypes={group:l.object.isRequired,groupIndex:l.number.isRequired,onUpdateGroup:l.func.isRequired,onDeleteGroup:l.func.isRequired};const L=({groups:o,onGroupsChange:r})=>{const a=d=>{const n=o.filter((s,i)=>i!==d);r(n)},t=(d,n)=>{const s=o.map((i,m)=>m===d?n:i);r(s)},u=()=>{const d={name:"新選項標題",description:"",type:"single",isRequired:!1,attributeOptions:[]};r([...o,d])};return e.jsxs("div",{className:"p-4 bg-white mt-4",children:[o.map((d,n)=>e.jsx(z,{groupIndex:n,group:d,onUpdateGroup:s=>t(n,s),onDeleteGroup:()=>a(n)},n)),e.jsx("div",{className:"flex justify-center mt-6 z-50",children:e.jsxs("button",{className:"text-orange-500 hover:text-orange-700 flex items-center",onClick:u,children:[e.jsx(j,{icon:M,size:"lg",className:"mr-2"}),"新增客製化選項"]})})]})};L.propTypes={groups:l.array.isRequired,onGroupsChange:l.func.isRequired};const O=W(o=>({selectedDish:null,setSelectedDish:r=>o({selectedDish:r})})),ie=async({menuId:o,id:r,name:a,description:t,picture:u,price:d,category:n,dishAttributes:s},i)=>{if(a===""||d===null||n===""||t==="")throw new Error("content can't be empty");try{const m=E.get("authToken");return(await P.put(`/v2/menu/${o}/dish/${r}`,{name:a,description:t,picture:u,price:d,category:n,dishAttributes:s},{signal:i,headers:{Authorization:`Bearer ${m}`}})).data}catch(m){if(G.isCancel(m)){console.debug("Update dish request cancelled");return}throw console.error(`Failed to update dish (ID: ${r}) in menu (ID: ${o}):`,m),m}},le=o=>{const r=A(),a=h.useRef(null),{mutateAsync:t,isError:u,isPending:d}=Q({mutationFn:async n=>{a.current&&a.current.abort();const s=new AbortController;return a.current=s,await ie({menuId:o,...n},s.signal),a.current===s&&(a.current=null),n.category},onMutate:async n=>{const{category:s,id:i}=n;await r.cancelQueries(["categoryDishes",s]);const m=r.getQueryData(["categoryDishes",s]);return r.setQueryData(["categoryDishes",s],{categoryName:s,dishes:m.dishes.map(c=>c.id===i?t:c)}),{previousDishes:m,category:s}},onError:(n,s,i)=>{console.debug("error",s,i),i!=null&&i.previousDishes&&r.setQueryData(["categoryDishes",i.category],i.previousDishes),alert("更新錯誤，請確保所有欄位都不為空"),console.error("Update dish error:",n)},onSettled:n=>{r.invalidateQueries(["categoryDishes",n])}});return{updateDish:t,isError:u,isPending:d}};function K({onClose:o,categoryNames:r,menuId:a}){const t=O(N=>N.selectedDish),[u,d]=h.useState(t.name),[n,s]=h.useState(t.description),[i,m]=h.useState(t.price),[c,f]=h.useState(t.category),[b,y]=h.useState(t.dishAttributes),{updateDish:D,isPending:C}=le(a),S=async()=>{const R={id:t.id,name:u,description:n,picture:"https://images.pexels.com/photos/1199957/pexels-photo-1199957.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",price:i,category:c,dishAttributes:b};try{await D(R),o()}catch(g){console.error("更新失敗：",g)}},k=()=>{o()},x=()=>{console.log("Image upload")},w=N=>{y(N)};return e.jsxs("div",{children:[e.jsx(V,{dishName:u,onBack:k,onSave:S,isPending:C}),e.jsx(U,{defaultName:u,defaultDescription:n,defaultPrice:i,defaultCategory:c,categoryNames:r,onImageUpload:x,onNameChange:d,onDescriptionChange:s,onPriceChange:m,onCategoryChange:f}),e.jsx(L,{groups:b,onGroupsChange:w})]})}K.propTypes={onClose:l.func.isRequired,categoryNames:l.arrayOf(l.string),menuId:l.string.isRequired};const ce=async(o,r)=>{const a=E.get("authToken");try{return(await P.get(`/v2/menu/${o}/dish/create`,{signal:r,headers:{Authorization:`Bearer ${a}`}})).data}catch(t){if(G.isCancel(t)){console.debug("Get new dish ID request cancelled");return}throw console.error(`Failed to get new dish ID for menu (ID: ${o}):`,t),t}},ue=o=>{const r=A(),a=h.useRef(null),t="",{mutateAsync:u,isError:d,isPending:n}=Q({mutationFn:async()=>{a.current&&a.current.abort();const s=new AbortController;a.current=s;const i=await ce(o,s.signal);return a.current===s&&(a.current=null),i},onMutate:async()=>{await r.cancelQueries(["categoryDishes",t]);const s=r==null?void 0:r.getQueryData(["categoryDishes",t]),i={id:`temp-${Date.now()}`,name:"",description:"",picture:"",price:null,category:t,salesVolume:0,dishAttributes:[]};return r.setQueryData(["categoryDishes",t],{categoryName:"",dishes:s?[s.dishes,i]:[i]}),{previousDishes:s}},onError:(s,i,m)=>{m!=null&&m.previousDishes?r.setQueryData(["categoryDishes",t],m.previousDishes):r.setQueryData(["categoryDishes",t],[]),alert("創建失敗，請重整頁面再試一次"),console.error("Create new dish error:",s)},onSettled:()=>{console.debug("onSettled"),r.invalidateQueries(["menuCategoryList",o]),r.invalidateQueries(["categoryDishes"],t)}});return{createDish:u,isError:d,isPending:n}},de=h.lazy(()=>T(()=>import("./MenuNavbar-CV8q9faP.js"),__vite__mapDeps([0,1,2,3]))),pe=h.lazy(()=>T(()=>import("./MenuSection-D7GNz6bj.js"),__vite__mapDeps([4,1,2,5]))),me=()=>{const o=q(p=>p.toggleSidebar),r=q(p=>p.title),{userInfo:a,merchantData:t,menuCategoryList:u}=ae(),d=a==null?void 0:a.id,n=a==null?void 0:a.storeId,s=t==null?void 0:t.menuId,{categoryData:i}=re(u,t==null?void 0:t.menuId,a!==void 0),m=X(),c=h.useRef([]),[f,b]=h.useState(!1),y=oe(p=>p.setNavbarItems),{createDish:D,isPending:C}=ue(s),S=p=>{var v;(v=c.current[p])==null||v.scrollIntoView({behavior:"smooth",inline:"start"})},k=O(p=>p.selectedDish),x=O(p=>p.setSelectedDish);if(h.useEffect(()=>{y(u==null?void 0:u.map(p=>p.categoryName))},[u,y]),d&&!t)return e.jsx(J,{});const w=async()=>{await D(s)},N=e.jsx("button",{onClick:w,className:"bg-orange-500 text-white rounded-lg p-2 flex  shadow-md content-center w-full h-full",children:C?e.jsx(j,{icon:te,spinPulse:!0,style:{color:"#ffffff"},size:"xs"}):e.jsx(j,{icon:M})}),R=e.jsx("button",{onClick:()=>{m(`/menu/${n}`)},className:" bg-slate-400 text-white rounded-lg px-3 py-1 font-sm shadow-md",children:"預覽"}),g=u.map(p=>p.categoryName);return k?e.jsx(K,{onClose:()=>{x(null)},categoryNames:g,menuId:s}):e.jsxs("div",{className:"flex flex-col h-screen",children:[e.jsx($,{title:r,onLeftClick:o,rightComponents:[N,R]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"sticky top-[54px] mt-[54px] z-20 shadow-sm",children:e.jsx(h.Suspense,{fallback:e.jsx(se,{isNavbarFixed:!1}),children:e.jsx(de,{onNavClick:S,isNavbarFixed:f})})}),e.jsx("div",{className:"overflow-auto h-[dvh-34px]  ",children:e.jsx(h.Suspense,{fallback:e.jsx(ne,{}),children:e.jsx(pe,{menuId:s,sectionRefs:c,categoryData:i})})})]})]})},we=Object.freeze(Object.defineProperty({__proto__:null,default:me},Symbol.toStringTag,{value:"Module"}));export{we as M,O as u};
