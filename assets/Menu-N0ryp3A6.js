const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MenuNavbar-BxKpZsNw.js","assets/index-iUSX4OFq.js","assets/index-BO7FN990.css","assets/merchantMenuNav-DGOpln-A.js","assets/MenuSection-C2M5NPZD.js","assets/useMutation-aCDA98f0.js"])))=>i.map(i=>d[i]);
import{P as i,j as e,r as g,g as X,a as O,A as P,b as G,u as A,_ as T,c as J,d as Y,M as Z}from"./index-iUSX4OFq.js";import{F as v,m as ee,d as _,n as se,o as F,p as te,q as ne,r as M}from"./index-DE8yvV3K.js";import{u as E}from"./sidebarStore-CG_XgNQB.js";import{H as $}from"./Header-B-2Kh8NZ.js";import re from"./NavbarSkeleton-DudmCrBB.js";import ae from"./MenuSectionSkeleton-DqLmwJKt.js";import{u as oe}from"./useCategoryQueries-BzNI2KA7.js";import{u as ie}from"./merchantMenuNav-DGOpln-A.js";import{f as le}from"./faEllipsis-CxEkbWIP.js";import{u as ce}from"./useImageUploadMutation-D-a1eWQj.js";import{u as U}from"./useMutation-aCDA98f0.js";const Q=({dishName:a,onSave:r,onBack:o,isPending:s})=>{const c=e.jsx("button",{onClick:r,className:"bg-orange-400 text-white px-4 py-1 rounded-lg font-bold hover:bg-orange-600",children:s?e.jsx(v,{icon:le.faEllipsis,beatFade:!0,size:"lg",className:"mr-2"}):"保存"});return e.jsx($,{LeftIcon:e.jsx(v,{icon:ee}),title:a,onLeftClick:o,rightComponents:[c]})};Q.propTypes={dishName:i.string.isRequired,onSave:i.func,onBack:i.func,isPending:i.bool};const V=({defaultName:a,defaultDescription:r,defaultPrice:o,defaultCategory:s,defaultImage:c,categoryNames:u=[],onNameChange:n,onDescriptionChange:t,onPriceChange:l,onCategoryChange:m,onImageChange:h})=>{const{uploadImage:b,isPending:x,isError:D}=ce(),w=async f=>{const y=f.target.files[0];if(y)try{h({url:null}),console.debug("file:",y);const C=await b(y);h({url:C})}catch(C){console.error("upload Failed:",C),h({url:null})}};return e.jsxs("div",{className:"mt-10 p-6 bg-white",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"名稱："}),e.jsx("input",{type:"text",defaultValue:a,placeholder:"請輸入名稱",className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:f=>n(f.target.value)})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"商品描述："}),e.jsx("textarea",{defaultValue:r,placeholder:"請輸入商品描述",className:"w-full h-24 px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:f=>t(f.target.value)})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"圖片："}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"flex-1 relative",children:e.jsx("input",{type:"text",value:c||"",placeholder:"請選擇圖片",readOnly:!0,className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none"})}),e.jsx("label",{htmlFor:"dish-image-upload",className:`
                            flex-shrink-0 px-6 py-2 rounded-md
                            ${x?"bg-gray-400 cursor-not-allowed":"bg-orange-400 hover:bg-orange-600 cursor-pointer"}
                            text-white transition-colors duration-200
                        `,children:x?e.jsxs(e.Fragment,{children:[e.jsx(v,{icon:_,className:"mr-2 animate-spin"}),"上傳中"]}):e.jsxs(e.Fragment,{children:[e.jsx(v,{icon:se,className:"mr-2"}),"上傳圖片"]})}),e.jsx("input",{id:"dish-image-upload",type:"file",className:"hidden",onChange:w,accept:"image/*",disabled:x})]}),c&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:c,alt:"商品圖片",className:"w-32 h-32 object-cover rounded-lg shadow-md"})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"價格："}),e.jsx("input",{type:"number",defaultValue:o,placeholder:"請輸入價格",className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:f=>l(Number(f.target.value))})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold mb-2",children:"類別："}),e.jsx("input",{type:"text",defaultValue:s,placeholder:"請輸入類別",list:"category-options",className:"w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500",onChange:f=>m(f.target.value)}),e.jsx("datalist",{id:"category-options",children:u.map((f,y)=>e.jsx("option",{value:f},y))})]})]})};V.propTypes={defaultName:i.string,defaultDescription:i.string,defaultPrice:i.oneOfType([i.string,i.number]),defaultImage:i.string,defaultCategory:i.string,onImageUpload:i.func,categoryNames:i.arrayOf(i.string),onNameChange:i.func.isRequired,onDescriptionChange:i.func.isRequired,onPriceChange:i.func.isRequired,onCategoryChange:i.func.isRequired,onImageChange:i.func.isRequired};const z=({option:a,onDelete:r,onUpdate:o})=>{const[s,c]=g.useState(!1),[u,n]=g.useState(!1),t=g.useRef(null);g.useEffect(()=>{t.current&&(s||u)&&t.current.focus()},[s,u]);const l=h=>{const b=h.target.value;h.type==="keydown"&&h.key!=="Enter"||(c(!1),o({name:b}))},m=h=>{const b=h.target.value;h.type==="keydown"&&h.key!=="Enter"||(n(!1),o({extraCost:parseFloat(b)||0}))};return e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[s?e.jsx("input",{ref:t,type:"text",defaultValue:a.name,onBlur:l,onKeyDown:l,className:"border rounded px-2 py-1 text-lg focus:ring-orange-400"}):e.jsx("span",{onClick:()=>c(!0),className:"cursor-pointer hover:underline text-xl",children:a.name}),u?e.jsx("input",{ref:t,type:"number",defaultValue:a.extraCost,onBlur:m,onKeyDown:m,className:"border rounded px-2 py-1 text-sm focus:ring-orange-400"}):e.jsxs("span",{onClick:()=>n(!0),className:"px-3 border rounded-xl text-black border-black cursor-pointer hover:underline",children:["+ ",a.extraCost,"元"]})]}),e.jsx("button",{className:"text-red-400 hover:text-red-700",onClick:r,children:e.jsx(v,{icon:F})})]})};z.propTypes={option:i.shape({name:i.string.isRequired,extraCost:i.number.isRequired}).isRequired,onDelete:i.func.isRequired,onUpdate:i.func.isRequired};function B({options:a,selectedOption:r,onChange:o}){const s=Object.keys(a),c=s.findIndex(n=>n===r),u=100/s.length;return e.jsx("div",{className:"relative  h-full  w-full",children:e.jsxs("div",{className:"relative border-gray-200 border-2 h-full flex overflow-hidden rounded-xl",children:[e.jsx("div",{className:"absolute h-full bg-orange-500 transition-transform duration-300 ease-in-out rounded-xl",style:{width:`${u}%`,transform:`translateX(${c*100}%)`}}),s.map(n=>{const t=n===r;return e.jsx("button",{onClick:()=>o(n),className:`
                                relative flex-1 text-center text-sm font-bold 
                                transition-colors duration-300 ease-in-out z-10
                                ${t?"text-white":"text-black"}
                            `,children:n},n)})]})})}B.propTypes={options:i.object.isRequired,selectedOption:i.string.isRequired,onChange:i.func.isRequired};const L=({group:a,groupIndex:r,onUpdateGroup:o,onDeleteGroup:s})=>{const[c,u]=g.useState(!1),[n,t]=g.useState(a.name),[l,m]=g.useState(a.isRequired),[h,b]=g.useState(a.type),[x,D]=g.useState(a.attributeOptions||[]),w=()=>{u(!1),N()},f=()=>{const p={name:"新選項",extraCost:0,isChosen:!1},d=[...x,p];D(d),N({attributeOptions:d})},y=p=>{const d=x.filter((j,I)=>I!==p);D(d),N({attributeOptions:d})},C=(p,d)=>{const j=x.map((I,W)=>W===p?{...I,...d}:I);D(j),N({attributeOptions:j})},N=p=>{const d={...a,name:n,isRequired:l,type:h,attributeOptions:x,...p};o(d)},S={單選:()=>{b("single"),N({type:"single"})},複選:()=>{b("multiple"),N({type:"multiple"})}},k=h==="single"?"單選":"複選",R=()=>{const p=!l;m(p),N({isRequired:p})};return e.jsxs("div",{className:"p-4 bg-white border rounded-lg shadow-md mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[c?e.jsx("input",{type:"text",value:n,onChange:p=>t(p.target.value),onKeyDown:p=>{p.key==="Enter"&&w()},className:"border rounded px-2 py-1 text-lg font-bold focus:ring-orange-500 focus:outline-none"}):e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:"font-bold text-xl",children:n}),e.jsx("span",{className:`px-2 py-1 rounded-lg text-white text-sm cursor-pointer ${l?"bg-red-500":"bg-gray-500"}`,onClick:R,children:"必選"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{className:"text-orange-500 hover:text-orange-700 text-xl",onClick:()=>{c?w():u(!0)},children:e.jsx(v,{icon:c?te:ne})}),e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:s,children:e.jsx(v,{icon:F})})]})]}),x.map((p,d)=>e.jsx(z,{option:p,onDelete:()=>y(d),onUpdate:j=>C(d,j)},d)),e.jsx("button",{className:"text-orange-500 mt-2 text-lg",onClick:f,children:"新增選項..."}),e.jsx("div",{className:"flex justify-end space-x-4 mt-4",children:e.jsx("div",{className:"flex w-[120px] h-10 overflow-hidden",children:e.jsx(B,{options:S,selectedOption:k,onChange:p=>{S[p]()}})})})]})};L.propTypes={group:i.object.isRequired,groupIndex:i.number.isRequired,onUpdateGroup:i.func.isRequired,onDeleteGroup:i.func.isRequired};const K=({groups:a,onGroupsChange:r})=>{const o=u=>{const n=a.filter((t,l)=>l!==u);r(n)},s=(u,n)=>{const t=a.map((l,m)=>m===u?n:l);r(t)},c=()=>{const u={name:"新選項標題",description:"",type:"single",isRequired:!1,attributeOptions:[]};r([...a,u])};return e.jsxs("div",{className:"p-4 bg-white mt-4",children:[a.map((u,n)=>e.jsx(L,{groupIndex:n,group:u,onUpdateGroup:t=>s(n,t),onDeleteGroup:()=>o(n)},n)),e.jsx("div",{className:"flex justify-center mt-6 z-50",children:e.jsxs("button",{className:"text-orange-500 hover:text-orange-700 flex items-center",onClick:c,children:[e.jsx(v,{icon:M,size:"lg",className:"mr-2"}),"新增客製化選項"]})})]})};K.propTypes={groups:i.array.isRequired,onGroupsChange:i.func.isRequired};const q=X(a=>({selectedDish:null,setSelectedDish:r=>a({selectedDish:r})})),de=async({menuId:a,id:r,name:o,description:s,picture:c,price:u,category:n,dishAttributes:t},l)=>{if(o===""||u===null||n===""||s==="")throw new Error("content can't be empty");try{const m=O.get("authToken");return(await P.put(`/v2/menu/${a}/dish/${r}`,{name:o,description:s,picture:c,price:u,category:n,dishAttributes:t},{signal:l,headers:{Authorization:`Bearer ${m}`}})).data}catch(m){if(G.isCancel(m)){console.debug("Update dish request cancelled");return}throw console.error(`Failed to update dish (ID: ${r}) in menu (ID: ${a}):`,m),m}},ue=a=>{const r=A(),o=g.useRef(null),{mutateAsync:s,isError:c,isPending:u}=U({mutationFn:async n=>{o.current&&o.current.abort();const t=new AbortController;return o.current=t,await de({menuId:a,...n},t.signal),o.current===t&&(o.current=null),n.category},onMutate:async n=>{const{category:t,id:l}=n;await r.cancelQueries(["categoryDishes",t]);const m=r.getQueryData(["categoryDishes",t]);return r.setQueryData(["categoryDishes",t],{categoryName:t,dishes:m.dishes.map(h=>h.id===l?s:h)}),{previousDishes:m,category:t}},onError:(n,t,l)=>{console.debug("error",t,l),l!=null&&l.previousDishes&&r.setQueryData(["categoryDishes",l.category],l.previousDishes),alert("更新錯誤，請確保所有欄位都不為空"),console.error("Update dish error:",n)},onSettled:n=>{r.invalidateQueries(["categoryDishes",n])}});return{updateDish:s,isError:c,isPending:u}};function H({onClose:a,categoryNames:r,menuId:o}){const s=q(p=>p.selectedDish),[c,u]=g.useState(s.name),[n,t]=g.useState(s.description),[l,m]=g.useState(s.price),[h,b]=g.useState(s.category),[x,D]=g.useState(s.dishAttributes),[w,f]=g.useState(s.picture),y=({url:p})=>{p&&f(p)},{updateDish:C,isPending:N}=ue(o),S=async()=>{const p=w,d={id:s.id,name:c,description:n,picture:p,price:l,category:h,dishAttributes:x};try{await C(d),a()}catch(j){console.error("更新失敗：",j)}},k=()=>{a()},R=p=>{D(p)};return e.jsxs("div",{children:[e.jsx(Q,{dishName:c,onBack:k,onSave:S,isPending:N}),e.jsx(V,{defaultName:c,defaultDescription:n,defaultPrice:l,defaultImage:w,defaultCategory:h,categoryNames:r,onNameChange:u,onDescriptionChange:t,onPriceChange:m,onCategoryChange:b,onImageChange:y}),e.jsx(K,{groups:x,onGroupsChange:R})]})}H.propTypes={onClose:i.func.isRequired,categoryNames:i.arrayOf(i.string),menuId:i.string.isRequired};const pe=async(a,r)=>{const o=O.get("authToken");try{return(await P.get(`/v2/menu/${a}/dish/create`,{signal:r,headers:{Authorization:`Bearer ${o}`}})).data}catch(s){if(G.isCancel(s)){console.debug("Get new dish ID request cancelled");return}throw console.error(`Failed to get new dish ID for menu (ID: ${a}):`,s),s}},me=a=>{const r=A(),o=g.useRef(null),s="",{mutateAsync:c,isError:u,isPending:n}=U({mutationFn:async()=>{o.current&&o.current.abort();const t=new AbortController;o.current=t;const l=await pe(a,t.signal);return o.current===t&&(o.current=null),l},onMutate:async()=>{await r.cancelQueries(["categoryDishes",s]);const t=r==null?void 0:r.getQueryData(["categoryDishes",s]),l={id:`temp-${Date.now()}`,name:"",description:"",picture:"",price:null,category:s,salesVolume:0,dishAttributes:[]};return r.setQueryData(["categoryDishes",s],{categoryName:"",dishes:t?[t.dishes,l]:[l]}),{previousDishes:t}},onError:(t,l,m)=>{m!=null&&m.previousDishes?r.setQueryData(["categoryDishes",s],m.previousDishes):r.setQueryData(["categoryDishes",s],[]),alert("創建失敗，請重整頁面再試一次"),console.error("Create new dish error:",t)},onSettled:()=>{r.invalidateQueries(["menuCategoryList",a]),r.invalidateQueries(["categoryDishes"],s)}});return{createDish:c,isError:u,isPending:n}},he=g.lazy(()=>T(()=>import("./MenuNavbar-BxKpZsNw.js"),__vite__mapDeps([0,1,2,3]))),ge=g.lazy(()=>T(()=>import("./MenuSection-C2M5NPZD.js"),__vite__mapDeps([4,1,2,5]))),fe=()=>{const a=E(d=>d.toggleSidebar),r=E(d=>d.title),{userInfo:o,merchantData:s,menuCategoryList:c}=J(),u=o==null?void 0:o.id,n=o==null?void 0:o.storeId,t=s==null?void 0:s[0].menuId,{categoryData:l}=oe(c,s==null?void 0:s[0].menuId,o!==void 0),m=Y(),h=g.useRef([]),[b,x]=g.useState(!1),D=ie(d=>d.setNavbarItems),{createDish:w,isPending:f}=me(t),y=d=>{var j;(j=h.current[d])==null||j.scrollIntoView({behavior:"smooth",inline:"start"})},C=q(d=>d.selectedDish),N=q(d=>d.setSelectedDish);if(g.useEffect(()=>{D(c==null?void 0:c.map(d=>d.categoryName))},[c,D]),u&&!s)return e.jsx(Z,{});const S=async()=>{await w(t)},k=e.jsx("button",{onClick:S,className:"bg-orange-500 text-white rounded-lg p-2 flex  shadow-md content-center w-full h-full",children:f?e.jsx(v,{icon:_,spinPulse:!0,style:{color:"#ffffff"},size:"xs"}):e.jsx(v,{icon:M})}),R=e.jsx("button",{onClick:()=>{m(`/menu/${n}`)},className:" bg-slate-400 text-white rounded-lg px-3 py-1 font-sm shadow-md",children:"預覽"}),p=c.map(d=>d.categoryName);return C?e.jsx(H,{onClose:()=>{N(null)},categoryNames:p,menuId:t}):e.jsxs("div",{className:"flex flex-col h-screen",children:[e.jsx($,{title:r,onLeftClick:a,rightComponents:[k,R]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"sticky top-[54px] mt-[54px] z-20 shadow-sm",children:e.jsx(g.Suspense,{fallback:e.jsx(re,{isNavbarFixed:!1}),children:e.jsx(he,{onNavClick:y,isNavbarFixed:b})})}),e.jsx("div",{className:"overflow-auto h-[dvh-34px]  ",children:e.jsx(g.Suspense,{fallback:e.jsx(ae,{}),children:e.jsx(ge,{menuId:t,sectionRefs:h,categoryData:l})})})]})]})},Re=Object.freeze(Object.defineProperty({__proto__:null,default:fe},Symbol.toStringTag,{value:"Module"}));export{Re as M,q as u};
